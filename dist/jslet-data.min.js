/*!
 * Jslet Javascript Framework v4.0.0
 * https://github.com/jslet/jslet/
 *
 * Copyright 2016 Jslet Team and other contributors
 * Released under the MIT license
 */
 
"use strict";!function(e,t){"function"==typeof define?define.amd?define("jslet-data",["jslet-locale","jquery"],t):define(function(require,e,a){var r=require("jslet-locale"),l=require("jquery");a.exports=t(r,l)}):(t(window.jsletlocale,window.jQuery),delete window.jsletlocale)}(this,function(locale,jQuery){if(void 0!==window.jslet&&void 0!==jslet||(window.jslet=function(e){var t=jQuery(e)[0];return t&&t.jslet?t.jslet:null}),jslet.locale=locale,void 0!==window.jslet&&void 0!==jslet||(window.jslet=function(e){var t=jQuery(e)[0];return t&&t.jslet?t.jslet:null}),!jslet.rootUri){var ohead=window.document.getElementsByTagName("head")[0],uri=ohead.lastChild.src;uri&&(uri=uri.substring(0,uri.lastIndexOf("/")+1),jslet.rootUri=uri)}return jslet.global={version:"3.0.0",changeStateField:"rs",selectStateField:"_sel_",auditLogField:"al",valueSeparator:",",defaultRecordClass:null,defaultFocusKeyCode:9,defaultCharWidth:12,debugMode:!0},jslet.global.serverErrorHandler=function(e,t){return!1},jslet.global.beforeSubmit=function(e){return e},jslet.global.afterInstall=function(e){},jslet.toArray=function(e){if(!e)return[];if("toArray"in Object(e))return e.toArray();for(var t=e.length||0,a=new Array(t);t--;)a[t]=e[t];return a},jslet.extend=function(e,t){for(var a in t)e[a]=t[a];return e},jslet.emptyFunction=function(){},jslet.keys=function(e){var t=[];if("object"!=typeof e)return t;for(var a in e)e.hasOwnProperty(a)&&t.push(a);return t},jslet.extend(Function.prototype,function(){function e(e,t){for(var a=e.length,r=t.length;r--;)e[a+r]=t[r];return e}function t(t,a){return t=u.call(t,0),e(t,a)}function a(){var e=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return 1!=e.length||e[0]?e:[]}function r(e){if(arguments.length<2&&"undefined"==typeof arguments[0])return this;var a=this,r=u.call(arguments,1);return function(){var l=t(r,arguments);return a.apply(e,l)}}function l(t){var a=this,r=u.call(arguments,1);return function(l){var i=e([l||window.event],r);return a.apply(t,i)}}function i(){if(!arguments.length)return this;var e=this,a=u.call(arguments,0);return function(){var r=t(a,arguments);return e.apply(this,r)}}function s(e){var t=this,a=u.call(arguments,1);return e=1e3*e,window.setTimeout(function(){return t.apply(t,a)},e)}function n(){var t=e([.01],arguments);return this.delay.apply(this,t)}function o(t){var a=this;return function(){var r=e([a.bind(this)],arguments);return t.apply(this,r)}}function d(){if(this._methodized)return this._methodized;var t=this;return this._methodized=function(){var a=e([this],arguments);return t.apply(null,a)},this._methodized}var u=Array.prototype.slice;return{argumentNames:a,bind:r,bindAsEventListener:l,curry:i,delay:s,defer:n,wrap:o,methodize:d}}()),jslet.Class=function(){function e(){}function t(){function t(){this.initialize.apply(this,arguments)}var a=null,r=jslet.toArray(arguments);jQuery.isFunction(r[0])&&(a=r.shift()),jslet.extend(t,jslet.Class.Methods),t.superclass=a,t.subclasses=[],a&&(e.prototype=a.prototype,t.prototype=new e,a.subclasses.push(t));for(var l=0,i=r.length;i>l;l++)t.addMethods(r[l]);return t.prototype.initialize||(t.prototype.initialize=jslet.emptyFunction),t.prototype.constructor=t,t}function a(e){var t=this.superclass&&this.superclass.prototype,a=jslet.keys(e);r&&(e.toString!=Object.prototype.toString&&a.push("toString"),e.valueOf!=Object.prototype.valueOf&&a.push("valueOf"));for(var l=window.jQuery.isFunction,i=0,s=a.length;s>i;i++){var n=a[i],o=e[n];if(t&&l(o)&&"$super"==o.argumentNames()[0]){var d=o;o=function(e){return function(){return t[e].apply(this,arguments)}}(n).wrap(d),o.valueOf=d.valueOf.bind(d),o.toString=d.toString.bind(d)}this.prototype[n]=o}return this}var r=function(){for(var e in{toString:1})if("toString"===e)return!1;return!0}();return{create:t,Methods:{addMethods:a}}}(),jslet._AUTOID=0,jslet.nextId=function(){return"jslet"+jslet._AUTOID++},jslet.data||(jslet.data={}),jslet.locale||(jslet.locale={}),jslet.temp||(jslet.temp={}),Array.indexOf||(Array.prototype.indexOf=function(e){for(var t=0,a=this.length;a>t;t++)if(this[t]==e)return t;return-1}),!Object.deepClone,String.prototype.trim||(String.prototype.trim=function(){this.replace(/^\s+/,"").replace(/\s+$/,"")}),String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.lastIndexOf(e,0)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){var t=this.length-e.length;return t>=0&&this.indexOf(e,t)===t}),jslet.debounce=function(e,t,a){var r;return function(){var a=this,l=arguments;if(!t)return void e.apply(a,l);var i=function(){r=null,e.apply(a,l)};r&&clearTimeout(r),r=setTimeout(i,t)}},jslet.deepClone=function(e){var t;t=e.constructor==Object?new e.constructor:new e.constructor(e.valueOf());for(var a in e)t[a]!=e[a]&&("object"==typeof e[a]?t[a]=e[a].deepClone():t[a]=e[a]);return t.toString=e.toString,t.valueOf=e.valueOf,t},jslet.SimpleMap=function(){var e=[],t=[];this.get=function(a){for(var r=e.length,l=0;r>l;l++)if(a==e[l])return t[l];return null},this.set=function(a,r){var l=e.indexOf(a);l>=0?t[l]=r:(e.push(a),t.push(r))},this.clear=function(){e.length=0,t.length=0},this.unset=function(a){for(var r=e.length,l=0;r>l;l++)if(e[l]==a)return e.splice(l,1),void t.splice(l,1)},this.count=function(){return e.length},this.keys=function(){return e},this.values=function(){return t}},jslet.formatMessage=function(e,t){if(jslet.Checker.test("jslet.formatMessage#msg",e).required().isString(),void 0===t||null===t)return e;t===!1&&(t="false"),t===!0&&(t="true");var a,r,l=e;if(jslet.isArray(t))for(a=t.length,r=0;a>r;r++)l=l.replace("{"+r+"}",t[r]);else{if(!t.keys)return e.replace("{0}",t);var i,s=t.keys();for(a=s.length,r=0;a>r;r++)i=s[r],l=l.replace("{"+i+"}",t.get(i))}return l},jslet.formatString=function(e,t){if(!t||!e)return e;for(var a,r,l=e.length,i=t.length,s=i-1,n=-1,o="",d=0;i>d;d++)if(a=t[d],"\\"===a&&s>d&&(r=t[d+1],"#"===r))o+="#",d++;else if("#"===a){if(n++,n===l)break;o+=e[n]}else o+=a;return o},jslet._SCALEFACTOR="100000000000000000000000000000000000",jslet.formatNumber=function(e,t){if(!t)return e+"";if(!e&&0!==e)return"";var a,r,l="";for(r=0;r<t.length;r++)if(a=t.substr(r,1),"#"==a||"0"==a||","==a){r>0&&(l=t.substr(0,r),t=t.substr(r));break}var i="";for(r=t.length-1;r>=0;r--)if(a=t.substr(r,1),"#"==a||"0"==a||","==a){r>0&&(i=t.substr(r+1),t=t.substr(0,r+1));break}var s=t?t.split("."):[""],n=0;s.length>1&&(n=s[1].length);var o=e?e.toString().split("."):["0"],d=0;if(o.length>1&&(d=o[1].length),d>n){var u=parseInt(jslet._SCALEFACTOR.substring(0,n+1));e=Math.round(e*u)/u,o=e?e.toString().split("."):["0"]}var c,f="",h=o[0],v=s[0],_=!1,g=h.length-1;for(c=v.length-1;c>=0;c--)switch(v.substr(c,1)){case"#":g>=0&&(f=h.substr(g--,1)+f);break;case"0":f=g>=0?h.substr(g--,1)+f:"0"+f;break;case",":_=!0,f=","+f}if(g>=0)if(_)for(var p=h.length;g>=0;g--)f=h.substr(g,1)+f,g>0&&(p-g)%3===0&&(f=","+f);else f=h.substr(0,g+1)+f;for(f+=".",h=o.length>1?o[1]:"",v=s.length>1?s[1]:"",g=0,c=0;c<v.length;c++)switch(v.substr(c,1)){case"#":g<h.length&&(f+=h.substr(g++,1));break;case"0":f+=g<h.length?h.substr(g++,1):"0"}return l+f.replace(/^,+/,"").replace(/\.$/,"")+i},jslet.formatDate=function(e,t){if(!e)return"";jslet.Checker.test("jslet.formatDate#date",e).isDate(),jslet.Checker.test("jslet.formatDate#format",t).required().isString();var a={"M+":e.getMonth()+1,"d+":e.getDate(),"h+":e.getHours(),"m+":e.getMinutes(),"s+":e.getSeconds(),"q+":Math.floor((e.getMonth()+3)/3),S:e.getMilliseconds()};/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in a)new RegExp("("+r+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[r]:("00"+a[r]).substr((""+a[r]).length)));return t},jslet.parseDate=function(e,t){if(!e)return null;jslet.Checker.test("jslet.parseDate#strDate",e).isString(),jslet.Checker.test("jslet.parseDate#format",t).required().isString();for(var a,r,l=null,i=-1,s=0,n={y:0,M:0,d:0,h:0,m:0,s:0,S:0},o=0,d=t.length;d>o;o++)a=t.charAt(o),a!=l&&(l&&void 0!==n[l]&&i>=0&&(s=o,r=parseInt(e.substring(i,s)),n[l]=isNaN(r)?0:r),i=o,l=a);i>=0&&(r=parseInt(e.substring(i)),n[a]=isNaN(r)?0:r);var u=n.y;100>u&&(u+=2e3);var c=new Date(u,n.M-1,n.d,n.h,n.m,n.s,n.S);return c},Date.prototype.toJSON=function(){return jslet.formatDate(this,"yyyy-MM-ddThh:mm:ss")},jslet.convertISODate=function(e){if(!e)return null;if(jslet.isDate(e))return e;var t=e.substr(10,1);if(10===e.length||"T"==t){var a=e.substr(0,4),r=e.substr(5,2),l=e.substr(8,2),i=e.substr(11,2),s=e.substr(14,2),n=e.substr(17,2);return"Z"==e.substr(-1,1)?new Date(Date.UTC(+a,+r-1,+l,+i,+s,+n)):new Date(+a,+r-1,+l,+i,+s,+n)}return e},jslet._currentPattern={},jslet._convertToJsPattern=function(e,t){if(jslet._currentPattern.pattern==e&&jslet._currentPattern.escapeChar==t)return jslet._currentPattern.result;jslet._currentPattern.pattern=e,jslet._currentPattern.escapeChar=t;var a,r,l=[],i=e.length-1,s=0,n=i,o=!1,d=!1;"%"==e.charAt(0)&&(s=1,o=!0),"%"==e.charAt(i)&&(n=i-1,d=!0),o&&d?l.push(".*"):d&&l.push("^");for(var u=s;n>=u;u++)if(a=e.charAt(u),"\\"==a&&i>u){if(r=e.charAt(u+1),"%"==r||"_"==r){l.push(r),u++;continue}}else"_"==a?l.push("."):("."!=a&&"*"!=a&&"["!=a&&"]"!=a&&"{"!=a&&"}"!=a&&"+"!=a&&"("!=a&&")"!=a&&"\\"!=a&&"?"!=a&&"$"!=a&&"^"!=a||l.push("\\"),l.push(a));return o&&d||d?l.push(".*"):o&&l.push("$"),jslet._currentPattern.result=new RegExp(l.join(""),"ig"),jslet._currentPattern.result},jslet.like=function(e,t,a){if(!e||!t)return!1;if(0===t.length)return!1;a||(a="\\");var r=jslet._convertToJsPattern(t,a);return jslet.isString(e)||(e+=""),null!==e.match(r)},jslet.between=function(e,t,a){if(arguments.length<=1)return!1;var r=!0,l=!0;return null!==t&&void 0!==t&&(r=jslet.compareValue(e,t)>=0),null!==a&&void 0!==a&&(l=jslet.compareValue(e,a)<=0),r&&l},jslet.inlist=function(e,t){var a=arguments.length;if(2>a)return!1;for(var r=1;a>r;r++)if(0===jslet.compareValue(e,arguments[r]))return!0;return!1},jslet.isArray=function(e){return null===e||void 0===e||"[object Array]"===Object.prototype.toString.apply(e)},jslet.isDate=function(e){return null===e||void 0===e||e.constructor==Date},jslet.isString=function(e){return null===e||void 0===e||"string"==typeof e},jslet.isObject=function(e){return null===e||void 0===e||"object"!==jQuery.type(this.varValue)},jslet.isEmpty=function(e){if(null===e||void 0===e||""===e)return!0;if(jslet.isArray(e)){for(var t=e,a=!0,r=0,l=t.length;l>r;r++)if(!jslet.isEmpty(t[r])){a=!1;break}return a}return!1},jslet.setTimeout=function(e,t,a){jslet.delayFunc=function(){t.call(e)},setTimeout(jslet.delayFunc,a)},jslet.compareValue=function(e,t,a){if(e=void 0===e?null:e,t=void 0===t?null:t,e===t)return 0;if(null===e&&null!==t)return-1;if(null===t&&null!==e)return 1;var r=jslet.isString(e),l=jslet.isString(t);return r||l?(r||(e+=""),l||(t+=""),a||(e=e.toLowerCase(),t=t.toLowerCase()),e.localeCompare(t)):(jslet.isDate(e)&&(e=e.getTime(),t=t.getTime()),e==t?0:t>e?-1:1)},jslet.htmlEncode=function(e){return e?jQuery("<div />").text(e).html():""},jslet.htmlDecode=function(e){return e?jQuery("<div />").html(e).text():""},jslet.getArrayValue=function(e,t){if(!e)return null;if(jslet.isArray(e)){var a=e.length;return a>t?e[t]:null}return 0===t?e:null},jslet.Checker={varName:null,varValue:null,test:function(e,t){return this.varName=e,this.varValue=t,this},testValue:function(e){return this.varValue=e,this},required:function(){if(null===this.varValue||void 0===this.varValue||""===this.varValue)throw new Error(jslet.formatMessage(jslet.locale.Checker.required,[this.varName]));return this},isBoolean:function(){if(null!==this.varValue&&void 0!==this.varValue&&""!==this.varValue&&0!==this.varValue&&this.varValue!==!0&&this.varValue!==!1)throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredBooleanValue,[this.varName]));return this},isString:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isString(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredStringValue,[this.varName,this.varValue]));return this},isDate:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isDate(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredDateValue,[this.varName,this.varValue]));return this},isNumber:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jQuery.isNumeric(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredNumbericValue,[this.varName,this.varValue]));return this},isGTZero:function(){if(this.isNumber(),this.varValue<=0)throw new Error(jslet.formatMessage(jslet.locale.Checker.greatThanZero,[this.varName,this.varValue]))},isGTEZero:function(){if(this.isNumber(),this.varValue<0)throw new Error(jslet.formatMessage(jslet.locale.Checker.greatThanEqualZero,[this.varName,this.varValue]))},between:function(e,t){var a=null!==e&&void 0!==e,r=null!==t&&void 0!==t;if(a&&r&&(this.varValue<e||this.varValue>t))throw new Error(jslet.formatMessage(jslet.locale.Checker.betweenValue,[this.varName,this.varValue,e,t]));if(!a&&r&&this.varValue>t)throw new Error(jslet.formatMessage(jslet.locale.Checker.lessThanMaxValue,[this.varName,this.varValue,t]));if(a&&!r&&this.varValue<e)throw new Error(jslet.formatMessage(jslet.locale.Checker.betweenValue,[this.varName,this.varValue,e]))},isArray:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jslet.isArray(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredArrayValue,[this.varName,this.varValue]));return this},isObject:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&"object"!==jQuery.type(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredObjectValue,[this.varName,this.varValue]));return this},isPlanObject:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jQuery.isPlainObject(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredPlanObjectValue,[this.varName,this.varValue]));return this},isFunction:function(){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&!jQuery.isFunction(this.varValue))throw new Error(jslet.formatMessage(jslet.locale.Checker.requiredFunctionValue,[this.varName,this.varValue]));return this},isClass:function(e){if(this.isObject(),null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&this.varValue.className!=e)throw new Error(jslet.formatMessage(jslet.locale.Checker.instanceOfClass,[this.varName,this.varValue,e]));return this},isDataType:function(e){return"S"==e&&this.isString(),"N"==e&&this.isNumber(),"D"==e&&this.isDate(),this},inArray:function(e){if(null!==this.varValue&&void 0!==this.varValue&&this.varValue!==!1&&e.indexOf(this.varValue)<0)throw new Error(jslet.formatMessage(jslet.locale.Checker.inArray,[this.varName,this.varValue,e.join(",")]));return this}},jslet.JSON={normalize:function(e){var t,a=[],r=!1,l=!1,i=!0,s="",n=null,o=!1;t=e.charAt(0),"{"!=t&&"["!=t&&(a.push('{"'),o=!0);for(var d=0,u=e.length;u>d;d++)t=e.charAt(d),n?t==n?(n=null,a.push('"'),s='"'):a.push(t):("["==t&&(l=!0,i=!1),"]"!=t&&"{"!=t||(l=!1,i=!0),(!r||" "!=t&&"\b"!=t)&&(!i||"{"!=t&&","!=t?("{"!=s&&","!=s||a.push('"'),r&&"'"==t?a.push('"'):(":"==t&&(r=!1,'"'!=s&&a.push('"')),r||"'"!=t&&'"'!=t?(s=t,a.push(t)):(n=t,a.push('"')))):(r=!0,a.push(t),s=t)));return o&&a.push("}"),a.join("")},parse:function(e){try{return JSON.parse(e)}catch(t){throw new Error(jslet.formatMessage(jslet.locale.Common.jsonParseError,[e]))}},stringify:function(e,t,a){return JSON.stringify(e,t,a)}},jslet.getFunction=function(e,t){if(!e)return null;if(jQuery.isFunction(e))return e;t||(t=window);var a=t[e];return a||console.warn("NOT found function:"+e),a},jslet.getRemainingString=function(e,t){return e&&t?e.replace(t,""):e},jslet.getYear=function(e){return e&&jslet.isDate(e)?e.getFullYear():0},jslet.getMonth=function(e){return e&&jslet.isDate(e)?e.getMonth()+1:0},jslet.getYearMonth=function(e){return e&&jslet.isDate(e)?100*e.getFullYear()+e.getMonth()+1:0},jslet.showError=function(e,t,a){var r;r="string"==typeof e?e:e.message,jslet.ui&&jslet.ui.MessageBox?jslet.ui.MessageBox.error(r,null,t):window.alert(r)},jslet.showInfo=function(e,t,a){var r;r="string"==typeof e?e:e.message,jslet.ui&&jslet.ui.MessageBox?jslet.ui.MessageBox.alert(r,jslet.locale.MessageBox.Info,t,a):window.alert(r)},jslet.Clipboard=function(){var e=window.document,t=e.getElementById("jsletClipboard");t||(jQuery('<textarea id="jsletClipboard" style="position:absolute;top:-1000px" tabindex="-1"></textarea>').appendTo(e.body),window.addEventListener("copy",function(e){var t=jQuery("#jsletClipboard").val();return t?(e.clipboardData?e.clipboardData.setData("text/plain",t):window.clipboardData.setData("text",t),jQuery("#jsletClipboard").val(null),e.preventDefault(),!1):void 0}))},jslet.Clipboard.putText=function(e){var t=jQuery("#jsletClipboard").val(e);t[0].select()},jslet.Clipboard(),function(e){e.fn.getStyleObject=function(){var e,t,a=this.get(0),r={};if(window.getComputedStyle){var l=function(e,t){return t.toUpperCase()};e=window.getComputedStyle(a,null);for(var i=0;i<e.length;i++){t=e[i];var s=t.replace(/\-([a-z])/g,l),n=e.getPropertyValue(t);r[s]=n}return r}if(a.currentStyle){e=a.currentStyle;for(t in e)r[t]=e[t];return r}return this.css()}}(jQuery),jslet.getCookie||(jslet.getCookie=function(e){var t=document.cookie.indexOf(e+"="),a=t+e.length+1;if(!t&&e!=document.cookie.substring(0,e.length))return null;if(-1==t)return null;var r=document.cookie.indexOf(";",a);return-1==r&&(r=document.cookie.length),window.unescape(document.cookie.substring(a,r))}),jslet.setCookie||(jslet.setCookie=function(e,t,a,r,l,i){var s=new Date;s.setTime(s.getTime()),a&&(a=1e3*a*60*60*24);var n=new Date(s.getTime()+a);document.cookie=e+"="+window.escape(t)+(a?";expires="+n.toGMTString():"")+(r?";path="+r:"")+(l?";domain="+l:"")+(i?";secure":"")}),jslet.deleteCookie||(jslet.deleteCookie=function(e,t,a){jslet.getCookie(e)&&(document.cookie=e+"="+(t?";path="+t:"")+(a?";domain="+a:"")+";expires=Thu, 01-Jan-1970 00:00:01 GMT")}),jslet.MessageBus=function(){var e={};e[jslet.MessageBus.SIZECHANGED]=[];var t=[];this.sendMessage=function(a,r,l){if(e[a]){var i=t[a];i&&window.clearTimeout(i),i=setTimeout(function(){t[a]=null;for(var l,i=e[a],s=0,n=i.length;n>s;s++)l=i[s],l&&l.onReceiveMessage&&l.onReceiveMessage(a,r)},30),t[a]=i}},this.subscribe=function(t,a){if(!t||!a)throw new Error("MessageName and ctrlObj required!");var r=e[t];r||(r=[],e[t]=r),r.push(a)},this.unsubscribe=function(t,a){var r=e[t];if(r){var l=r.indexOf(a);l>=0&&r.splice(l,1)}}},jslet.MessageBus.SIZECHANGED="SIZECHANGED",jslet.messageBus=new jslet.MessageBus,jQuery(window).on("resize",function(){jslet.messageBus.sendMessage(jslet.MessageBus.SIZECHANGED,null,window)}),jslet.data.ContextRule=function(){var e=this;e._name="",e._description="",e._status=void 0,e._selected=void 0,e._condition=void 0,e._rules=[]},jslet.data.ContextRule.className="jslet.data.ContextRule",jslet.data.ContextRule.prototype={className:jslet.data.ContextRule.className,dataStatus:["insert","update","other"],name:function(e){return void 0===e?this._name:(jslet.Checker.test("ContextRule.name",e).isString(),this._name=jQuery.trim(e),this)},status:function(e){if(void 0===e)return this._status;if(jslet.Checker.test("ContextRule.status",e).isArray(),e)for(var t,a,r=0,l=e.length;l>r;r++)t=jQuery.trim(e[r]),a=jslet.Checker.test("ContextRule.status"+r,t).isString().required(),t=t.toLowerCase(),a.testValue(t).inArray(this.dataStatus),e[r]=t;return this._status=e,this},selected:function(e){return void 0===e?this._selected:void(this._selected=!!e)},condition:function(e){return void 0===e?this._condition:(jslet.Checker.test("ContextRule.condition",e).isString(),this._condition=jQuery.trim(e),this)},rules:function(e){return void 0===e?this._rules:(jslet.Checker.test("ContextRule.rules",e).isArray(),this._rules=e,this)}},jslet.data.ContextRuleItem=function(e){var t=this;jslet.Checker.test("ContextRule.field",e).isString(),e=jQuery.trim(e),jslet.Checker.test("ContextRule.field",e).required(),t._field=e,t._meta=void 0,t._value=void 0,t._lookup=void 0,t._customized=void 0},jslet.data.ContextRuleItem.className="jslet.data.ContextRuleItem",jslet.data.ContextRuleItem.prototype={className:jslet.data.ContextRuleItem.className,field:function(){return this._field},meta:function(e){return void 0===e?this._meta:(jslet.Checker.test("ContextRuleItem.meta",e).isClass(jslet.data.ContextRuleMeta.className),this._meta=e,this)},lookup:function(e){return void 0===e?this._lookup:(jslet.Checker.test("ContextRuleItem.lookup",e).isClass(jslet.data.ContextRuleLookup.className),this._lookup=e,this)},value:function(e){return void 0===e?this._value:(this._value=e,this)},customized:function(e){return void 0===e?this._customized:(jslet.Checker.test("ContextRuleItem.customized",e).isFunction(),this._customized=e,this)}},jslet.data.ContextRuleMeta=function(){var e=this;e._label=void 0,e._tip=void 0,e._nullText=void 0,e._required=void 0,e._disabled=void 0,e._readOnly=void 0,e._visible=void 0,e._formula=void 0,e._scale=void 0,e._defaultValue=void 0,e._displayFormat=void 0,e._editMask=void 0,e._editControl=void 0,e._range=void 0,e._regularExpr=void 0,e._valueCountLimit=void 0,e._validChars=void 0,e._customValidator=void 0},jslet.data.ContextRuleMeta.className="jslet.data.ContextRuleMeta",jslet.data.ContextRuleMeta.prototype={className:jslet.data.ContextRuleMeta.className,properties:["label","tip","nullText","required","disabled","readOnly","visible","formula","scale","defaultValue","displayFormat","editMask","editControl","range","regularExpr","valueCountLimit","validChars","customValidator"],label:function(e){return void 0===e?this._label:(jslet.Checker.test("ContextRuleMeta.label",e).isString(),this._label=e,this)},tip:function(e){return void 0===e?this._tip:(jslet.Checker.test("ContextRuleMeta.tip",e).isString(),this._tip=e,this)},nullText:function(e){return void 0===e?this._nullText:(jslet.Checker.test("ContextRuleMeta.nullText",e).isString(),this._nullText=jQuery.trim(e),this)},required:function(e){var t=this;return void 0===e?t._required:(t._required=!!e,this)},visible:function(e){var t=this;return void 0===e?t._visible:(t._visible=!!e,this)},disabled:function(e){var t=this;return void 0===e?t._disabled:(t._disabled=!!e,this)},readOnly:function(e){var t=this;return void 0===e?t._readOnly:(t._readOnly=!!e,this)},editMask:function(e){var t=this;return void 0===e?t._editMask:(t._editMask=e,this)},scale:function(e){var t=this;return void 0===e?t._scale:(jslet.Checker.test("ContextRuleMeta.scale",e).isNumber(),t._scale=parseInt(e),this)},formula:function(e){var t=this;return void 0===e?t._formula:(jslet.Checker.test("ContextRuleMeta.formula",e).isString(),t._formula=jQuery.trim(e),this)},displayFormat:function(e){var t=this;return void 0===e?t._displayFormat:(jslet.Checker.test("ContextRuleMeta.format",e).isString(),t._displayFormat=jQuery.trim(e),this)},editControl:function(e){var t=this;return void 0===e?t._editControl:void(t._editControl="string"==typeof e?{type:e}:e)},defaultValue:function(e){var t=this;return void 0===e?t._defaultValue:(t._defaultValue=e,this)},range:function(e){var t=this;return void 0===e?t._range:(jslet.isString(e)?t._range=new Function("return "+e):t._range=e,this)},regularExpr:function(e){var t=this;return void 0===e?t._regularExpr:(jslet.isString(e)?t._regularExpr=new Function("return "+e):t._regularExpr=e,this)},valueCountLimit:function(e){var t=this;return void 0===e?t._valueCountLimit:(jslet.Checker.test("ContextRuleMeta.valueCountLimit",e).isNumber(),t._valueCountLimit=parseInt(e),this)},customValidator:function(e){var t=this;return void 0===e?t._customValidator:(jslet.Checker.test("ContextRuleMeta.customValidator",e).isFunction(),t._customValidator=e,this)},validChars:function(e){var t=this;return void 0===e?t._validChars:(jslet.Checker.test("ContextRuleMeta.validChars",e).isString(),void(t._validChars=jQuery.trim(e)))}},jslet.data.ContextRuleLookup=function(){var e=this;e._dataset=void 0,e._filter=void 0,e._fixedFilter=void 0,e._criteria=void 0,e._displayFields=void 0,e._onlyLeafLevel=void 0},jslet.data.ContextRuleLookup.className="jslet.data.ContextRuleLookup",jslet.data.ContextRuleLookup.prototype={className:jslet.data.ContextRuleLookup.className,properties:["dataset","filter","fixedFilter","criteria","displayFields","onlyLeafLevel"],dataset:function(e){var t=this;return void 0===e?t._dataset:(jslet.Checker.test("ContextRuleLookup.dataset",e).isString(),void(t._dataset=jQuery.trim(e)))},filter:function(e){var t=this;return void 0===e?t._filter:(jslet.Checker.test("ContextRuleLookup.filter",e).isString(),void(t._filter=jQuery.trim(e)))},fixedFilter:function(e){var t=this;return void 0===e?t._fixedFilter:(jslet.Checker.test("ContextRuleLookup.fixedFilter",e).isString(),void(t._fixedFilter=jQuery.trim(e)))},criteria:function(e){var t=this;return void 0===e?t._criteria:(jslet.Checker.test("ContextRuleLookup.criteria",e).isString(),void(t._criteria=jQuery.trim(e)))},displayFields:function(e){var t=this;return void 0===e?t._displayFields:(jslet.Checker.test("ContextRuleLookup.displayFields",e).isString(),void(t._displayFields=jQuery.trim(e)))},onlyLeafLevel:function(e){var t=this;return void 0===e?t._onlyLeafLevel:void(t._onlyLeafLevel=!!e)}},jslet.data.createContextRule=function(e){function t(e){var t=new jslet.data.ContextRuleItem(e.field);return void 0!==e.meta&&t.meta(a(e.meta)),void 0!==e.value&&t.value(e.value),void 0!==e.lookup&&t.lookup(r(e.lookup)),void 0!==e.customized&&t.customized(e.customized),t}function a(e){var t=new jslet.data.ContextRuleMeta;return void 0!==e.label&&t.label(e.label),void 0!==e.tip&&t.tip(e.tip),void 0!==e.nullText&&t.nullText(e.nullText),void 0!==e.required&&t.required(e.required),void 0!==e.disabled&&t.disabled(e.disabled),void 0!==e.readOnly&&t.readOnly(e.readOnly),void 0!==e.visible&&t.visible(e.visible),void 0!==e.formula&&t.formula(e.formula),void 0!==e.scale&&t.scale(e.scale),void 0!==e.required&&t.required(e.required),void 0!==e.displayFormat&&t.displayFormat(e.displayFormat),void 0!==e.editMask&&t.editMask(e.editMask),void 0!==e.editControl&&t.editControl(e.editControl),void 0!==e.range&&t.range(e.range),void 0!==e.regularExpr&&t.regularExpr(e.regularExpr),void 0!==e.valueCountLimit&&t.valueCountLimit(e.valueCountLimit),void 0!==e.validChars&&t.validChars(e.validChars),void 0!==e.customValidator&&t.customValidator(e.customValidator),t}function r(e){var t=new jslet.data.ContextRuleLookup;return void 0!==e.dataset&&t.dataset(e.dataset),void 0!==e.filter&&t.filter(e.filter),void 0!==e.fixedFilter&&t.fixedFilter(e.fixedFilter),void 0!==e.criteria&&t.criteria(e.criteria),void 0!==e.displayFields&&t.displayFields(e.displayFields),void 0!==e.onlyLeafLevel&&t.onlyLeafLevel(e.onlyLeafLevel),t}if(!e)return null;var l=new jslet.data.ContextRule;if(void 0!==e.status&&l.status(e.status),void 0!==e.selected&&l.selected(e.selected),void 0!==e.condition&&l.condition(e.condition),void 0!==e.rules){jslet.Checker.test("ContextRule.rules",i).isArray();var i=[];l.rules(i);for(var s=0,n=e.rules.length;n>s;s++)i.push(t(e.rules[s]))}return l},jslet.data.ContextRuleEngine=function(e){this._dataset=e,this._matchedRules=[],this._ruleEnv={}},jslet.data.ContextRuleEngine.prototype={compile:function(){for(var e=this._dataset.contextRules(),t=0,a=e.length;a>t;t++)this._compileOneRule(e[t])},evalRule:function(e){var t,a=this._dataset.contextRules();this._matchedRules=[],this._ruleEnv={};for(var r=0,l=a.length;l>r;r++)t=a[r],this._evalOneRule(t,e);this._syncMatchedRules(e)},_compileOneRule:function(e){e.condition;this._compileExpr(e,"condition",!0);for(var t=e.rules(),a=0,r=t.length;r>a;a++)this._compileRuleItem(t[a])},_compileRuleItem:function(e){this._compileExpr(e,"value");var t,a,r,l,i=e.meta();if(i)for(t=i.properties,l=t.length,r=0;l>r;r++)a=t[r],this._compileExpr(i,a);var s=e.lookup();if(s)for(t=s.properties,l=t.length,r=0;l>r;r++)a=t[r],this._compileExpr(s,a)},_compileExpr:function(e,t,a){var r=e[t].call(e),l=t+"Expr";null!==r&&void 0!==r&&jslet.isString(r)&&(0===r.indexOf("expr:")&&(r=r.substring(5),a=!0),a&&(e[l]=new jslet.Expression(this._dataset,r)))},_evalOneRule:function(e,t){var a=!1,r=e.conditionExpr,l=null,i=!1;if(r){if(l=r.mainFields(),t&&l&&l.indexOf(t)<0)return;if(a=r.eval(),!a)return;i=!0}var s=e.status();if(void 0!==s){var n="other",o=this._dataset.changedStatus();o==jslet.data.DataSetStatus.INSERT?n="insert":o==jslet.data.DataSetStatus.UPDATE&&(n="update"),i||(a=!0),a=a&&s.indexOf(n)>=0,i=!0}var d=e.selected();if(void 0!==d&&(i||(a=!0),a=a&&d===!!this._dataset.selected()),a){if(l)for(var u,c=0,f=l.length;f>c;c++)u=l[c],void 0===this._ruleEnv[u]&&(this._ruleEnv[u]=this._dataset.getFieldValue(u));this._evalRuleItems(e.rules(),!!t)}},_evalRuleItems:function(e,t){for(var a,r,l,i=0,s=e.length;s>i;i++){r=e[i],a=r.field(),l=new jslet.data.ContextRuleItem(a);var n=r.meta();n&&(l.meta(new jslet.data.ContextRuleMeta),this._copyProperties(n,l.meta()));var o=r.lookup();o&&(l.lookup(new jslet.data.ContextRuleLookup),this._copyProperties(o,l.lookup())),t&&void 0!==r.value()&&l.value(this._evalExpr(r,"value"));var d=r.customized();d&&l.customized(d),this._matchedRules.push(l)}},_copyProperties:function(e,t){for(var a,r,l=e.properties,i=0,s=l.length;s>i;i++)a=l[i],r=this._evalExpr(e,a),void 0!==r&&t[a].call(t,r)},_evalExpr:function(e,t){var a=e[t+"Expr"];return a?a.eval():e[t].call(e)},_syncMatchedRules:function(e){for(var t,a,r,l=this._matchedRules,i=0,s=l.length;s>i;i++)if(t=l[i],a=t.field(),r=this._dataset.getField(a)){this._syncMatchedRuleMeta(r,t.meta()),this._syncMatchedRuleLookup(r,t.lookup()),this._syncMatchedRuleValue(r,t.value());var n=t.customized();n&&n(r,e)}},_syncMatchedRuleMeta:function(e,t){if(t)for(var a,r,l=t.properties,i=0,s=l.length;s>i;i++)a=l[i],r=t[a].call(t),void 0!==r&&e[a].call(e,r)},_syncMatchedRuleLookup:function(e,t){if(t){var a=e.lookup();if(a){var r=t.dataset();r&&a.dataset(r);var l=a.dataset();l.autoRefreshHostDataset(!0);var i,s=t.filter();if(void 0!==s){for(i in this._ruleEnv)s=s.replace("${"+i+"}",this._ruleEnv[i]);l.filter(s),l.filtered(!0)}if(s=t.fixedFilter(),void 0!==s){for(i in this._ruleEnv)s=s.replace("${"+i+"}",this._ruleEnv[i]);l.fixedFilter(s),l.filtered(!0)}var n=t.criteria();void 0!==n&&l.query(n);var o=t.displayFields();void 0!==o&&a.displayFields(o);var d=t.onlyLeafLevel();void 0!==d&&a.onlyLeafLevel(d)}}},_syncMatchedRuleValue:function(e,t){void 0!==t&&e.setValue(t)}},jslet.data.dataModule=new jslet.SimpleMap,jslet.data.getDataset=function(e){return jslet.isString(e)?jslet.data.dataModule.get(e):e},jslet.data.DatasetType={NORMAL:0,LOOKUP:1,DETAIL:2},jslet.data.onCreatingDataset=function(e,t,a,r){},jslet.data.DataType={NUMBER:"N",STRING:"S",DATE:"D",TIME:"T",BOOLEAN:"B",DATASET:"V",CROSS:"C",PROXY:"P"},jslet.data.FieldValueStyle={NORMAL:0,BETWEEN:1,MULTIPLE:2},jslet.data.EditMask=function(e,t,a){this.mask=e,this.keepChar=void 0!==t?t:!0,this.transform=a,this.clone=function(){return new jslet.data.EditMask(this.mask,this.keepChar,this.transform)}},jslet.data.DatasetEvent={BEFORESCROLL:"beforeScroll",AFTERSCROLL:"afterScroll",BEFOREINSERT:"beforeInsert",AFTERINSERT:"afterInsert",BEFOREUPDATE:"beforeUpdate",AFTERUPDATE:"afterUpdate",BEFOREDELETE:"beforeDelete",AFTERDELETE:"afterDelete",BEFORECONFIRM:"beforeConfirm",AFTERCONFIRM:"afterConfirm",BEFORECANCEL:"beforeCancel",AFTERCANCEL:"afterCancel",BEFORESELECT:"beforeSelect",AFTERSELECT:"afterSelect",BEFORESELECTALL:"beforeSelectAll",AFTERSELECTALL:"afterSelectAll"},jslet.data.DataSetStatus={BROWSE:0,INSERT:1,UPDATE:2,DELETE:3},jslet.data.RefreshEvent={updateRecordEvent:function(e){return{eventType:jslet.data.RefreshEvent.UPDATERECORD,fieldName:e}},updateColumnEvent:function(e){return{eventType:jslet.data.RefreshEvent.UPDATECOLUMN,fieldName:e}},updateAllEvent:function(){
return this._updateAllEvent},changeMetaEvent:function(e,t,a){var r={eventType:jslet.data.RefreshEvent.CHANGEMETA,metaName:e,fieldName:t};return void 0!==a&&(r.changeAllRows=a),r},beforeScrollEvent:function(e){return{eventType:jslet.data.RefreshEvent.BEFORESCROLL,recno:e}},scrollEvent:function(e,t){return{eventType:jslet.data.RefreshEvent.SCROLL,prevRecno:t,recno:e}},insertEvent:function(e,t,a){return{eventType:jslet.data.RefreshEvent.INSERT,prevRecno:e,recno:t,updateAll:a}},deleteEvent:function(e){return{eventType:jslet.data.RefreshEvent.DELETE,recno:e}},selectRecordEvent:function(e,t){return{eventType:jslet.data.RefreshEvent.SELECTRECORD,recno:e,selected:t}},selectAllEvent:function(e){return{eventType:jslet.data.RefreshEvent.SELECTALL,selected:e}},changePageEvent:function(){return this._changePageEvent},errorEvent:function(e){return{eventType:jslet.data.RefreshEvent.ERROR,message:e}},lookupEvent:function(e,t){return{eventType:jslet.data.RefreshEvent.UPDATELOOKUP,fieldName:e,isMetaChanged:t}},aggradedEvent:function(){return{eventType:jslet.data.RefreshEvent.AGGRADED}}},jslet.data.RefreshEvent.CHANGEMETA="changeMeta",jslet.data.RefreshEvent.UPDATEALL="updateAll",jslet.data.RefreshEvent.UPDATERECORD="updateRecord",jslet.data.RefreshEvent.UPDATECOLUMN="updateColumn",jslet.data.RefreshEvent.BEFORESCROLL="beforescroll",jslet.data.RefreshEvent.SCROLL="scroll",jslet.data.RefreshEvent.SELECTRECORD="selectRecord",jslet.data.RefreshEvent.SELECTALL="selectAll",jslet.data.RefreshEvent.INSERT="insert",jslet.data.RefreshEvent.DELETE="delete",jslet.data.RefreshEvent.CHANGEPAGE="changePage",jslet.data.RefreshEvent.UPDATELOOKUP="updateLookup",jslet.data.RefreshEvent.AGGRADED="aggraded",jslet.data.RefreshEvent.ERROR="error",jslet.data.RefreshEvent._updateAllEvent={eventType:jslet.data.RefreshEvent.UPDATEALL},jslet.data.RefreshEvent._changePageEvent={eventType:jslet.data.RefreshEvent.CHANGEPAGE},jslet.data.FieldValidator=function(){},jslet.data.FieldValidator.prototype={intRegular:{expr:/^(-)?[1-9]*\d+$/gi},floatRegular:{expr:/((^-?[1-9])|\d)\d*(\.[0-9]*)?$/gi},checkInputChar:function(e,t,a,r){var l=e.validChars(),i=!0;if(l&&t){var s=t.charAt(0);i=l.indexOf(s)>=0}if(a&&i&&e.getType()==jslet.data.DataType.NUMBER){var n=e.scale(),o=a.lastIndexOf(".");if("."==t)return!(o>=0);if(n>0&&o>=0&&a.length-o-1===n&&r-1>o)return!1}return i},checkInputText:function(e,t){var a=this.checkRequired(e,t);if(a)return a;if(""===t)return null;var r=e.getType(),l=e.regularExpr();if(l||(r==jslet.data.DataType.DATE?l=e.dateRegular():r==jslet.data.DataType.NUMBER&&(this.intRegular.message||(this.intRegular.message=jslet.locale.Dataset.invalidInt,this.floatRegular.message=jslet.locale.Dataset.invalidFloat),l=e.scale()?this.floatRegular:this.intRegular)),l){var i=l.expr;if("string"==typeof i&&(i=new RegExp(l.expr,"ig")),i.lastIndex=0,!i.test(t))return this._addFieldLabel(e.label(),l.message)}var s=t;if(!e.lookup()){if(r==jslet.data.DataType.NUMBER){var n=e.scale()||0,o=e.length();if(0===n)s=parseInt(t);else{var d=t.indexOf("."),u=d>0?d:t.length,c=o-n;if(u>c)return this._addFieldLabel(e.label(),jslet.formatMessage(jslet.locale.Dataset.invalidIntegerPart,[c,u]));if(u=d>0?t.length-d-1:0,u>n)return this._addFieldLabel(e.label(),jslet.formatMessage(jslet.locale.Dataset.invalidDecimalPart,[n,u]));s=parseFloat(t)}}r==jslet.data.DataType.DATE&&(s=jslet.parseDate(t,e.displayFormat()))}return this.checkValue(e,s)},_addFieldLabel:function(e,t){return"["+e+"]: "+t},checkRequired:function(e,t){if(e.required()){var a=!0;return null!==t&&void 0!==t||(a=!1),a&&jslet.isString(t)&&0===jQuery.trim(t).length&&(a=!1),a&&jslet.isArray(t)&&0===t.length&&(a=!1),e.getType()!==jslet.data.DataType.BOOLEAN||t||(a=!1),a?null:this._addFieldLabel(e.label(),jslet.formatMessage(jslet.locale.Dataset.fieldValueRequired))}return null},checkValue:function(e,t){var a=e.getType(),r=e.dataRange(),l=!!e.lookup();if(l&&(t=e.dataset().getFieldText(e.name(),!0)),r){var i=r.min,s=i,n=r.max,o=n,d=e.displayFormat();if(a==jslet.data.DataType.DATE&&(i&&(s=jslet.formatDate(i,d)),n&&(o=jslet.formatDate(n,d))),l||a!=jslet.data.DataType.NUMBER||(s=jslet.formatNumber(i,d),o=jslet.formatNumber(n,d)),void 0!==i&&void 0!==n&&(i>t||t>n))return this._addFieldLabel(e.label(),jslet.formatMessage(jslet.locale.Dataset.notInRange,[s,o]));if(void 0!==i&&void 0===n&&i>t)return this._addFieldLabel(e.label(),jslet.formatMessage(jslet.locale.Dataset.moreThanValue,[s]));if(void 0===i&&void 0!==n&&t>n)return this._addFieldLabel(e.label(),jslet.formatMessage(jslet.locale.Dataset.lessThanValue,[o]))}if(e.unique()){var u=e.dataset(),c=u.dataList();if(null!==t&&void 0!==t&&c&&c.length>1)for(var f,h=u.getRecord(),v=e.name(),_=0,g=c.length;g>_;_++)if(f=c[_],f!==h&&f[v]==t)return this._addFieldLabel(e.label(),jslet.locale.Dataset.notUnique)}if(e.customValidator()){var p=e.customValidator().call(e.dataset(),e,t,jslet.data.serverValidator);if(p)return this._addFieldLabel(e.label(),p)}return null}},jslet.data.serverValidator=function(e,t){var a;jslet.global.beforeSubmit&&(a=jslet.global.beforeSubmit({url:e})),a||(a={}),a.type="POST",a.async=!1,a.contentType="application/json",a.mimeType="application/json",a.dataType="json","object"==typeof t&&(t=jslet.JSON.stringify(t)),a.data=t;var r=null;return jQuery.ajax(e,a).done(function(e,t,a){if(e){var l=e.errorCode;r=l?e.errorMessage:jslet.isString(e)?e:e.result}else r=null}).fail(function(e,t,a){var r,l=e.responseJSON;if(l&&l.errorCode)r=l.errorMessage;else{var i=t,s=t;"error"==t&&(i="0000",s=jslet.locale.Common.ConnectError),r=s}}),r},jslet.data.FieldValueConverter=jslet.Class.create({className:"jslet.data.FieldValueConverter",textToValue:function(e,t){var a=t;return a},valueToText:function(e,t,a){var r=t;return r}}),jslet.data.FieldValueConverter.className="jslet.data.FieldValueConverter",jslet.data.NumberValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){var a=null;return t&&(a=0===e.scale()?parseInt(t):parseFloat(t)),a},valueToText:function(e,t,a){var r=e.dataset();if(e.unitConverted()&&(t*=r._unitConvertFactor),a)return t;var l=jslet.formatNumber(t,e.displayFormat());return e.unitConverted()&&r._unitName&&(l+=r._unitName),l}}),jslet.data.DateValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){var a=jslet.parseDate(t,e.displayFormat());return a},valueToText:function(e,t,a){if(!(t instanceof Date))throw new Error(jslet.formatMessage(jslet.locale.Dataset.invalidDateFieldValue,[e.name(),t]));return t?jslet.formatDate(t,e.displayFormat()):""}}),jslet.data.StringValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){var a=t;return e.antiXss()&&(a=jslet.htmlEncode(a)),a},valueToText:function(e,t,a){var r=(e.dataset(),e.displayFormat());return!a&&r?jslet.formatString(t,r):t}}),jslet.data.BooleanValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t){return t?"true"==t.toLowerCase():!1},valueToText:function(e,t,a){return t?e.trueText():e.falseText()}}),jslet.data.LookupValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(e,t,a){if(!t)return null;var r="",l=e.lookup(),i=l.dataset(),s=l.keyField(),n=l.codeField(),o=l.nameField();if(r=this._convertFieldValue(i,n,t,s),null===r&&(o!==n&&(r=this._convertFieldValue(i,o,t,s)),null===r)){var d=jslet.formatMessage(jslet.locale.Dataset.valueNotFound);return e.dataset().setFieldError(e.name(),d,a,t),void i.first()}return r},valueToText:function(e,t,a){var r,l=e.lookup(),i=l.dataset();return r=a?this._convertFieldValue(i,l.keyField(),t,"["+l.codeField()+"]"):this._convertFieldValue(i,l.keyField(),t,l.displayFields())},_convertFieldValue:function(e,t,a,r){if(null===r)throw new Error("NOT set destFields in method: ConvertFieldValue");var l=r.indexOf("[")>-1;l&&r!=e._convertDestFields&&(e._innerConvertDestFields=new jslet.Expression(e,r),e._convertDestFields=r),"string"!=typeof a&&(a+="");var i=jslet.global.valueSeparator,s=a.split(i),n=s.length-1;e._ignoreFilter=!0;try{if(0===n)return e.findByField(t,s[0])?l?e._innerConvertDestFields.eval():e.getFieldValue(r):null;for(var o="",d=0;n>=d;d++){if(!e.findByField(t,s[d]))return null;o+=l?e._innerConvertDestFields.eval():e.getFieldValue(r),d!=n&&(o+=i)}return o}finally{e._ignoreFilter=!1}}}),jslet.data._valueConverters={},jslet.data._valueConverters[jslet.data.DataType.NUMBER]=new jslet.data.NumberValueConverter,jslet.data._valueConverters[jslet.data.DataType.STRING]=new jslet.data.StringValueConverter,jslet.data._valueConverters[jslet.data.DataType.DATE]=new jslet.data.DateValueConverter,jslet.data._valueConverters[jslet.data.DataType.BOOLEAN]=new jslet.data.BooleanValueConverter,jslet.data._valueConverters.lookup=new jslet.data.LookupValueConverter,jslet.data.getValueConverter=function(e){if(e.lookup())return jslet.data._valueConverters.lookup;var t=e.getType();return jslet.data._valueConverters[t]},jslet.data.record2Json=function(e,t){function a(e,a){if("_jl_"!=e){if(t)for(var r,l=0,i=t.length;i>l;l++)if(r=t[l],e==r)return;return a}}return window.JSON&&JSON?(t&&jslet.Checker.test("record2Json#excludeFields",t).isArray(),JSON.stringify(e,a)):void console.error("Your browser does not support JSON!")},jslet.data.getRecInfo=function(e){jslet.Checker.test("jslet.data.getRecInfo#record",e).required();var t=e._jl_;return t||(t={},e._jl_=t),t},jslet.data.FieldValueCache={put:function(e,t,a,r){var l=jslet.data.getRecInfo(e),i=l.cache;if(i||(i={},e._jl_.cache=i),r||0===r){var s=i[t];s&&jslet.isObject(s)||(s={},i[t]=s),s[r+""]=a}else i[t]=a},get:function(e,t,a){var r=jslet.data.getRecInfo(e),l=r.cache;if(l){if(a||0===a){var i=l[t];if(i&&jslet.isObject(i))return i[a+""];return}return l[t]}},clear:function(e,t){var a=jslet.data.getRecInfo(e),r=a.cache;if(r){var l;l=jslet.isString(t)?t.split(","):t;var i,s=l.length;for(i=0;s>i;i++)delete r[l[i]]}},clearAll:function(e,t){var a=e.dataList();if(a){var r;r=jslet.isString(t)?t.split(","):t;for(var l,i,s,n,o=r.length,d=0,u=a.length;u>d;d++)if(l=a[d],s=jslet.data.getRecInfo(l),i=s.cache)for(n=0;o>n;n++)delete i[r[n]]}},removeCache:function(e){var t=jslet.data.getRecInfo(e);delete t.cache},removeAllCache:function(e){var t=e.dataList();if(t)for(var a,r,l=0,i=t.length;i>l;l++)a=t[l],a&&(r=jslet.data.getRecInfo(a),delete r.cache)}},jslet.data.FieldError={put:function(e,t,a,r,l){if(!a)return void jslet.data.FieldError.clear(e,t,r);var i=jslet.data.getRecInfo(e),s=i.error;s||(s={},i.error=s);var n=s[t];n||(n={},s[t]=n);var o={message:a};void 0!==l&&(o.inputText=l),r||(r=0),n[r+""]=o},putDetailError:function(e,t,a){var r=jslet.data.getRecInfo(e),l=r.error;l||(l={},r.error=l);var i=l[t];i||(i={},l[t]=i);var s=i[0];s||(s={errorCount:0},i[0]=s),s.errorCount+=a,s.errorCount<=0&&jslet.data.FieldError.clear(e,t)},get:function(e,t,a){var r=jslet.data.getRecInfo(e),l=r.error;if(l){var i=l[t];return i?(a||(a=0),i[a+""]):null}return null},clear:function(e,t,a){var r=jslet.data.getRecInfo(e),l=r.error;if(l){var i=l[t];if(!i)return;a||(a=0),delete i[a+""];var s=!1;for(var n in i){s=!0;break}s||delete l[t]}},existFieldError:function(e,t,a){var r=jslet.data.getRecInfo(e),l=r.error;if(l){var i=l[t];return i?(a||(a=0),!!i[a+""]):!1}return!1},existRecordError:function(e,t){var a=jslet.data.getRecInfo(e);if(!a)return!1;var r=a.error;if(r)for(var l in r)if(!(t&&t.indexOf(l)<0)&&r[l])return!0;return!1},getFirstErrorField:function(e,t){var a=jslet.data.getRecInfo(e);if(!a)return!1;var r=a.error;if(r)for(var l in r)if(!(t&&t.indexOf(l)<0)&&r[l])return l;return null},clearFieldError:function(e,t){var a=e.dataList();if(a)for(var r,l,i,s=0,n=a.length;n>s;s++)r=a[s],i=jslet.data.getRecInfo(r),l=i.error,l&&delete l[t]},clearRecordError:function(e){var t=jslet.data.getRecInfo(e);t&&delete t.error},clearDatasetError:function(e){var t=e.dataList();if(t)for(var a,r,l=0,i=t.length;i>l;l++)a=t[l],r=jslet.data.getRecInfo(a),r&&delete r.error}},jslet.data.FieldRawValueAccessor={getRawValue:function(e,t){var a=t.shortName()||t.name(),r=t.customValueAccessor(),l=t.getType(),i=this._innerGetValue(e,a,r);if(void 0===i||null===i)return null;if(l===jslet.data.DataType.BOOLEAN)return i===t.trueValue();if(l===jslet.data.DataType.PROXY)return jslet.JSON.parse(i);if(l===jslet.data.DataType.DATE){var s=!1;if(jslet.isArray(i))for(var n=0,o=i.length;o>n;n++){var d=i[n];jslet.isDate(d)||(d=jslet.convertISODate(d),i[n]=d,s=!0)}else jslet.isDate(i)||(i=jslet.convertISODate(i),s=!0);s&&this._innerSetValue(e,a,i,r)}return i},setRawValue:function(e,t,a){var r=t.shortName()||t.name(),l=t.customValueAccessor(),i=t.getType();return void 0===a||null===a?void this._innerSetValue(e,r,null,l):(i===jslet.data.DataType.BOOLEAN&&(a=a?t.trueValue():t.falseValue()),i===jslet.data.DataType.PROXY&&(a=jslet.JSON.stringify(a)),void this._innerSetValue(e,r,a,l))},_innerGetValue:function(e,t,a){return a?a.getValue(e,t):e[t]},_innerSetValue:function(e,t,a,r){return r?r.setValue(e,t,a):void(e[t]=a)}},jslet.data.DatasetRelationManager=function(){var e=[];this.addRelation=function(t,a,r,l){for(var i=0,s=e.length;s>i;i++){var n=e[i];if(n.hostDataset==t&&n.hostField==a&&n.lookupDataset==r)return}e.push({hostDataset:t,hostField:a,lookupOrDetailDataset:r,relationType:l})},this.removeRelation=function(t,a,r){for(var l=e.length-1;l>=0;l--){var i=e[l];i.hostDataset==t&&i.hostField==a&&i.lookupOrDetailDataset==r&&e.splice(l,1)}},this.removeDataset=function(t){for(var a=e.length-1;a>=0;a--){var r=e[a];r.hostDataset!=t&&r.lookupOrDetailDataset!=t||e.splice(a,1)}},this.changeDatasetName=function(t,a){if(t&&a)for(var r=0,l=e.length;l>r;r++){var i=e[r];i.hostDataset==t&&(i.hostDataset=a),i.lookupOrDetailDataset==t&&(i.lookupOrDetailDataset=a)}},this.refreshLookupHostDataset=function(t){if(t)for(var a,r,l=0,i=e.length;i>l;l++)if(a=e[l],a.lookupOrDetailDataset==t&&a.relationType==jslet.data.DatasetType.LOOKUP){if(r=jslet.data.getDataset(a.hostDataset),!r)throw new Error("NOT found Host dataset: "+a.hostDataset);r.handleLookupDatasetChanged(a.hostField)}},this.getHostFieldObject=function(t){if(t)for(var a,r,l=0,i=e.length;i>l;l++)if(a=e[l],a.lookupOrDetailDataset==t&&a.relationType==jslet.data.DatasetType.DETAIL){if(r=jslet.data.getDataset(a.hostDataset))return r.getField(a.hostField);throw new Error("NOT found Host dataset: "+a.hostDataset)}}},jslet.data.datasetRelationManager=new jslet.data.DatasetRelationManager,jslet.emptyPromise={done:function(e){return e&&e(),this},fail:function(e){return e&&e(),this},always:function(e){return e&&e(),this}},jslet.data.displayOrderComparator=function(e,t){var a=e.displayOrder(),r=t.displayOrder();return a-r},jslet.data.DataSelection=function(e){this._dataset=e,this._selection=[],this._onChanged=null},jslet.data.DataSelection.prototype={selectAll:function(e,t){if(jslet.Checker.test("DataSelection.add#fields",e).isArray(),this.removeAll(),!e){var a,r=this._dataset.getNormalFields();e=[];for(var l=0,i=r.length;i>l;l++)a=r[l].name(),e.push(a)}this.add(0,this._dataset.recordCount()-1,e,t)},removeAll:function(){this._selection=[]},add:function(e,t,a,r){jslet.Checker.test("DataSelection.add#startRecno",e).required().isNumber(),jslet.Checker.test("DataSelection.add#endRecno",t).required().isNumber(),jslet.Checker.test("DataSelection.add#fields",a).required().isArray(),void 0===t&&(t=e);for(var l,i=e;t>=i;i++)for(var s=0,n=a.length;n>s;s++)l=a[s],this._selectCell(i,l,!0);r&&this._onChanged&&this._onChanged(e,t,a,!0)},remove:function(e,t,a,r){if(jslet.Checker.test("DataSelection.remove#startRecno",e).required().isNumber(),jslet.Checker.test("DataSelection.remove#endRecno",t).required().isNumber(),jslet.Checker.test("DataSelection.remove#fields",a).required().isArray(),void 0===t&&(t=e),e>t){var l=e;e=t,t=l}for(var i,s=e;t>=s;s++)for(var n=0,o=a.length;o>n;n++)i=a[n],this._selectCell(s,i,!1);r&&this._onChanged&&this._onChanged(e,t,a,!1)},onChanged:function(e){return void 0===e?this._onChanged:(jslet.Checker.test("DataSelection.onChanged",e).isFunction(),void(this._onChanged=e))},isSelected:function(e,t){jslet.Checker.test("DataSelection.isSelected#recno",e).required().isNumber(),jslet.Checker.test("DataSelection.isSelected#fldName",t).required().isString();for(var a,r=0,l=this._selection.length;l>r;r++)if(a=this._selection[r],a._recno_===e&&a[t])return!0;return!1},getSelectionText:function(e,t,a){a||(a="	"),e=e?e:"",t=!!t;var r,l,i,s,n,o=this._dataset,d=[],u=o.startSilenceMove(),c=o.getNormalFields(),f=c.length;try{for(o.first();!o.isEof();){l=[];for(var h=0;f>h;h++)if(i=c[h],r=i.name(),this.isSelected(o.recno(),r)){if(n=i.getType(),"N"!==n||i.lookup())if(s=o.getFieldText(r),null===s||void 0===s)s='""';else{s=s.replace(/"/g,'""');var v=!1;s.startsWith("0")&&(v=!0),s=e+s+e,t&&(v||n===jslet.data.DataType.DATE)&&(s="="+s)}else s=i.getValue(),null!==s&&void 0!==s||(s=""),s=e+s+e;l.push(s)}l.length>0&&d.push(l.join(a)),o.next()}}finally{o.endSilenceMove(u)}return d.length>0?d.join("\n"):null},_selectCell:function(e,t,a){for(var r,l=!1,i=0,s=this._selection.length;s>i;i++)r=this._selection[i],r._recno_===e&&(l=!0,r[t]=a);a&&!l&&(r={_recno_:e},r[t]=!0,this._selection.push(r))}},jslet.data.GlobalDataHandler=function(){var e=this;e._datasetMetaChanged=null,e._fieldMetaChanged=null,e._fieldValueChanged=null},jslet.data.GlobalDataHandler.prototype={datasetCreated:function(e){var t=this;return void 0===e?t._datasetCreated:(jslet.Checker.test("globalDataHandler.datasetCreated",e).isFunction(),void(t._datasetCreated=e))},datasetMetaChanged:function(e){var t=this;return void 0===e?t._datasetMetaChanged:(jslet.Checker.test("globalDataHandler.datasetMetaChanged",e).isFunction(),void(t._datasetMetaChanged=e))},fieldMetaChanged:function(e){var t=this;return void 0===e?t._fieldMetaChanged:(jslet.Checker.test("globalDataHandler.fieldMetaChanged",e).isFunction(),void(t._fieldMetaChanged=e))},fieldValueChanged:function(e){var t=this;return void 0===e?t._fieldValueChanged:(jslet.Checker.test("globalDataHandler.fieldValueChanged",e).isFunction(),void(t._fieldValueChanged=e))}},jslet.data.globalDataHandler=new jslet.data.GlobalDataHandler,jslet.data.Dataset=function(e){var t=this;t._name=null,t._description=null,t._recordClass=jslet.global.defaultRecordClass,t._dataList=null,t._oriDataList=null,t._fields=[],t._oriFields=null,t._normalFields=[],t._recno=-1,t._filteredRecnoArray=null,t._unitConvertFactor=1,t._unitName=null,t._aborted=!1,t._status=0,t._proxyFields=null,t._fixedFilter=null,t._filter=null,t._filtered=!1,t._innerFilter=null,t._findCondition=null,t._innerFindCondition=null,t._innerFormularFields=null,t._bof=!1,t._eof=!1,t._igoreEvent=!1,t._logChanges=!0,t._auditLogEnabled=!0,t._modiObject=null,t._inputtingRecord={},t._lockCount=0,t._fixedIndexFields=null,t._innerFixedIndexFields=[],t._indexFields="",t._innerIndexFields=[],t._sortingFields=null,t._convertDestFields=null,t._innerConvertDestFields=null,t._masterDataset=null,t._masterField=null,t._detailDatasetFields=null,t._linkedControls=[],t._linkedLabels=[],t._silence=0,t._keyField=null,t._codeField=null,t._nameField=null,t._parentField=null,t._levelOrderField=null,t._selectField=null,t._contextRules=null,t._contextRuleEngine=null,t._contextRuleEnabled=!1,t._dataProvider=jslet.data.DataProvider?new jslet.data.DataProvider:null,t._queryCriteria=null,t._queryUrl=null,t._submitUrl=null,t._pageSize=500,t._pageNo=0,t._pageCount=0,t._ignoreFilter=!1,t._ignoreFilterRecno=0,t._fieldValidator=new jslet.data.FieldValidator,t._onFieldChanged=null,t._onFieldFocusing=null,t._isFireGlobalEvent=!0,t._onCheckSelectable=null,t._onDataQueried=null,t._onDataSubmitted=null,t._datasetListener=null,t._designMode=!1,t._autoShowError=!0,t._autoRefreshHostDataset=!1,t._readOnly=!1,t._aggradedValues=null,t._afterScrollDebounce=jslet.debounce(t._innerAfterScrollDebounce,30),t._calcAggradedValueDebounce=jslet.debounce(t.calcAggradedValue,100),t._onlyChangedSubmitted=!1,t.selection=new jslet.data.DataSelection(t),t._changeLog=new jslet.data.ChangeLog(t),t._dataTransformer=new jslet.data.DataTransformer(t),t._followedValues=null,t._focusedFields=null,t._canFocusFields=null,t._lastFindingValue=null,t._inContextRule=!1,t._aggradedFields=null,t._aggradingCount=0,this.name(e)},jslet.data.Dataset.className="jslet.data.Dataset",jslet.data.Dataset.prototype={className:jslet.data.Dataset.className,name:function(e){var t=this;if(void 0===e)return t._name;jslet.Checker.test("Dataset.name",e).required().isString(),e=jQuery.trim(e);var a=this._name;return a&&(jslet.data.dataModule.unset(a),jslet.data.datasetRelationManager.changeDatasetName(a,e)),jslet.data.dataModule.unset(e),jslet.data.dataModule.set(e,this),this._name=e,this},description:function(e){return void 0===e?this._description||this._name:(this._description=e,this)},recordClass:function(e){var t=this;return void 0===e?t._recordClass:(jslet.Checker.test("Dataset.recordClass",e).isString(),t._recordClass=e?e.trim():null,this)},clone:function(e,t){var a=this;e||(e=a._name+"_clone");var r=new jslet.data.Dataset(e);r._datasetListener=a._datasetListener,r._unitConvertFactor=a._unitConvertFactor,r._unitName=a._unitName,r._fixedFilter=a._fixedFilter,r._filter=a._filter,r._filtered=a._filtered,r._logChanges=a._logChanges,r._fixedIndexFields=a._fixedIndexFields,r._indexFields=a._indexFields,r._onlyChangedSubmitted=a._onlyChangedSubmitted;var l=a._keyField,i=a._codeField,s=a._nameField,n=a._parentField,o=a._levelOrderField,d=a._selectField;t&&(l=l&&t.indexOf(l)>=0?l:null,i=i&&t.indexOf(i)>=0?i:null,s=s&&t.indexOf(s)>=0?s:null,n=n&&t.indexOf(n)>=0?n:null,o=o&&t.indexOf(o)>=0?o:null,d=d&&t.indexOf(d)>=0?d:null),r._keyField=l,r._codeField=i,r._nameField=s,r._parentField=n,r._levelOrderField=o,r._selectField=d,r._contextRules=a._contextRules;for(var u,c,f=0,h=a._fields.length;h>f;f++)u=a._fields[f],c=u.name(),t&&t.indexOf(c)<0||r.addField(u.clone(c,r));return r},cloneRecord:function(e,t){for(var a,r,l,i,s=t||{},n=this.getNormalFields(),o=0,d=n.length;d>o;o++)if(r=n[o],a=r.name(),l=e[a],void 0!==l){if(l&&jslet.isArray(l)){i=[];for(var u=0,c=l.length;c>u;u++)i.push(l[u])}else i=l;s[a]=i}return jslet.data.FieldValueCache.removeCache(s),s},readOnly:function(e){var t=this;if(void 0===e)return t._readOnly;t._readOnly=!!e;for(var a,r=t.getNormalFields(),l=0,i=r.length;i>l;l++)a=r[l],a._fireMetaChangedEvent("readOnly");return this},onlyChangedSubmitted:function(e){return void 0===e?this._onlyChangedSubmitted:void(this._onlyChangedSubmitted=!!e)},pageSize:function(e){return void 0===e?this._pageSize:(jslet.Checker.test("Dataset.pageSize#pageSize",e).isGTZero(),this._pageSize=e,this)},pageNo:function(e){return void 0===e?this._pageNo:(jslet.Checker.test("Dataset.pageNo#pageNo",e).isGTZero(),this._pageNo=e,this)},pageCount:function(){return this._pageCount},masterDataset:function(e){return void 0===e?this._masterDataset?jslet.data.getDataset(this._masterDataset):null:(this._masterDataset=e,this)},masterField:function(e){return void 0===e?this._masterField:(jslet.Checker.test("Dataset.masterField",e).isString(),this._masterField=e,this)},getMasterFieldObject:function(){return this._masterField?this.masterDataset().getField(this._masterField):null},designMode:function(e){return void 0===e?this._designMode:(this._designMode=!!e,this)},autoShowError:function(e){return void 0===e?this._autoShowError:(this._autoShowError=!!e,this)},autoRefreshHostDataset:function(e){return void 0===e?this._autoRefreshHostDataset:(this._autoRefreshHostDataset=!!e,this)},unitConvertFactor:function(e,t){var a=this;if(0===arguments.length)return a._unitConvertFactor;jslet.Checker.test("Dataset.unitConvertFactor#factor",e).isGTZero(),jslet.Checker.test("Dataset.unitConvertFactor#unitName",t).isString(),e>0?a._unitConvertFactor=e:a._unitConvertFactor=1,a._unitName=t;for(var r,l=0,i=a._normalFields.length;i>l;l++)if(r=a._normalFields[l],r.getType()==jslet.data.DataType.NUMBER&&r.unitConverted()){var s=r.name();jslet.data.FieldValueCache.clearAll(a,s);var n=jslet.data.RefreshEvent.updateColumnEvent(s);a.refreshControl(n)}return a},datasetListener:function(e){return 0===arguments.length?this._datasetListener:(this._datasetListener=e,this)},onCheckSelectable:function(e){return void 0===e?this._onCheckSelectable:(this._onCheckSelectable=e,this)},onDataQueried:function(e){return void 0===e?this._onDataQueried:(this._onDataQueried=e,this)},onDataSubmitted:function(e){return void 0===e?this._onDataSubmitted:(this._onDataSubmitted=e,this)},fieldValidator:function(){return this._fieldValidator},onFieldChanged:function(e){return void 0===e?this._onFieldChanged:(this._onFieldChanged=e,this)},onFieldChange:function(e){return void 0===e?this._onFieldChanged:(this._onFieldChanged=e,this)},onFieldFocusing:function(e){return void 0===e?this._onFieldFocusing:(this._onFieldFocusing=e,this)},isFireGlobalEvent:function(e){return void 0===e?this._isFireGlobalEvent:(this._isFireGlobalEvent=!!e,this)},getFields:function(){return this._fields},getNormalFields:function(){return this._normalFields},getEditableFields:function(){for(var e,t=this._normalFields,a=[],r=0,l=t.length;l>r;r++)e=t[r],!e.visible()||e.disabled()||e.readOnly()||a.push(e.name());return a},setVisibleFields:function(e){if(e){jslet.isString(e)&&(e=e.split(",")),jslet.Checker.test("Dataset.setVisibleFields#fieldNameArray",e).isArray(),this._travelField(this._fields,function(e){return e.visible(!1),!1});for(var t=0,a=e.length;a>t;t++){var r=jQuery.trim(e[t]),l=this.getField(r);l&&l.visible(!0)}}},_travelField:function(e,t){if(t&&e){for(var a=!1,r=0,l=e.length;l>r;r++){var i=e[r];if(a=t(i))break;var s=i.children();if(s&&s.length>0&&(a=this._travelField(i.children(),t)))break}return a}},_cacheNormalFields:function(){var e=this._normalFields=[];this._travelField(this._fields,function(t){var a=t.children();return a&&0!==a.length||e.push(t),!1}),this._normalFields=e,this.calcFocusedFields()},addFields:function(e){jslet.Checker.test("Dataset.addFields#arrFldObj",e).required().isArray();for(var t=this,a=0,r=e.length;r>a;a++)t.addField(e[a],!0);t.refreshDisplayOrder(),t.refreshAggradedFields()},addField:function(e,t){function a(e){var t=e.children();if(!t||0===t.length)return void r.addInnerFormulaField(e.name(),e.formula());for(var l=0,i=t.length;i>l;l++)a(t[l])}jslet.Checker.test("Dataset.addField#fldObj",e).required().isClass(jslet.data.Field.className);var r=this,l=e.name();r.getField(l)&&r.removeField(l),e.dataset(r),r._fields.push(e);var i=e.displayOrder();i||e.displayOrder(r._fields.length-1);var s=e.dataType();return s==jslet.data.DataType.DATASET&&(r._detailDatasetFields||(r._detailDatasetFields=[]),r._detailDatasetFields.push(e)),s==jslet.data.DataType.PROXY&&(r._proxyFields||(r._proxyFields=[]),r._proxyFields.push(e)),r._cacheNormalFields(),a(e),t||(r.refreshDisplayOrder(),r.refreshAggradedFields()),r},addFieldFromDataset:function(e,t){jslet.Checker.test("Dataset.addFieldFromDataset#srcDataset",e).required().isClass(jslet.data.Dataset.className),jslet.Checker.test("Dataset.addFieldFromDataset#fieldNames",t).isArray();for(var a,r,l=this,i=e.getFields(),s=0,n=i.length;n>s;s++)a=i[s],r=a.name(),t&&t.indexOf(r)<0||this.addField(a.clone(r,this),!0);l.refreshDisplayOrder(),l.refreshAggradedFields()},refreshDisplayOrder:function(){this._fields.sort(jslet.data.displayOrderComparator),this._cacheNormalFields()},moveField:function(e,t){var a=this,r=a.getField(e),l=a.getField(t),i=r.parent(),s=l.parent();if(r&&l&&i==s){var n;n=i?i.children():a._fields;var o,d,u=(r.displayOrder(),l.displayOrder(),n.indexOf(r)),c=n.indexOf(l),f=a.designMode();a.designMode(!1);try{if(r.displayOrder(l.displayOrder()),c>u)for(d=u+1;c>=d;d++)o=n[d],o.displayOrder(o.displayOrder()-1);else for(d=c;u>d;d++)o=n[d],o.displayOrder(o.displayOrder()+1)}finally{a.designMode(f)}if(a.refreshDisplayOrder(),a.designMode()&&a.isFireGlobalEvent()){var h=jslet.data.globalDataHandler.fieldMetaChanged();h&&h.call(this,a,null,"displayOrder")}}},removeField:function(e){function t(e){var r=e.children();if(!r||0===r.length)return void a.removeInnerFormulaField(e.name());for(var l=0,i=r.length;i>l;l++)t(r[l])}jslet.Checker.test("Dataset.removeField#fldName",e).required().isString(),e=jQuery.trim(e);var a=this,r=a.getField(e);if(r){if(r.dataType()==jslet.data.DataType.DATASET){var l=a._detailDatasetFields.indexOf(r);l>=0&&a._detailDatasetFields.splice(l,1)}var i=a._fields.indexOf(r);a._fields.splice(i,1),r.dataset(null),a.removeInnerFormulaField(e),a._cacheNormalFields(),jslet.data.FieldValueCache.clearAll(a,e),t(r),a.refreshAggradedFields()}return a},refreshAggradedFields:function(){var e=this;e._aggradedFields=null;for(var t,a=e.getNormalFields(),r=[],l=0,i=a.length;i>l;l++)t=a[l],t.aggraded()&&r.push(t);r.length>0&&(e._aggradedFields=r)},getField:function(e){jslet.Checker.test("Dataset.getField#fldName",e).isString().required(),e=jQuery.trim(e);var t=e.split("."),a=t[0],r=null;if(this._travelField(this._fields,function(e){var t=!1;return e.name()==a&&(r=e,t=!0),t}),!r)return null;if(1==t.length)return r;t.splice(0,1);var l=r.lookup();if(l){var i=l.dataset();if(i)return i.getField(t.join("."))}else{var s=r.detailDataset();if(s)return s.getField(t.join("."))}return null},getTopField:function(e){jslet.Checker.test("Dataset.getField#fldName",e).isString().required(),e=jQuery.trim(e);var t=this.getField(e);if(t)for(;;){if(null===t.parent())return t;t=t.parent()}return null},sortFunc:function(e,t){var a,r,l,i,s=jslet.temp.sortDataset,n=s._sortingFields,o=[];for(l=0,i=n.length;i>l;l++)r=n[l],a=r.fieldName,(r.useTextToSort||s.getField(a).getType()===jslet.data.DataType.STRING)&&o.push(a);var d,u,c=1;for(l=0,i=n.length;i>l;l++)if(r=n[l],a=r.fieldName,r.useTextToSort?(d=s.getFieldTextByRecord(e,a),u=s.getFieldTextByRecord(t,a)):(d=s.getFieldValueByRecord(e,a),u=s.getFieldValueByRecord(t,a)),d!=u)return null!==d&&null!==u?o.indexOf(a)>=0?(d=d.toLowerCase(),u=u.toLowerCase(),c=d.localeCompare(u)<0?-1:1):c=u>d?-1:1:null===d&&null!==u?c=-1:null!==d&&null===u&&(c=1),c*r.order;return 0},fixedIndexFields:function(e){var t=this;if(void 0===e)return t._fixedIndexFields;jslet.Checker.test("Dataset.fixedIndexFields",e).isString(),t._fixedIndexFields=e,t._innerFixedIndexFields=e?t._parseIndexFields(e):[];for(var a,r,l=t._innerIndexFields.length-1;l>=0;l--){a=t._innerIndexFields[l];for(var i=0,s=t._innerFixedIndexFields.length;s>i;i++)r=t._innerFixedIndexFields[i],a.fieldName===r.fieldName&&t._innerIndexFields.splice(l,1)}return t._sortByFields(),this},indexFields:function(e){var t=this;if(void 0===e)return t._indexFields;if(jslet.Checker.test("Dataset.indexFields",e).isString(),e=jQuery.trim(e),!e&&!t._indexFields&&!t._fixedIndexFields)return this;t._indexFields=e,t._innerIndexFields=e?t._parseIndexFields(e):[];for(var a,r,l=t._innerIndexFields.length-1;l>=0;l--){a=t._innerIndexFields[l];for(var i=0,s=t._innerFixedIndexFields.length;s>i;i++)r=t._innerFixedIndexFields[i],a.fieldName===r.fieldName&&(r.order=a.order,t._innerIndexFields.splice(l,1))}return t._sortByFields(),this},mergedIndexFields:function(){var e,t,a=this,r=[];for(e=0,t=a._innerFixedIndexFields.length;t>e;e++)r.push(a._innerFixedIndexFields[e]);for(e=0,t=a._innerIndexFields.length;t>e;e++)r.push(a._innerIndexFields[e]);return r},toggleIndexField:function(e,t){var a,r,l=this,i=!1;for(r=l._innerFixedIndexFields.length-1;r>=0;r--)if(a=l._innerFixedIndexFields[r],a.fieldName===e){a.order=1===a.order?-1:1,i=!0;break}if(i)return t&&(l._innerIndexFields=[]),void l._sortByFields();for(i=!1,r=l._innerIndexFields.length-1;r>=0;r--)if(a=l._innerIndexFields[r],a.fieldName===e){a.order=1===a.order?-1:1,i=!0;break}i?t&&(l._innerIndexFields=[],l._innerIndexFields.push(a)):(t&&(l._innerIndexFields=[]),a={fieldName:e,order:1},l._innerIndexFields.push(a)),l._sortByFields()},_parseIndexFields:function(e){for(var t,a,r=e.split(","),l=1,i=[],s=0,n=r.length;n>s;s++)t=jQuery.trim(r[s]),a=t.split(" "),l=1==a.length?1:"asce"==a[1].toLowerCase()?1:-1,i.push({fieldName:a[0],order:l});return i},_sortByFields:function(){var e=this;if(e.hasRecord()){
e.selection.removeAll(),e._sortingFields=[];var t,a,r;for(a=0,r=e._innerFixedIndexFields.length;r>a;a++)t=e._innerFixedIndexFields[a],e._createIndexCfg(t.fieldName,t.order);for(a=0,r=e._innerIndexFields.length;r>a;a++)t=e._innerIndexFields[a],e._createIndexCfg(t.fieldName,t.order);if(0!==e._sortingFields.length){var l=e.getRecord(),i=e.isContextRuleEnabled();i&&e.disableContextRule(),e.disableControls(),jslet.temp.sortDataset=e;try{e.dataList().sort(e.sortFunc),e._refreshInnerRecno()}finally{jslet.temp.sortDataset=null,e.moveToRecord(l),i&&e.enableContextRule(),e.enableControls()}}}},_createIndexCfg:function(e,t){var a=this,r=e;if(jslet.isString(e)&&(r=a.getField(e)),r){if(r.dataset()!==a)return void a._combineIndexCfg(e,t);var l=r.children();if(l&&0!==l.length)for(var i=0,s=l.length;s>i;i++)a._createIndexCfg(l[i],t);else{var n=!0;"N"!==r.getType()||r.lookup()||(n=!1),a._combineIndexCfg(r.name(),t,n)}}},_combineIndexCfg:function(e,t,a){for(var r=0,l=this._sortingFields.length;l>r;r++)this._sortingFields[r].fieldName==e&&this._sortingFields.splice(r,1);var i={fieldName:e,order:t,useTextToSort:a};this._sortingFields.push(i)},_getWholeFilter:function(){var e=this,t=e._fixedFilter;if(t){if(e._filter)return"("+t+") && ("+e._filter+")"}else t=e._filter;return t},fixedFilter:function(e){var t=this;if(void 0===e)return t._fixedFilter;jslet.Checker.test("dataset.fixedFilter",e).isString(),e&&(e=jQuery.trim(e));var a=t._getWholeFilter();t._fixedFilter=e;var r=t._getWholeFilter();if(r){if(a==r)return this;t._innerFilter=new jslet.Expression(t,r)}else t._innerFilter=null,t._filtered=!1,t._filteredRecnoArray=null;return t._doFilterChanged(),this},filter:function(e){var t=this;if(void 0===e)return t._filter;jslet.Checker.test("dataset.filter#filterExpr",e).isString(),e&&(e=jQuery.trim(e));var a=t._getWholeFilter();t._filter=e;var r=t._getWholeFilter();if(r){if(a==r)return this;t._innerFilter=new jslet.Expression(t,r)}else t._innerFilter=null,t._filtered=!1,t._filteredRecnoArray=null;return t._doFilterChanged(),this},filtered:function(e){var t=this;if(void 0===e)return t._filtered;var a=t._getWholeFilter(),r=t._filtered;return e&&!a?t._filtered=!1:t._filtered=!!e,r==t._filtered?this:(this._doFilterChanged(),this)},_doFilterChanged:function(){var e=this;e.selection.removeAll(),e.disableControls();try{e._filtered?e._refreshInnerRecno():e._filteredRecnoArray=null,e.first(),e._calcAggradedValueDebounce.call(e)}finally{e.enableControls()}return e.refreshLookupHostDataset(),this},_filterData:function(){var e=this,t=e._getWholeFilter();if(!e._filtered||!t||e._status==jslet.data.DataSetStatus.INSERT||e._status==jslet.data.DataSetStatus.UPDATE)return!0;var a=e._innerFilter.eval();return a},_refreshInnerRecno:function(){var e=this;if(!e.hasData())return void(e._filteredRecnoArray=null);e._filteredRecnoArray=null;var t=[],a=e._recno;try{for(var r=0,l=e.dataList().length;l>r;r++)e._recno=r,e._filterData()&&t.push(r)}finally{e._recno=a}e._filteredRecnoArray=t},_innerAfterScrollDebounce:function(){var e=this,t=jslet.getFunction(e._datasetListener);t&&t.call(e,jslet.data.DatasetEvent.AFTERSCROLL)},_fireDatasetEvent:function(e){var t=this;if(!t._silence&&!t._igoreEvent&&t._datasetListener)if(e==jslet.data.DatasetEvent.AFTERSCROLL)t._afterScrollDebounce.call(t);else{var a=jslet.getFunction(t._datasetListener);a&&a.call(t,e)}},recordCount:function(){var e=this.dataList();return e?this._filteredRecnoArray?this._filteredRecnoArray.length:e.length:0},hasRecord:function(){return this.recordCount()>0},hasData:function(){var e=this.dataList();return e&&e.length>0},recno:function(e){var t=this;return void 0===e?t._recno:(jslet.Checker.test("dataset.recno#recno",e).isGTEZero(),e=parseInt(e),t.hasRecord()?e==t._recno?!0:(t.confirm(),t._gotoRecno(e),t._bof=t._eof=!1,!0):(t._bof=t._eof=!0,!0))},recnoSilence:function(e){var t=this;return void 0===e?t._recno:(t._recno=e,this)},_gotoRecno:function(e){var t=this,a=t.recordCount();if(0===a)return!1;if(e>=a?e=a-1:0>e&&(e=0),t._recno==e)return!1;var r;if(!t._silence){t._aborted=!1;try{if(t._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESCROLL),t._aborted)return!1}finally{t._aborted=!1}t._lockCount||(r=jslet.data.RefreshEvent.beforeScrollEvent(t._recno),t.refreshControl(r))}var l=t._recno;if(t._recno=e,t._recno!=l&&t._detailDatasetFields&&t._detailDatasetFields.length>0)for(var i,s,n=0,o=t._detailDatasetFields.length;o>n;n++)i=t._detailDatasetFields[n],s=i.detailDataset(),s&&s._initialize(!0);return t._refreshProxyField(null,t._silenc),t._contextRuleEnabled&&this.calcContextRule(),t._silence||(t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL),t._lockCount||(r=jslet.data.RefreshEvent.scrollEvent(t._recno,l),t.refreshControl(r))),!0},abort:function(){this._aborted=!0},aborted:function(){return this._aborted},_moveCursor:function(e){var t=this;t.confirm(),t._gotoRecno(e)},moveToRecord:function(e){var t=this;if(t.confirm(),!t.hasRecord()||!e)return!1;jslet.Checker.test("dataset.moveToRecord#recordObj",e).isObject();var a=t.dataList().indexOf(e);return 0>a?!1:t._filteredRecnoArray&&(a=t._filteredRecnoArray.indexOf(a),0>a)?!1:(t._gotoRecno(a),!0)},startSilenceMove:function(e){var t=this,a={};return e?a.recno=-999:a.recno=t._recno,t._silence++,a},endSilenceMove:function(e){var t=this;-999!=e.recno&&e.recno!=t._recno&&t._gotoRecno(e.recno),t._silence--},isBof:function(){return this._bof},isEof:function(){return this._eof},first:function(){var e=this;return e.hasRecord()?(e._moveCursor(0),void(e._bof=e._eof=!1)):void(e._bof=e._eof=!0)},next:function(){var e=this,t=e.recordCount();return 0===t?void(e._bof=e._eof=!0):e._recno==t-1?(e._bof=!1,void(e._eof=!0)):(e._bof=e._eof=!1,void e._moveCursor(e._recno+1))},prior:function(){var e=this;return e.hasRecord()?0===e._recno?(e._bof=!0,void(e._eof=!1)):(e._bof=e._eof=!1,void e._moveCursor(e._recno-1)):void(e._bof=e._eof=!0)},last:function(){var e=this;return e.hasRecord()?(e._bof=e._eof=!1,e._moveCursor(e.recordCount()-1),void(e._bof=e._eof=!1)):void(e._bof=e._eof=!0)},firstError:function(){return this._moveToError(0)},nextError:function(){return this._moveToError(this.recno()+1)},priorError:function(){return this._moveToError(this.recno()-1,!0)},lastError:function(){return this._moveToError(this.recordCount()-1,!0)},_moveToError:function(e,t){var a,r=this,l=r.recordCount()-1;if(0>l)return!1;if(t){for(e>l&&(e=l),a=e;a>=0;a--)if(r.existRecordError(a))return r._moveCursor(a),!0}else for(0>e&&(e=0),a=e;l>a;a++)if(r.existRecordError(a))return r._moveCursor(a),!0;return!1},checkStatusByCancel:function(){this._status!=jslet.data.DataSetStatus.BROWSE&&this.cancel()},insertChild:function(e){var t=this;if(!t._parentField||!t.keyField())throw new Error(jslet.locale.Dataset.parentFieldNotSet);if(!t.hasRecord())return void t.innerInsert();var a=t.startSilenceMove(!0);try{if(t.expanded(!0),e){if(!t.findByKey(e))return}else e=t.keyValue();for(var r=t.parentField(),l=t.getFieldValue(r);;){if(t.next(),t.isEof())break;if(l==t.getFieldValue(r)){t.prior();break}}}finally{t.endSilenceMove(a)}t.innerInsert(function(a){a[t._parentField]=e})},insertSibling:function(){var e=this;if(!e._parentField||!e._keyField)throw new Error(jslet.locale.Dataset.parentFieldNotSet);if(!e.hasRecord())return void e.innerInsert();var t,a=e.getFieldValue(e.parentField()),r=e.startSilenceMove(!0),l=!1,i=[],s=e.keyValue(),n=s;try{for(e.next();!e.isEof();){if(t=e.parentValue(),t==s)i.push(s),n=s;else if(n!=t&&i.indexOf(t)<0){e.prior(),l=!0;break}s=t,e.next()}l||e.last()}finally{e.endSilenceMove(r)}e.innerInsert(function(t){t[e._parentField]=a})},insertRecord:function(){this.innerInsert()},appendRecord:function(){var e=this;e._silence++;try{e.last()}finally{e._silence--}e.insertRecord()},status:function(e){return void 0===e?this._status:(this._status=e,this)},expanded:function(e){return this.expandedByRecno(this.recno(),e)},expandedByRecno:function(e,t){jslet.Checker.test("dataset.expandedByRecno",e).required().isNumber();var a=this.getRecord(e),r=jslet.data.getRecInfo(a);if(void 0===t){var l=r&&r.expanded;return!!l}return null===r?this:(r.expanded=t,this)},insertedByRecno:function(e,t){return void 0===t?this.changedStatusByRecno(e)===jslet.data.DataSetStatus.INSERT:(t?this.changedStatusByRecno(e,jslet.data.DataSetStatus.INSERT):this.changedStatusByRecno(e,jslet.data.DataSetStatus.BROWSE),this)},updatedByRecno:function(e,t){return void 0===t?this.changedStatusByRecno(e)===jslet.data.DataSetStatus.UPDATE:(t?this.changedStatusByRecno(e,jslet.data.DataSetStatus.UPDATE):this.changedStatusByRecno(e,jslet.data.DataSetStatus.BROWSE),this)},changedStatus:function(e){return void 0===e?this.changedStatusByRecno(this._recno,e):void this.changedStatusByRecno(this._recno,e)},changedStatusByRecno:function(e,t){var a,r,l=this;if(void 0===t)return(a=l.getRecord(e))?(r=jslet.data.getRecInfo(a),r?r.status:jslet.data.DataSetStatus.BROWSE):null;if(l._logChanges){if(a=l.getRecord(e),!a)return null;r=jslet.data.getRecInfo(a);var i=r.status;return t===jslet.data.DataSetStatus.DELETE?void(r.status=t):void(i!==jslet.data.DataSetStatus.INSERT&&i!=t&&(l._contextRuleEnabled&&l.calcContextRule(),r.status=t))}},innerInsert:function(e){var t=this;t.confirm(),t.selection.removeAll();var a=t.masterDataset();if(a){if(!a.hasRecord())throw new Error(jslet.locale.Dataset.insertMasterFirst);a.editRecord()}t._aborted=!1;try{if(t._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREINSERT),t._aborted)return}finally{t._aborted=!1}var r=t.dataList();null===r&&(r=[],t.dataList(r));var l,i=t.recno();l=t.hasRecord()?r.indexOf(this.getRecord())+1:0;var s={};if(r.splice(l,0,s),t._filteredRecnoArray&&t._filteredRecnoArray.length>0)for(var n=t._filteredRecnoArray.length-1;n>=0;n--){if(t._filteredRecnoArray[n]<l){t._filteredRecnoArray.splice(n+1,0,l),t._recno=l;break}t._filteredRecnoArray[n]+=1}else t._recno=l;t.status(jslet.data.DataSetStatus.INSERT),t.changedStatus(jslet.data.DataSetStatus.INSERT),t._lockCount++;try{t._calcDefaultValue(),e&&e(s),t._contextRuleEnabled&&t.calcContextRule(),t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERINSERT),t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL)}finally{t._lockCount--}var o=jslet.data.RefreshEvent.insertEvent(i,t.recno(),t._recno<t.recordCount()-1);t.refreshControl(o)},insertDataset:function(e){var t=this,a=t.filtered(),r=t.startSilenceMove(!0),l=e.startSilenceMove(!0);try{for(t.filtered(!1),e.first();!e.isEof();)t.insertRecord(),t.cloneRecord(e.getRecord(),t.getRecord()),t.confirm(),e.next()}finally{e.endSilenceMove(l),t.filtered(a),t.endSilenceMove(r)}},appendDataset:function(e){var t=this;t._silence++;try{t.last()}finally{t._silence--}t.insertDataset(e)},batchAppendRecords:function(e,t){jslet.Checker.test("dataset.records",e).required().isArray();var a=this;a.confirm(),a.selection.removeAll(),a.disableControls();try{for(var r,l,i,s=a.keyField(),n=0,o=e.length;o>n;n++)if(r=e[n],l=!1,s&&(i=r[s],i&&a.findByKey(i)&&(l=!0)),l){if(!t)continue;a.editRecord(),a.cloneRecord(r,a.getRecord()),a.confirm()}else a.appendRecord(),a.cloneRecord(r,a.getRecord()),a.confirm()}finally{a.enableControls(),a.refreshControl(jslet.data.RefreshEvent._updateAllEvent),a.refreshLookupHostDataset()}},_calcDefaultValue:function(){for(var e,t,a,r,l=this,i=0,s=l._normalFields.length;s>i;i++)if(e=l._normalFields[i],r=e.name(),e.getType()!=jslet.data.DataType.DATASET){if(e.valueFollow()&&l._followedValues){var n=l._followedValues[r];if(void 0!==n){e.setValue(n);continue}}if(a=e.defaultValue(),void 0===a||null===a||""===a){if(t=e.defaultExpr(),!t)continue;a=window.eval(t)}else e.getType()===jslet.data.DataType.NUMBER&&(a=e.scale()>0?parseFloat(a):parseInt(a));var o=e.valueStyle();a&&jslet.isDate(a)&&(a=new Date(a.getTime())),o==jslet.data.FieldValueStyle.BETWEEN?a=a?[a,a]:[null,null]:o==jslet.data.FieldValueStyle.MULTIPLE&&(a=[a]),l.setFieldValue(r,a)}},checkAggraded:function(e){var t=this,a=t._aggradedFields;if(!a||0===a.length)return!1;if(!e)return!0;for(var r=0,l=a.length;l>r;r++)if(a[r].name()===e)return!0;return!1},disableAggrading:function(){this._aggradingCount++},enableAggrading:function(){var e=this;e._aggradingCount>0&&(e._aggradingCount--,0===e._aggradingCount&&e._calcAggradedValueDebounce.call(e))},calcAggradedValue:function(e){function t(e){if(e.indexOf(",")<0)return l.getFieldValue(e);for(var t=e.split(","),a=[],r=0,i=t.length;i>r;r++)a.push(l.getFieldValue(t[r]));return a.join(",")}function a(e){for(var a,r,l,i=0,s=e.length;s>i;i++)a=e[i],l=a.values,r=t(a.aggradedBy),l[r]?a.exists=!0:(l[r]=null,a.exists=!1)}function r(e,t){for(var a,r=0,l=e.length;l>r;r++)if(a=e[r],a.aggradedBy==t)return a.exists;return console.warn("Not found aggradedBy value!"),!1}var l=this;if(!(l._aggradingCount>0)&&l.checkAggraded(e)){var i,s,n,o,d,u=l._aggradedFields,c=[],f=null,h=[];for(o=0,d=u.length;d>o;o++)i=u[o],s=i.aggradedBy(),n=i.getType()===jslet.data.DataType.NUMBER,(!n||n&&i.lookup())&&!s&&(f||(f={}),e=i.name(),f[e]={count:l.recordCount(),sum:0},h.push(e)),s&&-1===c.indexOf(s)&&c.push({aggradedBy:s,values:{},exists:!1});if(u.length===h.length)return void l.aggradedValues(f);f||(f={});var v,_,g=l.recnoSilence(),p=u.length;try{for(var j=0,F=l.recordCount();F>j;j++)for(l.recnoSilence(j),a(c),o=0;p>o;o++)if(i=u[o],e=i.name(),!(h.indexOf(e)>=0||(s=i.aggradedBy(),s&&r(c,s)||(_=f[e],_||(_={count:0,sum:0},f[e]=_),_.count=_.count+1,i.getType()!==jslet.data.DataType.NUMBER)))){if(v=l.getFieldValue(e)||0,jslet.isString(v))throw new Error(jslet.formatMessage(jslet.locale.Dataset.invalidNumberFieldValue,[e,v]));_.sum=_.sum+v}}finally{l.recnoSilence(g)}var y;for(o=0;p>o;o++){i=u[o],e=i.name(),y=i.scale()||0,_=f[e],_||(_={count:0,sum:0},f[e]=_);var m=_.sum;if(m){var C=Math.pow(10,y);m=Math.round(m*C)/C,_.sum=m}}l.aggradedValues(f)}},aggradedValues:function(e){var t=this;if(void 0===e)return t._aggradedValues;if(t._aggradedValues=e,t._aggradedValues||e){var a=jslet.data.RefreshEvent.aggradedEvent();t.refreshControl(a)}},getRecord:function(e){var t,a=this;if(void 0===e||null===e)e=a._recno>=0?a._recno:0;else if(0>e||e>=a.recordCount())return null;if(!a.hasData())return null;var r=a.dataList();return a._ignoreFilter?r[a._ignoreFilterRecno||0]:0===a.recordCount()?null:(t=a._filteredRecnoArray?a._filteredRecnoArray[e]:e,r[t])},getRelativeRecord:function(e){return this.getRecord(this._recno+e)},isSameAsPrevious:function(e){var t=this,a=t.getRelativeRecord(-1);if(!a)return!1;var r=t.getRecord(),l=t.getFieldValueByRecord(a,e),i=t.getFieldValueByRecord(r,e),s=!1;if(l||0===l||i||0===i?l&&i&&(s=jslet.isDate(l)?l.getTime()==i.getTime():l==i):s=!0,!s)return s;var n=t.getField(e),o=n.mergeSameBy();if(o)for(var d,u=o.split(","),c=0,f=u.length;f>c;c++)if(d=jQuery.trim(u[c]),a[d]!=r[d])return!1;return s},hasParent:function(){var e=this,t=e.parentField();if(!t||0===e.recno())return!1;for(var a=e.recno()-1,r=a;r>=0;r--){var l=e.getFieldValue(t),i=this.getRelativeRecord(r-a),s=this.getFieldValueByRecord(i,e.keyField());if(0===jslet.compareValue(l,s))return!0;var n=this.getFieldValueByRecord(i,e.parentField());if(0!==jslet.compareValue(l,n))return!1}return!1},hasChildren:function(){var e=this;return e._parentField?e._recno<e.recordCount()-1&&e.parentValue(e._recno+1)===e.keyValue():!1},iterateChildren:function(e){var t=this;if(t._parentField){var a=t.startSilenceMove(),r=t.keyValue(),l=r,i=[];try{t.next();for(var s,n;!t.isEof();){if(s=t.parentValue(),n=i.indexOf(s)>=0,0!==jslet.compareValue(s,r)||n||(i.push(r),n=!0),!n)return;if(e){var o=e.call(t,0===jslet.compareValue(s,l));if(o)break}r=t.keyValue(),t.next()}}finally{t.endSilenceMove(a)}}},editRecord:function(){var e=this;if(e._status!=jslet.data.DataSetStatus.UPDATE&&e._status!=jslet.data.DataSetStatus.INSERT)if(e.selection.removeAll(),e.hasRecord()){e._aborted=!1;try{if(e._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREUPDATE),e._aborted)return}finally{e._aborted=!1}e._modiObject={},jQuery.extend(e._modiObject,e.getRecord());var t=e.masterDataset();t&&t.editRecord(),e.status(jslet.data.DataSetStatus.UPDATE),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERUPDATE)}else e.insertRecord()},deleteRecord:function(){var e=this,t=e.recordCount();if(0!==t&&e.changedStatus()!==jslet.data.DataSetStatus.DELETE){if(e.selection.removeAll(),e._status==jslet.data.DataSetStatus.INSERT)return void e.cancel();e._silence++;try{e.checkStatusByCancel()}finally{e._silence--}if(e.hasChildren())return void jslet.showInfo(jslet.locale.Dataset.cannotDelParent);e._aborted=!1;try{if(e._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREDELETE),e._aborted)return}finally{e._aborted=!1}var a=e.recno(),r=a==t-1,l=e._recno;e.changedStatus()===jslet.data.DataSetStatus.INSERT?e._changeLog.unlog():(e.changedStatus(jslet.data.DataSetStatus.DELETE),e._changeLog.log()),e.dataList().splice(l,1),e._refreshInnerRecno();var i=e.masterDataset();if(i&&i.editRecord(),e.status(jslet.data.DataSetStatus.BROWSE),r){e._silence++;try{e.prior()}finally{e._silence--}}else e._refreshProxyField(),e._contextRuleEnabled&&this.calcContextRule();e._calcAggradedValueDebounce.call(e);var s=jslet.data.RefreshEvent.deleteEvent(a);e.refreshControl(s),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL),e.refreshLookupHostDataset();var n=e._detailDatasetFields;if(n)for(var o,d,u=0,c=n.length;c>u;u++)o=n[u],d=o.detailDataset(),d&&d.refreshControl();e.isBof()&&e.isEof()||(s=jslet.data.RefreshEvent.scrollEvent(e._recno),e.refreshControl(s))}},deleteSelected:function(){var e,t=this,a=t.selectedRecords();t.disableControls();try{for(var r=a.length-1;r>=0;r--)e=a[r],t.moveToRecord(e),t.deleteRecord()}finally{t.enableControls()}},_innerValidateData:function(){var e=this;if(e._status!=jslet.data.DataSetStatus.BROWSE&&0!==e.recordCount()){for(var t,a,r,l,i=null,s=0,n=e._normalFields.length;n>s;s++)if(t=e._normalFields[s],!t.disabled()&&!t.readOnly()&&t.visible())if(a=t.name(),r=e.getFieldValue(a),t.valueStyle()==jslet.data.FieldValueStyle.NORMAL&&e.existFieldError(a))l=e._fieldValidator.checkRequired(t,r),l=l||e._fieldValidator.checkValue(t,r),l&&(e.setFieldError(a,l),i||(i=a));else{if(l=e._fieldValidator.checkRequired(t,r),l&&(e.setFieldError(a,l),i||(i=a)),t.valueStyle()==jslet.data.FieldValueStyle.BETWEEN){var o=null,d=null;r&&2===r.length&&(o=r[0],d=r[1]),o&&d&&(l=null,(jslet.isDate(o)&&o.getTime()>d.getTime()||o>d)&&(l=jslet.locale.Dataset.betwwenInvalid),l&&(e.setFieldError(a,l,0),i||(i=a)))}if(r)for(var u=(e.getRecord(),0),c=r.length;c>u;u++)e.existFieldError(a,u)&&(l=l||e._fieldValidator.checkValue(t,r),l&&(e.setFieldError(a,l,u),i||(i=a)))}if(e._masterDataset&&e._masterField){var f=jslet.data.getDataset(e._masterDataset);f.getField(e._masterField);e.existRecordError()?f.addFieldError(e._masterField,jslet.formatMessage(jslet.locale.Dataset.detailDsHasError,[e.name()])):f.addFieldError(e._masterField,null)}i&&e.focusEditControl(i)}},errorMessage:function(e){var t=jslet.data.RefreshEvent.errorEvent(e||"");this.refreshControl(t)},addFieldError:function(e,t,a,r){jslet.data.FieldError.put(this.getRecord(),e,t,a,r)},addDetailFieldError:function(e,t){jslet.data.putDetailError.put(this.getRecord(),e,t)},existRecordError:function(e,t){return jslet.data.FieldError.existRecordError(this.getRecord(e),t)},getRecordErrorInfo:function(e,t){var a=this.getRecord(e);if(!this.existRecordError())return"";var r=jslet.data.getRecInfo(a);if(!r)return null;var l,i="",s=r.error;if(s)for(var n in s)if(!(t&&t.indexOf(n)<0)){var o=jslet.data.FieldError.get(a,n).message;o&&(l=this.getField(n),i&&(i+=", "),i+=o)}return i},checkAndShowError:function(e){var t=this;return t.existDatasetError(e)?(t._autoShowError?jslet.showError(jslet.locale.Dataset.cannotConfirm,function(){t.focusFirstErrorField()},2e3):(console.warn(jslet.locale.Dataset.cannotConfirm),t.focusFirstErrorField()),!0):!1},existDatasetError:function(e){var t=this,a=!1,r=t.dataList();if(!r)return!1;for(var l=0,i=r.length;i>l;l++)if(a=jslet.data.FieldError.existRecordError(r[l],e))return!0;return!1},confirm:function(){var e=this;if(e._status===jslet.data.DataSetStatus.BROWSE)return!0;var t=e.dataList();if(!t||0===t.length)return e._status=jslet.data.DataSetStatus.BROWSE,!0;e._fireDatasetEvent(jslet.data.DatasetEvent.BEFORECONFIRM),e._confirmDetailDataset(),e._innerValidateData(),e.status()===jslet.data.DataSetStatus.UPDATE&&e.changedStatus(jslet.data.DataSetStatus.UPDATE);var a,r=e.existRecordError();e.getRecord();e._modiObject=null,e.status(jslet.data.DataSetStatus.BROWSE),r||e._changeLog.log(),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERCONFIRM),e._calcAggradedValueDebounce.call(e),a=jslet.data.RefreshEvent.updateRecordEvent(),e.refreshControl(a),r?e.errorMessage(jslet.locale.Dataset.cannotConfirm):(jslet.data.FieldError.clearRecordError(e.getRecord()),e.errorMessage());var l=e.masterDataset();if(l){var i=e.masterField();r?l.addFieldError(i,jslet.formatMessage(jslet.locale.Dataset.detailDsHasError,[e.name()])):l.addFieldError(i,null),l.refreshControl(a)}return!r},_confirmDetailDataset:function(){var e,t,a,r=this,l=[],i=[];for(t=0,a=r._normalFields.length;a>t;t++)e=r._normalFields[t],e.getType()===jslet.data.DataType.DATASET&&(l.push(e.detailDataset()),i.push(e.name()));var s;for(t=0,a=l.length;a>t;t++)s=l[t],s&&(s.confirm(),s.existDatasetError()?r.addFieldError(i[t],jslet.formatMessage(jslet.locale.Dataset.detailDsHasError,[s.name()])):r.addFieldError(i[t],null))},cancel:function(){var e=this;if(e._status!=jslet.data.DataSetStatus.BROWSE&&0!==e.recordCount()){e._aborted=!1;try{if(e._fireDatasetEvent(jslet.data.DatasetEvent.BEFORECANCEL),e._aborted)return}finally{e._aborted=!1}e._cancelDetailDataset();var t,a=e._recno,r=e.dataList();if(e._status==jslet.data.DataSetStatus.INSERT){e.selection.removeAll();var l=e.recno();return r.splice(a,1),e._refreshInnerRecno(),l>=e.recordCount()&&(e._recno=e.recordCount()-1),e._refreshProxyField(),e._contextRuleEnabled&&this.calcContextRule(),e._calcAggradedValueDebounce.call(e),t=jslet.data.RefreshEvent.deleteEvent(l),e.refreshControl(t),e.status(jslet.data.DataSetStatus.BROWSE),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL),t=jslet.data.RefreshEvent.scrollEvent(e._recno),void e.refreshControl(t)}e._filteredRecnoArray&&(a=e._filteredRecnoArray[e._recno]),r[a]=e._modiObject,jslet.data.FieldValueCache.removeCache(e._modiObject),e._modiObject=null,e._refreshProxyField(),e._calcAggradedValueDebounce.call(e),e.status(jslet.data.DataSetStatus.BROWSE),e._fireDatasetEvent(jslet.data.DatasetEvent.AFTERCANCEL),t=jslet.data.RefreshEvent.updateRecordEvent(),e.refreshControl(t)}},_cancelDetailDataset:function(){var e,t,a,r=this,l=[];for(t=0,a=r._normalFields.length;a>t;t++)e=r._normalFields[t],e.getType()===jslet.data.DataType.DATASET&&l.push(e.detailDataset());var i;for(t=0,a=l.length;a>t;t++)i=l[t],i.cancel()},logChanges:function(e){return void 0===e?this._logChanges:(this._logChanges=e,this)},auditLogEnabled:function(e){return void 0===e?this._auditLogEnabled:(this.auditLogEnabled=!!e,this)},disableControls:function(){this._lockCount++;for(var e,t,a=0,r=this._normalFields.length;r>a;a++)e=this._normalFields[a],t=e.detailDataset(),null!==t&&t.disableControls()},enableControls:function(e){this._lockCount>0&&this._lockCount--,e||this.refreshControl();for(var t,a,r=0,l=this._normalFields.length;l>r;r++)t=this._normalFields[r],a=t.detailDataset(),null!==a&&a.enableControls()},existFieldError:function(e,t){if(0===this.recordCount())return!1;var a=this.getRecord();return a?jslet.data.FieldError.existFieldError(a,e,t):!1},getFieldError:function(e,t){return this.getFieldErrorByRecno(null,e,t)},getFieldErrorByRecno:function(e,t,a){if(0===this.recordCount())return null;var r=this.getRecord(e);return r?jslet.data.FieldError.get(r,t,a):null},setFieldError:function(e,t,a,r){var l=this;if(0===l.recordCount())return l;var i=l.getRecord();return i?(jslet.data.FieldError.put(i,e,t,a,r),this):l},getFieldValueByRecno:function(e,t,a){var r=this.getRecord(e);return r?this.getFieldValueByRecord(r,t,a):null},getFieldValueByRecord:function(e,t,a){var r=this;if(0===r.recordCount())return null;e||(e=r.getRecord()),r._refreshProxyField(e,!0);var l,i,s,n=t.indexOf("."),o=null,d=r.getField(t);if(n>0){l=t.substr(0,n),d=r.getField(l);var u=d.lookup(),c=d.detailDataset();if(!u&&!c)throw new Error(jslet.formatMessage(jslet.locale.Dataset.lookupNotFound,[l]));if(u)if(i=jslet.data.FieldRawValueAccessor.getRawValue(e,d),s=u.dataset(),i){if(!s.findByField(s.keyField(),i))throw new Error(jslet.formatMessage(jslet.locale.Dataset.valueNotFound,[s.name(),s.keyField(),i]));o=s.getFieldValue(t.substr(n+1))}else o=null;else o=c.getFieldValue(t.substr(n+1))}else{if(!d)throw new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNotFound,[t]));var f=d.formula();f&&void 0===e[t]?(o=r._calcFormula(e,t),jslet.data.FieldRawValueAccessor.setRawValue(e,d,o)):o=jslet.data.FieldRawValueAccessor.getRawValue(e,d)}return d.valueStyle()&&void 0!==a?jslet.getArrayValue(o,a):o},getFieldValue:function(e,t){if(0===this.recordCount())return null;var a=this.getRecord();return a?this.getFieldValueByRecord(a,e,t):null},setFieldValue:function(e,t,a){var r=this,l=r.getField(e);if(null===l)throw new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNotFound,[e]));r._status==jslet.data.DataSetStatus.BROWSE&&r.editRecord();var i=r._logOldEditValue(e),s=r.getRecord(),n=l.getType();if(l.valueStyle()&&void 0!==a){var o=jslet.data.FieldRawValueAccessor.getRawValue(s,l);o&&jslet.isArray(o)||(o=[]);var d=o.length;if(d>a)o[a]=t;else{for(var u=d;a>u;u++)o.push(null);o.push(t)}jslet.data.FieldRawValueAccessor.setRawValue(s,l,o)}else{if(t&&n===jslet.data.DataType.NUMBER&&!jslet.isArray(t)){var c=t;if(t=l.scale()>0?parseFloat(t):parseInt(t),window.isNaN(t))throw new Error(jslet.formatMessage(jslet.locale.Dataset.invalidNumberFieldValue,[e,c]))}if(jslet.data.FieldRawValueAccessor.setRawValue(s,l,t),l.getType()==jslet.data.DataType.DATASET)return this}if(r.setFieldError(e,null,a),r._onFieldChanged){var f=jslet.getFunction(r._onFieldChanged);f&&f.call(r,e,t,a)}if(r.isFireGlobalEvent()){var h=jslet.data.globalDataHandler.fieldValueChanged();h&&h.call(r,r,e,t,a)}l.valueFollow()&&(r._followedValues||(r._followedValues={}),r._followedValues[e]=t),r._refreshProxyField(s,!0),r._contextRuleEnabled&&r.calcContextRule(e),jslet.data.FieldValueCache.clear(s,e),r._logNewEditValue(e,i),r._updateLookupRelativeFields(l,t);var v=jslet.data.RefreshEvent.updateRecordEvent(e);return r.refreshControl(v),r.updateFormula(e),r._calcAggradedValueDebounce.call(r),this},_logOldEditValue:function(e){var t=this;if(!t._auditLogEnabled||!t._logChanges)return null;var a=t.changedStatus()||t._status;if(a!==jslet.data.DataSetStatus.UPDATE)return null;var r=t.getRecord(),l=r[jslet.global.auditLogField];l||(l={},r[jslet.global.auditLogField]=l);var i=l[e];i||(i={},l[e]=i);var s=i.o;return s||(i.o=t.getFieldText(e)),i},_logNewEditValue:function(e,t){t&&(t.n=this.getFieldText(e))},clearFollowedValues:function(){this._followedValues=null},calcFocusedFields:function(){var e,t=this;t._focusedFields=null;for(var a=0,r=t._normalFields.length;r>a;a++)e=t._normalFields[a],e.focused()&&(t._focusedFields||(t._focusedFields=[]),t._focusedFields.push(e.name()))},focusedFields:function(){return this._focusedFields},mergedFocusedFields:function(){var e=this._focusedFields,t=e,a=this._canFocusFields;if(e&&a)for(var r=e.length-1;r>=0;r--)a.indexOf(e[r])<0&&(t=e.slice(0),t.splice(r,1));return t},_updateLookupRelativeFields:function(e,t){if(t&&e.valueStyle()===jslet.data.FieldValueStyle.NORMAL){var a=e.lookup();if(a){var r=a.returnFieldMap();if(r){var l,i=a.dataset();if(0===jslet.compareValue(i.keyValue(),t)||i.findByKey(t)){var s=e.name();for(var n in r)s!=n&&(l=r[n],this.setFieldValue(n,i.getFieldValue(l)))}}}}},_calcFormulaRelation:function(){var e=this;if(e._innerFormularFields){for(var t,a,r=e._innerFormularFields.keys(),l=new jslet.SimpleMap,i=0,s=r.length;s>i;i++){t=r[i];var n=e._innerFormularFields.get(t);a=n.mainFields(),l.set(t,a)}e._innerFormulaRelation=l.count()>0?l:null}},addInnerFormulaField:function(e,t){var a=this;if(t){a._innerFormularFields||(a._innerFormularFields=new jslet.SimpleMap);var r=new jslet.Expression(a,t);a._innerFormularFields.set(e,r),a._calcFormulaRelation()}},removeInnerFormulaField:function(e){this._innerFormularFields&&(this._innerFormularFields.unset(e),this._calcFormulaRelation())},_calcFormula:function(e,t){var a=this,r=a._innerFormularFields.get(t),l=null;return r&&(r.context.dataRec=e,l=r.eval()),l},updateFormula:function(e){var t=this;if(t._innerFormulaRelation)for(var a,r,l,i=t._innerFormulaRelation.keys(),s=this.getRecord(),n=0,o=i.length;o>n;n++)if(a=i[n],r=t._innerFormulaRelation.get(a),l=t.getField(a),r&&0!==r.length){for(var d=!1,u=0,c=r.length;c>u;u++)if(r[u]==e){d=!0;break}d&&l.setValue(t._calcFormula(s,a))}else l.setValue(t._calcFormula(s,a))},getFieldText:function(e,t,a){if(0===this.recordCount())return null;var r=this.getRecord();return r?this.getFieldTextByRecord(r,e,t,a):null},getFieldTextByRecno:function(e,t,a,r){var l=this.getRecord(e);return l?this.getFieldTextByRecord(l,t,a,r):null},getFieldTextByRecord:function(e,t,a,r){var l=this;if(0===l.recordCount())return"";var i,s,n=e,o=t.indexOf("."),d=jslet.data.FieldError.get(n,t,r);if(d&&d.message){var u=d.inputText;if(void 0!==u&&null!==u)return u}if(l._refreshProxyField(n,!0),o>0){var c=t.substr(0,o);if(t=t.substr(o+1),i=l.getField(c),!i)throw new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNotFound,[t]));var f=i.lookup(),h=i.detailDataset();if(!f&&!h)throw new Error(jslet.formatMessage(jslet.locale.Dataset.lookupNotFound,[t]));if(f){if(s=n[c],null===s||void 0===s)return"";var v=f.dataset();if(v.findByField(v.keyField(),s))return t.indexOf(".")>0?v.getFieldValue(t):v.getFieldText(t,a,r);throw new Error(jslet.formatMessage(jslet.locale.Dataset.valueNotFound,[v.name(),v.keyField(),s]))}return h.getFieldText(t,a,r)}if(i=l.getField(t),!i)throw new Error(jslet.formatMessage(jslet.locale.Dataset.lookupNotFound,[t]));if(i.getType()==jslet.data.DataType.DATASET)return"";var _=i.valueStyle(),g=[];if(_==jslet.data.FieldValueStyle.BETWEEN&&void 0===r){var p=l.getFieldTextByRecord(n,t,a,0),j=l.getFieldTextByRecord(n,t,a,1);return a||p||j?(g.push(p),a?g.push(jslet.global.valueSeparator):g.push(jslet.locale.Dataset.betweenLabel),g.push(j),g.join("")):""}if(_==jslet.data.FieldValueStyle.MULTIPLE&&void 0===r){var F=l.getFieldValue(t),y=0;F&&jslet.isArray(F)&&(y=F.length-1);for(var m=0;y>=m;m++)g.push(l.getFieldTextByRecord(n,t,a,m)),y>m&&g.push(jslet.global.valueSeparator);return g.join("")}if(!a){var C=jslet.data.FieldValueCache.get(n,t,r);if(void 0!==C)return C}if(s=l.getFieldValueByRecord(n,t,r),null===s||void 0===s){var E=i.fixedValue();return E?E:""}var D=i.customValueConverter()||jslet.data.getValueConverter(i);if(!D)throw new Error("Can't find any field value converter!");var x=D.valueToText(i,s,a);return a||jslet.data.FieldValueCache.put(n,t,x,r),x},setFieldValueLength:function(e,t){if(e.valueStyle()){var a=this.getFieldValue(e.name());a&&jslet.isArray(a)&&(a.length=t)}},setFieldText:function(e,t,a){var r=this,l=r.getField(e);if(null===l)throw new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNotFound,[e]));var i=l.getType();if(i==jslet.data.DataType.DATASET)throw new Error(jslet.formatMessage(jslet.locale.Dataset.datasetFieldNotBeSetValue,[e]));var s=r._textToValue(l,t,a);void 0!==s&&r.setFieldValue(e,s,a)},_textToValue:function(e,t,a){var r,l=this;{if(e.valueStyle()!==jslet.data.FieldValueStyle.BETWEEN&&e.valueStyle()!==jslet.data.FieldValueStyle.MULTIPLE||void 0!==a){var i,s=e.name(),n=l._fieldValidator.checkInputText(e,t);if(n)return l.setFieldError(s,n,a,t),i=jslet.data.RefreshEvent.updateRecordEvent(s),void l.refreshControl(i);l.setFieldError(s,null,a);var o=e.customValueConverter()||jslet.data.getValueConverter(e);if(!o)throw new Error("Can't find any field value converter!");return r=o.textToValue(e,t,a),l.getFieldError(s,a)&&(i=jslet.data.RefreshEvent.updateRecordEvent(s),l.refreshControl(i)),r}jslet.isArray(t)||(t=t.split(jslet.global.valueSeparator));
for(var d=t.length,u=[],c=!1,f=0;d>f;f++)r=l._textToValue(e,t[f],f),void 0===r?c=!0:c||u.push(r);if(!c)return u}},keyValue:function(e){return this._keyField&&0!==this.recordCount()?this.getFieldValueByRecno(e,this._keyField):null},parentValue:function(e){return this._parentField&&0!==this.recordCount()?this.getFieldValueByRecno(e,this._parentField):null},find:function(e,t){var a=this;if(0===a.recordCount())return!1;if(a.confirm(),null===e)return a._findCondition=null,a._innerFindCondition=null,!1;if(e!=a._findCondition&&(a._innerFindCondition=new jslet.Expression(this,e)),a._innerFindCondition.eval())return!0;a._silence++;var r=-1,l=a._recno;try{for(t||a.first();!a.isEof();){if(a._innerFindCondition.eval()){r=a._recno;break}a.next()}}finally{a._silence--,a._recno=l}return r>=0?(a._gotoRecno(r),!0):!1},findByField:function(e,t,a,r,l){function i(e,t,a){return e?"first"==e?jslet.like(t,a+"%"):"any"==e?jslet.like(t,"%"+a+"%"):"last"==e?jslet.like(t,"%"+a):void 0:0===jslet.compareValue(t,a)}var s=this;s.confirm();var n=s._ignoreFilter?s.dataList():s.filteredDataList();if(!n||0===n.length)return!1;var o=e;jslet.isString(e)&&(o=e.split(","));var d,u,c,f=[],h=o.length;for(d=0;h>d;d++){if(u=o[d],c=s.getField(u),!c)throw new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNotFound,[u]));var v=!0;"N"!==c.getType()||c.lookup()||(v=!1),f[d]=v}var _,g,p,j=!s._ignoreFilter&&a?a:0,F=-1;for(d=j,p=n.length;p>d;d++){_=n[d];for(var y=0;h>y;y++)if(u=o[y],g=r&&f[y]?s.getFieldTextByRecord(_,u):s.getFieldValueByRecord(_,u),i(l,g,t)){if(F=d,s._ignoreFilter)return s._ignoreFilterRecno=d,!0;break}if(F>=0)break}return F>=0?(s._gotoRecno(F),!0):!1},findByKey:function(e){var t=this.keyField();return t?this.findByField(t,e):!1},lookup:function(e,t,a){return this.findByField(e,t)?this.getFieldValue(a):null},lookupByKey:function(e,t){return this.findByKey(e)?this.getFieldValue(t):null},inChildrenAndSelf:function(e,t,a){jslet.Checker.test("inchildren#fldName",e).required().isString(),jslet.Checker.test("inchildren#parentValue",t).required();var r=this.getFieldValue(e);return 0===jslet.compareValue(r,t)?!0:this.inChildren(e,t,a)},inChildren:function(e,t,a){jslet.Checker.test("inchildren#fldName",e).required().isString(),jslet.Checker.test("inchildren#parentValue",t).required();var r=this,l=r.getField(e);if(!l)throw new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNotFound,[e]));var i=l.lookup();if(!i)throw new Error(jslet.formatMessage(jslet.locale.Dataset.lookupFieldExpected,[e]));var s=i.dataset();if(jslet.Checker.test("inchildren#lookupDataset",s).required(),jslet.Checker.test("inchildren#lookupDataset.parentField",s.parentField()).required(),!s.findByKey(t))return!1;var n=r.getFieldValue(e),o=!1;return s.iterateChildren(function(e){var t=!1;return(!a||a&&e)&&0===jslet.compareValue(s.keyValue(),n)&&(t=!0,o=!0),t}),o},copyDataset:function(e){var t=this;if(0===t.recordCount())return null;var a=[];if(!e||!t._filtered)return t.dataList().slice(0);var r=t._recno,l=t._filtered;e||(t._filtered=!1),t._silence++;try{for(t.first();!t.isEof();)a.push(t.getRecord()),t.next()}finally{t._silence--,t._recno=r,e||(t._filtered=l)}return a},keyField:function(e){return void 0===e?this._keyField:(jslet.Checker.test("Dataset.keyField",e).isString(),this._keyField=jQuery.trim(e),this)},codeField:function(e){return void 0===e?this._codeField:(jslet.Checker.test("Dataset.codeField",e).isString(),this._codeField=jQuery.trim(e),this)},nameField:function(e){return void 0===e?this._nameField:(jslet.Checker.test("Dataset.nameField",e).isString(),this._nameField=jQuery.trim(e),this)},parentField:function(e){return void 0===e?this._parentField:(jslet.Checker.test("Dataset.parentField",e).isString(),this._parentField=jQuery.trim(e),this)},levelOrderField:function(e){return void 0===e?this._levelOrderField:(jslet.Checker.test("Dataset.levelOrderField",e).isString(),this._levelOrderField=jQuery.trim(e),this)},selectField:function(e){return void 0===e?this._selectField:(jslet.Checker.test("Dataset.selectField",e).isString(),this._selectField=jQuery.trim(e),this)},contextRules:function(e){if(void 0===e)return this._contextRules;if(jslet.isString(e)&&(e=e?jslet.JSON.parse(e):null),jslet.Checker.test("Dataset.contextRules",e).isArray(),e&&0!==e.length){for(var t,a=0,r=e.length;r>a;a++)t=e[a],t.className&&t.className==jslet.data.ContextRule.className||(jslet.Checker.test("Dataset.contextRules#ruleObj",t).isPlanObject(),e[a]=jslet.data.createContextRule(t));this._contextRules=e,this._contextRuleEngine=new jslet.data.ContextRuleEngine(this),this._contextRuleEngine.compile(),this.enableContextRule()}else this._contextRules=null,this._contextRuleEngine=null;return this},disableContextRule:function(){this._contextRuleEnabled=!1},enableContextRule:function(){this._contextRuleEnabled=!0,this.calcContextRule()},isContextRuleEnabled:function(){return this._contextRuleEnabled},calcContextRule:function(e){var t=this;if(0!==t.recordCount()&&t._contextRuleEngine){t._inContextRule=!0;try{t._contextRuleEngine.evalRule(e)}finally{t._inContextRule=!1}}},_refreshProxyField:function(e,t){var a=this;if(a._proxyFields&&0!==a.recordCount()){e||(e=a.getRecord());for(var r,l=0,i=a._proxyFields.length;i>l;l++)r=a._proxyFields[l],r.changeProxyFieldName(e,t)}},checkSelectable:function(e){if(0===this.recordCount())return!1;if(this._onCheckSelectable){var t=jslet.getFunction(this._onCheckSelectable);if(t)return t.call(this,e)}return!0},selected:function(e){var t=this,a=t._selectField||jslet.global.selectStateField,r=t.getRecord();if(void 0===e)return r&&r[a];if(r&&t.checkSelectable()){t._aborted=!1;try{if(t._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESELECT),t._aborted)return t}finally{t._aborted=!1}r[a]=e,t._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSELECT),this._contextRuleEngine&&this._contextRuleEngine.evalRule()}return t},selectedByRecno:function(e){var t=this,a=t._selectField||jslet.global.selectStateField,r=t.getRecord(e);return r&&r[a]},selectAll:function(e,t,a){var r=this;if(0!==r.recordCount()){try{if(r._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESELECTALL),r._aborted)return r}finally{r._aborted=!1}jslet.Checker.test("Dataset.selectAll#onSelectAll",t).isFunction();var l=r.recno();try{for(var i=0,s=r.recordCount();s>i;i++)r.recnoSilence(i),r.selected(e)}finally{r.recnoSilence(l)}if(t&&t(this,e),r._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSELECTALL),!a){var n=jslet.data.RefreshEvent.selectAllEvent(e);r.refreshControl(n)}}},selectByKeyValue:function(e,t,a){var r,l=this,i=l.recno(),s=l.recordCount(),n=[];try{for(var o=0;s>o;o++)if(l.recnoSilence(o),r=l.getFieldValue(l._keyField),r==t){l.selected(e),n.push(o);break}}finally{l.recnoSilence(i)}if(!a){var d=jslet.data.RefreshEvent.selectRecordEvent(n,e);l.refreshControl(d)}},select:function(e,t){var a=this;if(0!==a.recordCount()){var r=[];if(t){var l,i=t.split(","),s=[],n=i.length;for(l=0;n>l;l++)s[l]=a.getFieldValue(i[l]);var o,d,u=a.recno();try{for(var c=0,f=a.recordCount();f>c;c++){for(a.recnoSilence(c),d=1,l=0;n>l;l++)if(o=a.getFieldValue(i[l]),o!=s[l]){d=0;break}d&&(a.selected(e),r.push(a.recno()))}}finally{a.recnoSilence(u)}}else a.selected(e),r.push(a.recno());var h=jslet.data.RefreshEvent.selectRecordEvent(r,e);a.refreshControl(h)}},dataProvider:function(e){return void 0===e?this._dataProvider:(this._dataProvider=e,this)},_checkDataProvider:function(){if(!this._dataProvider)throw new Error("DataProvider required, use: yourDataset.dataProvider(yourDataProvider);")},selectedRecords:function(){var e=this;if(!e.hasRecord())return null;var t=e.recno(),a=[];try{for(var r=0,l=e.recordCount();l>r;r++)e.recnoSilence(r),e.selected()&&a.push(e.getRecord())}finally{e.recnoSilence(t)}return a},selectedKeyValues:function(){var e=this.recno(),t=[];try{for(var a=0,r=this.recordCount();r>a;a++){this.recnoSilence(a);var l=this.selected();l&&2!==l&&t.push(this.getFieldValue(this._keyField))}}finally{this.recnoSilence(e)}return t.length>0?t:null},queryUrl:function(e){return void 0===e?this._queryUrl:(jslet.Checker.test("Dataset.queryUrl",e).isString(),this._queryUrl=jQuery.trim(e),this)},query:function(e){if(e&&e instanceof jslet.data.Dataset){var t=e;if(t.confirm(),t.checkAndShowError())return jslet.emptyPromise;e=t.getRecord()}return this._queryCriteria=e,this.requery()},_doQuerySuccess:function(e,t){var a=t;if(!e)return a.dataList([]),void(e&&e.info&&jslet.showInfo(e.info));var r=e.main;r&&a.dataList(r);var l=e.extraEntities;if(l){var i,s;for(i in l)s=jslet.data.getDataset(i),s?s.dataList(l[i]):console.warn(i+" is returned from server, but this datase does not exist!")}e.pageNo&&(a._pageNo=e.pageNo),e.pageCount&&(a._pageCount=e.pageCount),a._onDataQueried&&a._onDataQueried.call(a);var n=jslet.data.RefreshEvent.changePageEvent();a.refreshControl(n),e&&e.info&&jslet.showInfo(e.info)},_doApplyError:function(e,t){var a=t,r=e.errorCode,l=e.errorMessage;if(jslet.global.serverErrorHandler){var i=jslet.global.serverErrorHandler(r,l);if(i)return}l=l+"["+r+"]",a.errorMessage(l),a._autoShowError&&jslet.showError(l)},requery:function(){var e=this;if(e._checkDataProvider(),!this._queryUrl)throw new Error(jslet.locale.Dataset.queryUrlRequired);if(!e._querying){e._querying=!0;try{var t={};e._pageNo>0&&(t.pageNo=e._pageNo,t.pageSize=e._pageSize);var a=e._queryCriteria;a&&(jslet.isArray(a)?t.criteria=a:t.simpleCriteria=a),e.csrfToken&&(t.csrfToken=e.csrfToken),t=jslet.data.record2Json(t);var r=e._queryUrl;return e._dataProvider.sendRequest(e,r,t).done(e._doQuerySuccess).fail(e._doApplyError).always(function(){e._querying=!1})}catch(l){e._querying=!1}}},_setChangedState:function(e,t,a){if(t&&0!==t.length)for(var r=this._addRecordClassFlag(t,e,this._recordClass||jslet.global.defaultRecordClass),l=0,i=r.length;i>l;l++)a.push(r[l])},_addRecordClassFlag:function(e,t,a){var r,l,i,s=this.getFields(),n=null;for(l=0,i=s.length;i>l;l++)r=s[l],r.getType()===jslet.data.DataType.DATASET&&(n||(n={}),n[r.name()]=r.detailDataset().recordClass());var o,d,u,c,f=[];for(l=0,c=e.length;c>l;l++){o=e[l],d={},a&&(d["@type"]=a),o[jslet.global.changeStateField]=t+l;var h;for(var v in o)h=o[v],h&&n&&(u=n[v],u&&(h=this._addRecordClassFlag(h,t,u))),d[v]=h;f.push(d)}return f},_doSaveSuccess:function(e,t){if(!e)return void(e&&e.info&&jslet.showInfo(e.info));var a=e.main,r=t;r._dataTransformer.refreshSubmittedData(a),r._calcAggradedValueDebounce.call(r),r.selection.removeAll(),r._onDataSubmitted&&r._onDataSubmitted.call(r),r.refreshControl(),r.refreshLookupHostDataset(),e&&e.info&&jslet.showInfo(e.info)},submitUrl:function(e){return void 0===e?this._submitUrl:(jslet.Checker.test("Dataset.submitUrl",e).isString(),this._submitUrl=jQuery.trim(e),this)},hasChangedData:function(e){var t=this;e||t.confirm();var a,r,l=t.dataList();if(!l)return!1;for(var i=0,s=l.length;s>i;i++)if(a=l[i],r=jslet.data.getRecInfo(a),r&&r.status&&r.status!==jslet.data.DataSetStatus.BROWSE)return!0;return!1},submit:function(e,t){var a=this;if(a.confirm(),a.checkAndShowError())return jslet.emptyPromise;if(a._checkDataProvider(),!a._submitUrl)throw new Error(jslet.locale.Dataset.submitUrlRequired);var r=a._dataTransformer.getSubmittingChanged();if(!r||0===r.length)return jslet.showInfo(jslet.locale.Dataset.noDataSubmit),jslet.emptyPromise;if(!a._submitting){a._submitting=!0;try{var l={main:r};e&&(l.extraInfo=e),a.csrfToken&&(l.csrfToken=a.csrfToken),l=jslet.data.record2Json(l,t);var i=a._submitUrl;return a._dataProvider.sendRequest(a,i,l).done(a._doSaveSuccess).fail(a._doApplyError).always(function(){a._submitting=!1})}catch(s){a._submitting=!1}}},_doSubmitSelectedSuccess:function(e,t){if(e){var a=e.main;if(!a||0===a.length)return void(e.info&&jslet.showInfo(e.info));var r,l,i,s=t,n=s._deleteOnSuccess_,o=s.selectedRecords()||[],d=s.dataList();if(s.selection.removeAll(),n){for(r=o.length;r>=0;r--)i=o[r],l=d.indexOf(i),d.splice(l,1);s._refreshInnerRecno()}else{s._dataTransformer.refreshSubmittedData(a)}s._calcAggradedValueDebounce.call(s),s._onDataSubmitted&&s._onDataSubmitted.call(s),s.refreshControl(),s.refreshLookupHostDataset(),e&&e.info&&jslet.showInfo(e.info)}},submitSelected:function(e,t,a,r){var l=this;if(l.confirm(),l.checkAndShowError())return jslet.emptyPromise;if(l._checkDataProvider(),jslet.Checker.test("Dataset.submitSelected#url",e).required().isString(),!l._submitting){l._submitting=!0;try{var i=l._dataTransformer.getSubmittingSelected()||[];l._deleteOnSuccess_=t;var s={main:i};return l.csrfToken&&(s.csrfToken=l.csrfToken),a&&(s.extraInfo=a),s=jslet.data.record2Json(s,r),l._dataProvider.sendRequest(l,e,s).done(l._doSubmitSelectedSuccess).fail(l._doApplyError).always(function(){l._submitting=!1})}catch(n){l._submitting=!1}}},_refreshInnerControl:function(e){var t,a,r;if(e.eventType==jslet.data.RefreshEvent.UPDATEALL||e.eventType==jslet.data.RefreshEvent.CHANGEMETA)for(a=this._linkedLabels.length,t=0;a>t;t++)r=this._linkedLabels[t],r.refreshControl&&r.refreshControl(e);for(a=this._linkedControls.length,t=0;a>t;t++)r=this._linkedControls[t],r&&r.refreshControl&&r.refreshControl(e)},focusEditControl:function(e){var t,a=this;if(!jslet.temp.focusing)for(var r=a._linkedControls.length-1;r>=0;r--)if(t=a._linkedControls[r],t.field&&t.field()==e){jslet.temp.focusing=!0;try{t.focus()}finally{jslet.temp.focusing=!1;break}}},focusFirstErrorField:function(){var e=jslet.data.FieldError.getFirstErrorField(this.getRecord());e&&this.focusEditControl(e)},refreshField:function(e){this.refreshControl(jslet.data.RefreshEvent.updateColumnEvent(e))},refreshLookupField:function(e){var t=jslet.data.RefreshEvent.lookupEvent(e);this.refreshControl(t)},refreshControl:function(e){this._lockCount||(e||(e=jslet.data.RefreshEvent.updateAllEvent()),this._refreshInnerControl(e))},addLinkedControl:function(e){if(e.isLabel)this._linkedLabels.push(e);else{this._linkedControls.push(e);var t=null;e.field&&(t=e.field()),t&&e.canFocus()&&(this._canFocusFields||(this._canFocusFields=[]),this._canFocusFields.push(t))}},removeLinkedControl:function(e){var t=e.isLabel?this._linkedLabels:this._linkedControls,a=t.indexOf(e);if(a>=0&&t.splice(a,1),!e.isLabel&&e.field){var r=e.field();r&&(a=this._canFocusFields.indexOf(r),a>=0&&this._canFocusFields.splice(a,1))}},refreshLookupHostDataset:function(){this._autoRefreshHostDataset&&jslet.data.datasetRelationManager.refreshLookupHostDataset(this._name)},handleLookupDatasetChanged:function(e){var t=this;t.refreshLookupField(e),t._inContextRule||jslet.data.FieldValueCache.clearAll(t,e)},innerExportTextArray:function(e,t){var a=this;a.confirm(),a.existDatasetError()&&console.warn(jslet.locale.Dataset.cannotConfirm);var r=!0,l=!1,i=null,s=null;e&&jQuery.isPlainObject(e)&&(void 0!==e.exportHeader&&(r=!!e.exportHeader),void 0!==e.onlySelected&&(l=!!e.onlySelected),void 0!==e.includeFields&&(i=e.includeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.includeFields",i).isArray()),void 0!==e.excludeFields&&(s=e.excludeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.excludeFields",s).isArray()));for(var n,o,d,u=[],c=a._normalFields.length,f=[],h=null,v=0;c>v;v++){if(o=a._normalFields[v],d=o.name(),i&&i.length>0){if(i.indexOf(d)<0)continue}else if(!o.visible())continue;s&&s.length>0&&s.indexOf(d)>=0||(t&&o.getType()===jslet.data.DataType.DATE&&(h||(h=[]),h.push(v)),f.push(o))}if(c=f.length,r){for(n=[],v=0;c>v;v++)o=f[v],d=o.label(),n.push(d);u.push(n)}var _,g,p=a.startSilenceMove(),j=/<\/?[^>]*>/g;try{for(a.first();!a.isEof();)if(!l||a.selected()){for(n=[],v=0;c>v;v++){if(o=f[v],d=o.name(),g=o.getType(),g!==jslet.data.DataType.NUMBER||o.lookup()){if(_=a.getFieldText(d),null!==_&&void 0!==_||(_=""),_&&g===jslet.data.DataType.STRING){var F=_.replace;F?_=F.call(_,j,""):_+=""}}else _=o.getValue(),null===_||void 0===_?_="":_+="";n.push(_)}u.push(n),a.next()}else a.next();return t?[u,h]:u}finally{a.endSilenceMove(p)}},exportTextArray:function(e){return this.innerExportTextArray(e)},exportCsv:function(e){var t=this.innerExportTextArray(e,!0),a=t[1];if(t=t[0],0===t.length)return"";var r=!0;void 0!==e.escapeDate&&(r=!!e.escapeDate);for(var l,i=t[0],s=i.length,n=",",o='"',d=!1,u=0,c=t.length;c>u;u++){i=t[u];for(var f=0;s>f;f++){if(l=i[f]){l=l.replace(/"/g,'""');var h=!1;l.startsWith("0")?h=!0:(d=!1,r&&a&&u>0&&a.indexOf(f)>=0&&(d=!0)),l=o+l+o,(h||d)&&(l="="+l)}else l='""';i[f]=l}t[u]=i.join(n)}return t.join("\n")},exportCsvFile:function(e,t){jslet.Checker.test("Dataset.exportCsvFile#fileName",e).required().isString();var a=this.exportCsv(t),r=document.createElement("a"),l=new window.Blob([a],{type:"text/csv"});r.href=window.URL.createObjectURL(l),r.download=e,r.click()},showImportDialog:function(){if(!jslet.ui.ImportDialog)return void console.warn("jslet.ui.ImportDialog not installed!");var e=this;e._importDialog||(e._importDialog=new jslet.ui.ImportDialog(e)),e._importDialog.show()},showExportDialog:function(e){if(!jslet.ui.ExportDialog)return void console.warn("jslet.ui.ExportDialog not installed!");var t=this;t._exportDialog||(t._exportDialog=new jslet.ui.ExportDialog(t)),t._exportDialog.show(e)},filteredDataList:function(){var e=this,t=[],a=e.recnoSilence();e.confirm();try{for(var r=0,l=e.recordCount();l>r;r++)e.recnoSilence(r),t.push(e.getRecord())}finally{e.recnoSilence(a)}return t},iterate:function(e,t,a){jslet.Checker.test("Dataset.iterate#callBackFn",e).required().isFunction();var r=this,l=[],i=r.startSilenceMove();try{t=t||0,0===a||a||(a=r.recordCount()-1);for(var s=t;a>=s&&(r.recno(s),!e||!e.call(r));s++);}finally{r.endSilenceMove(i)}return l},dataList:function(e){var t=this;if(void 0===e)return t._masterField?t.masterDataset().getFieldValue(t._masterField):t._dataList;jslet.Checker.test("Dataset.dataList",e).isArray(),t._masterField?(null===e&&(e=[]),t.masterDataset().setFieldValue(t._masterField,e)):t._dataList=e,t._initialize();var a=t._detailDatasetFields;if(a)for(var r,l,i=0,s=a.length;s>i;i++)r=a[i],l=r.detailDataset(),l&&(l.confirm(),l._initialize());return this},_initialize:function(e){var t=this;e||(jslet.data.FieldValueCache.removeAllCache(t),jslet.data.FieldError.clearDatasetError(t),t._changeLog.clear()),t.status(jslet.data.DataSetStatus.BROWSE),t._recno=-1,t._sortByFields(),t.filter(null),(t.filtered()||t.fixedFilter())&&t._doFilterChanged(),t.first(),t.refreshControl(jslet.data.RefreshEvent._updateAllEvent),t.refreshLookupHostDataset()},textList:function(){var e=this;e.confirm();var t,a,r,l,i=e.recno(),s=[],n=e._normalFields.length;try{for(var o=0,d=e.recordCount();d>o;o++){e.recnoSilence(o),l={};for(var u=0;n>u;u++)t=e._normalFields[u],a=t.name(),r=e.getFieldText(a),l[a]=r;s.push(l)}return s}finally{this.recnoSilence(i)}},exportSnapshot:function(){var e=this;if(0===e.dataList())return null;var t={name:e.name(),recno:e.recno(),status:e.status(),dataList:e.dataList(),changedRecords:e._changeLog._changedRecords},a=e.indexFields();a&&(t.indexFields=a);var r=e.filter();r&&(t.filter=r,t.filtered=e.filtered());var l,i={master:t},s=null,n=e._detailDatasetFields;if(n)for(var o,d,u=0,c=n.length;c>u;u++)o=n[u],d=o.detailDataset(),d&&(s||(s=[]),l={name:d.name(),recno:d.recno(),status:d.status()},a=d.indexFields(),a&&(d.indexFields=a),r=d.filter(),r&&(d.filter=r,d.filtered=d.filtered()),s.push(l));return s&&(i.details=s),i},importSnapshot:function(e){jslet.Checker.test("Dataset.importSnapshot#snapshot",e).required().isPlanObject();var t=e.master;jslet.Checker.test("Dataset.importSnapshot#snapshot.master",t).required().isPlanObject();var a=this,r=t.name;if(r!=a._name)throw new Error(jslet.formatMessage(jslet.locale.Dataset.cannotImportSnapshot,[r,a._name]));if(a._dataList=t.dataList,a._changeLog._changedRecords=t.changedRecords,void 0!==t.indexFields&&a.indexFields(t.indexFields),void 0!==t.filter&&(a.filter(t.filter),a.filtered(t.filtered)),t.recno>=0){a._silence++;try{a.recno(t.recno)}finally{a._silence--}}a.refreshControl();var l=e.details;if(l&&0!==l.length)for(var i,s,n=0,o=l.length;o>n;n++)if(i=l[n],s=jslet.data.getDataset(i.name)){if(void 0!==i.indexFields&&s.indexFields(i.indexFields),void 0!==i.filter&&(s.filter(i.filter),s.filtered(i.filtered)),i.recno>=0){s._silence++;try{s.recno(i.recno)}finally{s._silence--}}s.refreshControl()}},destroy:function(){var e=this;e._masterDataset=null,e._masterField=null,e._fields=null,e._linkedControls=null,e._innerFilter=null,e._innerFindCondition=null,e._sortingFields=null,e._innerFormularFields=null,e._aggradedFields=null,jslet.data.dataModule.unset(e._name),jslet.data.datasetRelationManager.removeDataset(e._name)}},jslet.data.createEnumDataset=function(e,t){jslet.Checker.test("createEnumDataset#enumStrOrObj",t).required();var a=new jslet.data.Dataset(e),r=jslet.data.createStringField("code",10);r.label(jslet.locale.EnumDataset.code),a.addField(r);var r=jslet.data.createStringField("name",20);r.label(jslet.locale.EnumDataset.name),a.addField(r),a.keyField("code"),a.codeField("code"),a.nameField("name");var l=[];if(jslet.isString(t))for(var i,s,n=jQuery.trim(t),o=n.split(","),d=0,u=o.length;u>d;d++)i=jQuery.trim(o[d]),s=i.split(":"),l[l.length]={code:jQuery.trim(s[0]),name:jQuery.trim(s[1])};else for(var c in t)l[l.length]={code:c,name:t[c]};return a.dataList(l),a.indexFields("code"),a},jslet.data.createDataset=function(e,t,a){function r(e){var t=a[e];void 0===t&&(t=a[e.toLowerCase()]),void 0!==t&&o[e](t)}function l(e){var t=a[e];void 0===t&&(t=a[e.toLowerCase()]),void 0!==t&&o[e](parseInt(t))}function i(e){var t=a[e];void 0===t&&(t=a[e.toLowerCase()]),void 0!==t&&(jslet.isString(t)&&t&&(t="0"!=t&&"false"!=t),o[e](!!t))}jslet.Checker.test("createDataset#fieldConfig",t).required().isArray(),jslet.Checker.test("Dataset.createDataset#datasetCfg",a).isPlanObject();for(var s,n,o=new jslet.data.Dataset(e),d=[],u=0,c=t.length;c>u;u++)n=t[u],jslet.Checker.test("Dataset.createDataset#fieldCfg",n).isPlanObject(),n.datasetName=e,s=jslet.data.createField(n),d.push(s);if(o.addFields(d),a&&(r("keyField"),r("codeField"),r("nameField"),r("parentField"),r("levelOrderField"),r("selectField"),r("recordClass"),r("description"),r("queryUrl"),r("submitUrl"),l("pageNo"),l("pageSize"),r("fixedIndexFields"),r("indexFields"),r("fixedFilter"),r("filter"),i("filtered"),i("autoShowError"),i("autoRefreshHostDataset"),i("readOnly"),i("logChanges"),i("auditLogEnabled"),i("isFireGlobalEvent"),r("datasetListener"),r("onFieldChange"),r("onFieldChanged"),r("onFieldChanging"),r("onCheckSelectable"),r("contextRules")),o.isFireGlobalEvent()){var f=jslet.data.globalDataHandler.datasetCreated();f&&f(o)}return o},jslet.data.ChangeLog=function(e){this._dataset=e,this._changedRecords=null},jslet.data.ChangeLog.prototype={changedRecords:function(e){return void 0===e?this._changedRecords:void(this._changedRecords=e)},log:function(e){if(this._dataset.logChanges()){e||(e=this._dataset.getRecord());var t=jslet.data.getRecInfo(e);if(t.status){var a=this._getChangedRecords();a.indexOf(e)<0&&a.push(e)}}},unlog:function(e){if(this._dataset.logChanges()){e||(e=this._dataset.getRecord());var t=this._getChangedRecords(e),a=t.indexOf(e);a>=0&&t.splice(a,1)}},clear:function(){this._changedRecords=null},_getChangedRecords:function(){var e,t=this._dataset,a=t.getMasterFieldObject();if(a){var r=a.name(),l=a.dataset(),i=jslet.data.getRecInfo(l.getRecord());i.detailLog||(i.detailLog={}),e=i.detailLog[r],e||(e=[],i.detailLog[r]=e)}else this._changedRecords||(this._changedRecords=[]),e=this._changedRecords;return e}},jslet.data.DataTransformer=function(e){this._dataset=e},jslet.data.DataTransformer.prototype={hasChangedData:function(){var e=this._dataset._changeLog._changedRecords;return!(!e||0===e.length)},getSubmittingChanged:function(){var e=this._dataset._changeLog._changedRecords;if(!e||0===e.length)return null;var t=this._convert(this._dataset,e);return t},getSubmittingSelected:function(){var e=this._dataset.selectedRecords();if(!e||0===e.length)return null;var t=this._convert(this._dataset,e,!0);return t},_convert:function(e,t,a){if(!t||0===t.length)return null;for(var r,l,i,s,n=e._recordClass||jslet.global.defaultRecordClass,o=[],d=0,u=t.length;u>d;d++){r=t[d],l=jslet.data.getRecInfo(r),i={},n&&(i["@type"]=n),s=l.detailLog,r[jslet.global.changeStateField]=this._getStatusPrefix(l.status)+d;var c,f;for(var h in r)if("_jl_"!==h)if(c=e.getField(h),c&&c.getType()===jslet.data.DataType.DATASET){var v=c.detailDataset();void 0===a&&(a=!v._onlyChangedSubmitted);var _=r[h];if(!a){var g=s?s[h]:null;if(g)for(var p,j,F=0,y=g.length;y>F;F++)p=g[F],j=jslet.data.getRecInfo(p),j&&j.status===jslet.data.DataSetStatus.DELETE&&_.push(p)}f=this._convert(v,_),f&&(i[h]=f)}else i[h]=r[h];o.push(i)}return o},_getStatusPrefix:function(e){return e===jslet.data.DataSetStatus.INSERT?"i":e===jslet.data.DataSetStatus.UPDATE?"u":e===jslet.data.DataSetStatus.DELETE?"d":"s"},refreshSubmittedData:function(e){e&&0!==e.length&&this._refreshDataset(this._dataset,e)},_refreshDataset:function(e,t,a){if(t&&0!==t.length){var r,l=e.getMasterFieldObject();if(l){var i=l.dataset().getRecord(),s=jslet.data.getRecInfo(i);r=s.detailLog?s.detailLog[l.name()]:null}else r=e._changeLog._changedRecords;for(var n,o=0,d=t.length;d>o;o++)n=t[o],n?this._refreshRecord(e,n,r):console.warn(jslet.locale.Dataset.serverReturnNullRecord)}},_refreshRecord:function(e,t,a){var r=t[jslet.global.changeStateField];if(r){var l,i;if(a&&"d"==r.charAt(0)){for(l=0,i=a.length;i>l;l++)if(r==a[l][jslet.global.changeStateField]){a.splice(l,1);break}}else{var s,n,o=e.dataList()||[];for(l=o.length-1;l>=0;l--)if(s=o[l],s[jslet.global.changeStateField]==r){for(var d in t)d&&(n=e.getField(d),n&&n.detailDataset()?this._refreshDataset(n.detailDataset(),t[d],!0):s[d]=t[d]);if(a)for(l=0,i=a.length;i>l;l++)if(r==a[l][jslet.global.changeStateField]){a.splice(l,1);break}s[jslet.global.changeStateField]=null;var u=s[jslet.global.auditLogField];u&&delete s[jslet.global.auditLogField];var c=jslet.data.getRecInfo(s);c&&c.status&&(c.status=0),jslet.data.FieldValueCache.removeCache(s)}}}}},jslet.Expression=function(e,t){if(jslet.Checker.test("jslet.Expression#dataset",e).required(),jslet.Checker.test("jslet.Expression#expr",t).required().isString(),this._fields=[],this._otherDatasetFields=[],this._expr=t,this._parsedExpr="","string"==typeof e){if(this._dataset=jslet.data.getDataset(e),!this._dataset)throw new Error(jslet.formatMessage(jslet.locale.Dataset.datasetNotFound,[e]))}else jslet.Checker.test("jslet.Expression#dataset",e).isClass(jslet.data.Dataset.className),this._dataset=e;this.context={mainds:e},this.parse()},jslet.Expression.prototype={_ParserPattern:/\[[_a-zA-Z][\.!\w]*(,\d){0,1}]/gim,parse:function(){var e,t,a,r,l,i,s,n=0,o=[],d=null;for(this._ParserPattern.lastIndex=0;null!==(i=this._ParserPattern.exec(this._expr));)if(r=i[0],r&&!r.endsWith("(")){if(a=null,r=r.substr(1,r.length-2),t=r.indexOf(","),t>0&&(d=parseInt(r.substr(t+1)),isNaN(d)&&(d=null),r=r.substr(0,t)),t=r.indexOf("!"),t>0&&(a=r.substr(0,t),r=r.substr(t+1)),e=i.index,s=this._dataset,a){if(l=jslet.data.dataModule.get(a),!l)throw new Error(jslet.formatMessage(jslet.locale.Dataset.datasetNotFound,[a]));this.context[a]=l,s=l}a?(o.push(this._expr.substring(n,e)),o.push("context."),o.push(a),o.push('.getFieldValue("'),this._otherDatasetFields.push({dataset:a,fieldName:r})):(o.push(this._expr.substring(n,e)),o.push('context.mainds.getFieldValueByRecord(context.dataRec, "'),this._fields.push(r)),o.push(r),o.push('"'),null!==d&&(o.push(","),o.push(d)),o.push(")"),n=e+i[0].length}o.push(this._expr.substr(n)),this._parsedExpr=o.join("")},mainFields:function(){return this._fields},otherDatasetFields:function(){return this._otherDatasetFields},eval:function(dataRec){var context=this.context;context.mainds=this._dataset,context.dataRec=dataRec;var like=jslet.like,between=jslet.between,inlist=jslet.inlist,inchildren=function(e,t,a){return context.mainds.inChildren(e,t,a)},inChildren=inchildren,inchildrenandself=function(e,t,a){return context.mainds.inChildrenAndSelf(e,t,a)},inChildrenAndSelf=inchildrenandself;return eval(this._parsedExpr)},destroy:function(){this._dataset=null,this._fields=null,this._otherDatasetFields=[],this._parsedExpr=null,this._expr=null,this.context=null}},jslet.data.Field=function(e,t){jslet.Checker.test("Field#fieldName",e).isString(),e=jQuery.trim(e),jslet.Checker.test("Field#fieldName",e).required(),jslet.Checker.test("Field#dataType",t).isString().required();var a=this;a._dataset=null,a._datasetName=null,a._displayOrder=0,a._tabIndex=null,a._fieldName=e,a._shortName=null,a._dataType=t,a._proxyHostFieldName=null,a._proxyFldObjs=null,a._proxyFieldChanged=null,a._currProxyFieldName=null,a._length=0,a._scale=0,a._unique=!1,a._defaultExpr=null,a._defaultValue=null,a._label=null,a._displayLabel=null,a._tip=null,a._message=null,a._displayWidth=0,a._editMask=null,a._displayFormat=null,a._dateFormat=null,a._formula=null,a._readOnly=!1,a._visible=!0,a._disabled=!1,a._unitConverted=!1,a._lookup=null,a._displayControl=null,a._editControl=null,a._detailDataset=null,a._urlExpr=null,a._innerUrlExpr=null,a._urlTarget=null,a._valueStyle=jslet.data.FieldValueStyle.NORMAL,a._valueCountLimit=0,a._required=!1,a._nullText=jslet.locale.Dataset.nullText,a._dataRange=null,a._regularExpr=null,a._antiXss=!0,a._customValueAccessor=null,a._customValueConverter=null,a._customValidator=null,a._validChars=null,a._dateChar=null,a._dateRegular=null,a._parent=null,a._children=null,a._trueValue=!0,a._falseValue=!1,a._trueText=null,a._falseText=null,a._mergeSame=!1,a._mergeSameBy=null,a._fixedValue=null,a._valueFollow=!1,a._focused=!1,a._aggraded=!1,a._aggradedBy=null,a._crossSource=null},jslet.data.Field.className="jslet.data.Field",jslet.data.Field.prototype={className:jslet.data.Field.className,dataset:function(e){var t=this;return void 0===e?t._parent?t._parent.dataset():t._dataset:(jslet.isString(e)?e=jslet.data.getDataset(e):jslet.Checker.test("Field.dataset",e).isClass(jslet.data.Dataset.className),e&&(t._datasetName=e.name()),t._removeRelation(),t._dataset=e,t._clearFieldCache(),t._addRelation(),this)},name:function(){return arguments.length>0&&console.error("Can't change field name!"),this._fieldName},shortName:function(e){var t=this;return void 0===e?t._shortName:(jslet.Checker.test("Field.shortName",e).isString(),t._shortName=e,this)},label:function(e){var t=this;return void 0===e?t._label||t._fieldName:(jslet.Checker.test("Field.label",e).isString(),t._label=e,t._fireMetaChangedEvent("label"),t._fireGlobalMetaChangedEvent("label"),this)},displayLabel:function(e){var t=this;return void 0===e?t._displayLabel||t.label():(jslet.Checker.test("Field.displayLabel",e).isString(),t._displayLabel=e,t._fireMetaChangedEvent("label"),t._fireGlobalMetaChangedEvent("label"),this)},fullLabel:function(e){if(!this.parent())return this.label();void 0===e&&(e="_");for(var t=[this.label()],a=this.parent();a;)t.push(a.label()),a=a.parent();return t.reverse().join(e)},tip:function(e){var t=this;return void 0===e?t._tip:(jslet.Checker.test("Field.tip",e).isString(),t._tip=e,t._fireMetaChangedEvent("tip"),t._fireGlobalMetaChangedEvent("tip"),this)},getType:function(){if(this._dataType==jslet.data.DataType.PROXY){var e=this._getProxyPropValue("dataType")||jslet.data.DataType.STRING;return e===jslet.data.DataType.Dataset?this._dataType:e}return this._dataType},dataType:function(e){if(void 0===e)return this._dataType;jslet.Checker.test("Field#dataType",e).isString().required();var t=e;return null===t?t=jslet.data.DataType.STRING:(t=t.toUpperCase(),t!=jslet.data.DataType.STRING&&t!=jslet.data.DataType.NUMBER&&t!=jslet.data.DataType.DATE&&t!=jslet.data.DataType.BOOLEAN&&t!=jslet.data.DataType.CROSS&&t!=jslet.data.DataType.PROXY&&t!=jslet.data.DataType.DATASET&&(t=jslet.data.DataType.STRING)),this._dataType=t,this},proxyHostFieldName:function(e){var t=this;return void 0===e?t._proxyHostFieldName:void(t._proxyHostFieldName=e)},proxyFieldChanged:function(e){var t=this;return void 0===e?t._proxyFieldChanged:(jslet.Checker.test("Field.proxyFieldChanged",e).required().isFunction(),t._proxyFieldChanged=e,this)},changeProxyFieldName:function(e,t){var a,r=this;
if(a=e[r._proxyHostFieldName],a&&r._currProxyFieldName!=a){r._proxyFldObjs||(r._proxyFldObjs={});var l=(r._proxyFldObjs[r._currProxyFieldName],r._proxyFldObjs[a]);l||(l=new jslet.data.Field(a,"S"),r._proxyFieldChanged.call(r._dataset,e,a,l),r._proxyFldObjs[a]=l),r._currProxyFieldName=a,t||r._fireMetaChangedEvent("editControl")}},_getProxyPropValue:function(e){if(!this._proxyFldObjs)return null;var t=this._proxyFldObjs[this._currProxyFieldName];return t?t[e]():null},_setProxyPropValue:function(e,t){if(this._proxyFldObjs){var a=this._proxyFldObjs[this._currProxyFieldName];a&&a[e](t)}},parent:function(e){var t=this;return void 0===e?t._parent:(jslet.Checker.test("Field.parent",e).isClass(this.className),t._parent=e,this)},children:function(e){var t=this;if(void 0===e)return t._children;jslet.Checker.test("Field.children",e).isArray();for(var a=0,r=e.length;r>a;a++)jslet.Checker.test("Field.children#childField",e[a]).isClass(this.className);return t._children=e,this},displayOrder:function(e){var t=this;return void 0===e?t._displayOrder:(jslet.Checker.test("Field.displayOrder",e).isNumber(),t._displayOrder=parseInt(e),t._fireGlobalMetaChangedEvent("displayOrder"),this)},tabIndex:function(e){var t=this;return void 0===e?t._tabIndex:(jslet.Checker.test("Field.tabIndex",e).isNumber(),t._tabIndex=parseInt(e),t._fireMetaChangedEvent("tabIndex"),t._fireGlobalMetaChangedEvent("tabIndex"),this)},length:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("length")||10:t._length||10:(jslet.Checker.test("Field.length",e).isGTEZero(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("length",parseInt(e)):t._length=parseInt(e),t._fireGlobalMetaChangedEvent("length"),this)},getEditLength:function(){var e=this,t=e.lookup(),a=e.length();if(t){var r=t.codeField(),l=t.nameField(),i=t.dataset();if(i&&r){var s=i.getField(r);return s&&(a=s.getEditLength()),l&&(s=i.getField(l),s&&(a=Math.max(a,s.getEditLength()))),a}}return e.getType()===jslet.data.DataType.NUMBER&&e.scale()>0?a+1:a>0?a:10},scale:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("scale")||0:t._scale:(jslet.Checker.test("Field.scale",e).isGTEZero(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("scale",parseInt(e)):t._scale=parseInt(e),t._fireGlobalMetaChangedEvent("scale"),this)},alignment:function(e){var t=this;if(void 0===e){var a=t._alignment;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("alignment")),a?a:t.lookup()?"left":t.getType()==jslet.data.DataType.NUMBER?"right":t.getType()==jslet.data.DataType.BOOLEAN?"center":"left"}return jslet.Checker.test("Field.alignment",e).isString(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("alignment",jQuery.trim(e)):t._alignment=jQuery.trim(e),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("alignment"),this},nullText:function(e){var t=this;return void 0===e?t._nullText:(jslet.Checker.test("Field.nullText",e).isString(),e=jQuery.trim(e),t._nullText=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("nullText"),this)},displayWidth:function(e){var t=this;return void 0===e?t._displayWidth<=0?t._length>0?t._length:12:t._displayWidth:(jslet.Checker.test("Field.displayWidth",e).isGTEZero(),t._displayWidth=parseInt(e),t._fireGlobalMetaChangedEvent("displayWidth"),this)},defaultExpr:function(e){var t=this;return void 0===e?t._defaultExpr:(jslet.Checker.test("Field.defaultExpr",e).isString(),t._defaultExpr=e,t._fireGlobalMetaChangedEvent("defaultExpr"),this)},displayFormat:function(e){var t=this;if(void 0===e){var a=t._displayFormat;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("displayFormat")),a?a:t.getType()==jslet.data.DataType.DATE?jslet.locale.Date.format:a}return jslet.Checker.test("Field.displayFormat",e).isString(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("displayFormat",jQuery.trim(e)):t._displayFormat=jQuery.trim(e),t._dateFormat=null,t._dateChar=null,t._dateRegular=null,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("displayFormat"),this},defaultValue:function(e){var t=this;return void 0===e?t._defaultValue:(jslet.Checker.test("Field.defaultValue",t.dftValue).isDataType(t._dateType),t._defaultValue=e,t._fireGlobalMetaChangedEvent("defaultValue"),this)},unique:function(e){var t=this;return void 0===e?t._unique:(t._unique=!!e,t._fireGlobalMetaChangedEvent("unique"),this)},required:function(e){var t=this;return void 0===e?t._required:(t._required=!!e,t._fireMetaChangedEvent("required"),t._fireGlobalMetaChangedEvent("required"),this)},editMask:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("editMask"):t._editMask:(e?jslet.isString(e)&&(e={mask:e,keepChar:!1}):e=null,t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("editMask",e):t._editMask=e,t._clearFieldCache(),t._fireMetaChangedEvent("editMask"),t._fireGlobalMetaChangedEvent("required"),this)},dateFormat:function(){var e=this;if(e._dateFormat)return e._dateFormat;if(this.getType()!=jslet.data.DataType.DATE)return null;var t=this.displayFormat().toUpperCase();e._dateFormat="";for(var a,r=0,l=t.length;l>r;r++)a=t.charAt(r),"YMD".indexOf(a)<0||e._dateFormat.indexOf(a)<0&&(e._dateFormat+=a);return e._dateFormat},dateSeparator:function(){var e=this;if(e._dateChar)return e._dateChar;if(this.getType()!=jslet.data.DataType.DATE)return null;for(var t,a=this.displayFormat().toUpperCase(),r=0,l=a.length;l>r;r++)if(t=a.charAt(r),"YMD".indexOf(t)<0)return e._dateChar=t,t},dateRegular:function(){var e=this;if(e._dateRegular)return e._dateRegular;for(var t,a=this.dateFormat(),r=this.dateSeparator(),l=["^"],i=0;i<a.length;i++)i>0&&(l.push("\\"),l.push(r)),t=a.charAt(i),"Y"==t?l.push("(\\d{4}|\\d{2})"):"M"==t?l.push("(0?[1-9]|1[012])"):l.push("(0?[1-9]|[12][0-9]|3[01])");return l.push("(\\s+\\d{2}:\\d{2}:\\d{2}(\\.\\d{3}){0,1}){0,1}"),l.push("$"),e._dateRegular={expr:new RegExp(l.join(""),"gim"),message:jslet.locale.Dataset.invalidDate},e._dateRegular},formula:function(e){var t=this;if(void 0===e)return t._formula;jslet.Checker.test("Field.formula",e).isString(),t._formula=jQuery.trim(e),t._clearFieldCache();var a=t.dataset();return a&&(a.removeInnerFormulaField(t._fieldName),a.addInnerFormulaField(t._fieldName,t._formula),t._fireColumnUpdatedEvent()),t._fireGlobalMetaChangedEvent("formula"),this},visible:function(e){var t=this;if(void 0===e){if(t._visible)for(var a=this.parent();a;){if(!a.visible())return!1;a=a.parent()}return t._visible}return t._visible=!!e,t._fireMetaChangedEvent("visible"),t._fireGlobalMetaChangedEvent("visible"),this},disabled:function(e){var t=this;return void 0===e?t._formula||t._dataType===jslet.data.DataType.DATASET||t._children?!1:t._disabled:(t._disabled=!!e,t._fireMetaChangedEvent("disabled"),t._fireGlobalMetaChangedEvent("disabled"),this)},readOnly:function(e){var t=this;if(void 0===e){if(t._dataType==jslet.data.DataType.DATASET)return!0;var a=t.children();return a&&0===a.length?!0:t._readOnly||t._dataset.readOnly()}return t._readOnly=!!e,t._fireMetaChangedEvent("readOnly"),t._fireGlobalMetaChangedEvent("readOnly"),this},fieldReadOnly:function(){var e=this;if(e._dataType==jslet.data.DataType.DATASET)return!0;var t=e.children();return t&&0===t.length?!0:e._readOnly},fieldDisabled:function(){return this._disabled},_fireGlobalMetaChangedEvent:function(e){var t=this.dataset();if(t&&t.designMode()&&t.isFireGlobalEvent()){var a=jslet.data.globalDataHandler.fieldMetaChanged();a&&a.call(this,t,this._fieldName,e)}},_fireMetaChangedEvent:function(e){var t=this.dataset();if(t){var a=jslet.data.RefreshEvent.changeMetaEvent(e,this._fieldName);t.refreshControl(a)}},_fireColumnUpdatedEvent:function(){var e=this.dataset();if(e){var t=jslet.data.RefreshEvent.updateColumnEvent(this._fieldName);e.refreshControl(t)}},unitConverted:function(e){var t=this;if(void 0===e)return t._dataType==jslet.data.DataType.NUMBER?t._unitConverted:!1;t._unitConverted=!!e;var a=this.dataset();return t._clearFieldCache(),t._dataType==jslet.data.DataType.NUMBER&&a&&1!=a.unitConvertFactor()&&t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("unitConverted"),this},valueStyle:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.DATASET||t._children&&t._children.length>0?jslet.data.FieldValueStyle.NORMAL:t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("valueStyle"):t._valueStyle:(e=e?parseInt(e):0,jslet.Checker.test("Field.valueStyle",e).isNumber().inArray([0,1,2]),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("valueStyle",e):t._valueStyle=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireMetaChangedEvent("valueStyle"),t._fireGlobalMetaChangedEvent("valueStyle"),this)},valueCountLimit:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("valueCountLimit"):t._valueCountLimit:(e?jslet.Checker.test("Field.valueCountLimit",e).isNumber():e=0,t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("valueStyle",parseInt(e)):t._valueCountLimit=parseInt(e),t._fireGlobalMetaChangedEvent("valueCountLimit"),this)},displayControl:function(e){var t=this;if(void 0===e){var a=t._displayControl;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("displayControl")),t.getType()!=jslet.data.DataType.BOOLEAN||a?a:{type:"dbcheckbox"}}return e=jslet.isString(e)?{type:e}:e,t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("displayControl",e):t._displayControl=e,t._fireGlobalMetaChangedEvent("displayControl"),this},editControl:function(e){var t=this;if(void 0===e){var a=t._editControl;if(t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("editControl")),a)return a;var r=t.getType();return r==jslet.data.DataType.BOOLEAN?{type:"dbcheckbox"}:r==jslet.data.DataType.DATE?{type:"dbdatepicker"}:t.lookup()?{type:"dbselect"}:{type:"dbtext"}}jslet.isString(e)&&(e=jQuery.trim(e),e=e?e.indexOf(":")>0?jslet.JSON.parse(e):{type:e}:null);var l=t._getProxyPropValue("editControl");return l&&e&&l.type==e.type?this:(t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("editControl",e):t._editControl=e,t._fireMetaChangedEvent("editControl"),t._fireGlobalMetaChangedEvent("editControl"),this)},_addRelation:function(){var e,t=this,a=t.lookup(),r=t._datasetName;if(r&&(t.getType()==jslet.data.DataType.DATASET||a)){var l,i=t._fieldName;if(t.getType()==jslet.data.DataType.DATASET){if(t._detailDataset){e=t._getDatasetName(t._detailDataset),l=jslet.data.DatasetType.DETAIL,jslet.data.datasetRelationManager.addRelation(r,i,e,l);var s=jslet.data.getDataset(t._detailDataset);s&&(s.masterDataset(r),s.masterField(i))}}else e=t._getDatasetName(a._dataset),l=jslet.data.DatasetType.LOOKUP,jslet.data.datasetRelationManager.addRelation(r,i,e,l)}},_removeRelation:function(){var e=this,t=e.lookup(),a=e._datasetName;if(a&&(e._detailDataset||t)){var r,l=e._fieldName;if(e._detailDataset){r=e._getDatasetName(e._detailDataset);var i=jslet.data.getDataset(e._detailDataset);i&&(i.masterDataset(null),i.masterField(null))}else r=e._getDatasetName(t._dataset);jslet.data.datasetRelationManager.removeRelation(a,l,r)}},lookup:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("lookup"):t._lookup:(jslet.Checker.test("Field.lookup",e).isClass(jslet.data.FieldLookup.className),t._removeRelation(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("lookup",e):t._lookup=e,e&&(e.hostField(t),t._addRelation()),t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireLookupChangedEvent(),this)},_fireLookupChangedEvent:function(){var e=this;if(e._dataset){var t=this.name(),a=jslet.data.RefreshEvent.lookupEvent(t,!0);this._dataset.refreshControl(a)}},_getDatasetName:function(e){return jslet.isString(e)?e:e.name()},subDataset:function(e){return this.detailDataset(e)},detailDataset:function(e){var t=this;if(void 0===e){if(t._detailDataset&&jslet.isString(t._detailDataset)&&(t.detailDataset(t._detailDataset),jslet.isString(t._detailDataset)))throw new Error(jslet.formatMessage(jslet.locale.Dataset.datasetNotFound,[t._detailDataset]));return t._detailDataset}if(t._removeRelation(),jslet.isString(e)){var a=jslet.data.getDataset(e);if(!a)return t._detailDataset=e,jslet.data.onCreatingDataset&&jslet.data.onCreatingDataset(e,jslet.data.DatasetType.DETAIL,null,t._datasetName),t._addRelation(),this;e=a}else jslet.Checker.test("Field.detailDataset",e).isClass(jslet.data.Dataset.className);return t._detailDataset=e,t._addRelation(),this},urlExpr:function(e){var t=this;return void 0===e?t._urlExpr:(jslet.Checker.test("Field.urlExpr",e).isString(),t._urlExpr=jQuery.trim(e),t._innerUrlExpr=null,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("urlExpr"),this)},urlTarget:function(e){var t=this;return void 0===e?t._urlTarget?t._urlTarget:jslet.data.Field.URLTARGETBLANK:(jslet.Checker.test("Field.urlTarget",e).isString(),t._urlTarget=jQuery.trim(e),t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("urlTarget"),this)},calcUrl:function(){var e=this;return this.dataset()&&e._urlExpr?(e._innerUrlExpr||(e._innerUrlExpr=new jslet.Expression(this.dataset(),e._urlExpr)),e._innerUrlExpr.eval()):null},antiXss:function(e){var t=this;return void 0===e?t._antiXss:(t._antiXss=!!e,t._fireGlobalMetaChangedEvent("antiXss"),this)},dataRange:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("dataRange"):t._dataRange:(e&&jslet.isString(e)&&(e=jslet.JSON.parse(e)),e&&(jslet.Checker.test("Field.dataRange",e).isObject(),e.min&&jslet.Checker.test("Field.dataRange.min",e.min).isDataType(t._dateType),e.max&&jslet.Checker.test("Field.dataRange.max",e.max).isDataType(t._dateType)),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("dataRange",e):t._dataRange=e,t._fireGlobalMetaChangedEvent("dataRange"),this)},regularExpr:function(e,t){var a=this,r=arguments.length;return 0===r?a._dataType==jslet.data.DataType.PROXY?a._getProxyPropValue("regularExpr"):a._regularExpr:(r>1&&(e={expr:e,message:t}),a._dataType==jslet.data.DataType.PROXY?a._setProxyPropValue("regularExpr",e):a._regularExpr=e,a._fireGlobalMetaChangedEvent("regularExpr"),this)},customValueAccessor:function(e){var t=this;return void 0===e?t._customValueAccessor:(t._customValueAccessor=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("customValueAccessor"),this)},customValueConverter:function(e){var t=this;return void 0===e?t._customValueConverter:(t._customValueConverter=e,t._clearFieldCache(),t._fireColumnUpdatedEvent(),t._fireGlobalMetaChangedEvent("customValueConverter"),this)},customValidator:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("customValidator"):t._customValidator:(e&&jslet.Checker.test("Field.customValidator",e).isFunction(),t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("customValidator",e):t._customValidator=e,t._fireGlobalMetaChangedEvent("customValidator"),this)},validChars:function(e){var t=this;if(void 0===e){var a=t._validChars;if(t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("validChars")),a)return a;if(t.getType()==jslet.data.DataType.NUMBER)return t._scale?"+-0123456789.":"+-0123456789";if(t.getType()==jslet.data.DataType.DATE){var r=t.displayFormat();e="0123456789";for(var l=0,i=r.length;i>l;l++){var s=r.charAt(l);"y"!==s&&"M"!==s&&"d"!==s&&"h"!==s&&"m"!==s&&"s"!==s&&(e+=s)}return e}return null}return t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("validChars",e):t._validChars=e,t._fireGlobalMetaChangedEvent("validChars"),this},trueValue:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("trueValue"):t._trueValue:(t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("trueValue",e):t._trueValue=e,this)},falseValue:function(e){var t=this;return void 0===e?t._dataType==jslet.data.DataType.PROXY?t._getProxyPropValue("falseValue"):t._falseValue:(t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("falseValue",e):t._falseValue=e,this)},trueText:function(e){var t=this;if(void 0===e){var a=t._trueText;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("trueText")),a||jslet.locale.Dataset.trueText}return t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("trueText",e):t._trueText=e,this},falseText:function(e){var t=this;if(void 0===e){var a=t._falseText;return t._dataType==jslet.data.DataType.PROXY&&(a=t._getProxyPropValue("falseText")),a||jslet.locale.Dataset.falseText}return t._dataType==jslet.data.DataType.PROXY?t._setProxyPropValue("falseText",e):t._falseText=e,this},mergeSame:function(e){var t=this;return void 0===e?t._mergeSame:(t._mergeSame=!!e,t._fireGlobalMetaChangedEvent("mergeSame"),this)},mergeSameBy:function(e){var t=this;return void 0===e?t._mergeSameBy:(jslet.Checker.test("Field.mergeSameBy",e).isString(),t._mergeSameBy=jQuery.trim(e),t._fireGlobalMetaChangedEvent("mergeSameBy"),this)},valueFollow:function(e){var t=this;return void 0===e?t._formula?!1:t._valueFollow:(t._valueFollow=!!e,!t._valueFollow&&t._dataset&&t._dataset.clearFollowedValues(),t._fireGlobalMetaChangedEvent("valueFollow"),this)},focused:function(e){var t=this;return void 0===e?t._focused:(t._focused=!!e,t._dataset&&t._dataset.calcFocusedFields(),t._fireGlobalMetaChangedEvent("focused"),this)},aggraded:function(e){var t=this;return void 0===e?t._aggraded:(t._aggraded=!!e,t._dataset&&t._dataset.refreshAggradedFields(),t._fireGlobalMetaChangedEvent("aggraded"),this)},aggradedBy:function(e){var t=this;return void 0===e?t._aggradedBy:(jslet.Checker.test("Field.aggradedBy",e).isString(),t._aggradedBy=jQuery.trim(e),t._fireGlobalMetaChangedEvent("aggradedBy"),this)},crossSource:function(e){var t=this;return void 0===e?t._crossSource:(jslet.Checker.test("Field.crossSource",e).isClass(jslet.data.CrossFieldSource.className),t._crossSource=e,this)},fixedValue:function(e){var t=this;return void 0===e?t._fixedValue:(jslet.Checker.test("Field.fixedValue",e).isString(),t._fixedValue=jQuery.trim(e),t._fireGlobalMetaChangedEvent("fixedValue"),this)},getValue:function(e){return this._dataset.getFieldValue(this._fieldName,e)},setValue:function(e,t){this._dataset.setFieldValue(this._fieldName,e,t)},getTextValue:function(e,t){return this._dataset.getFieldText(this._fieldName,e,t)},setTextValue:function(e,t){this._dataset.setFieldText(this._fieldName,e,t)},clone:function(e,t){var a=this;jslet.Checker.test("Field.clone#fldName",e).required().isString();var r=new jslet.data.Field(e,a._dataType);if(t=t||this.dataset(),r.dataset(t),r.visible(a._visible),a._parent&&r.parent(a._parent.clone(t)),a._children&&a._children.length>0){for(var l=[],i=0,s=a._children.length;s>i;i++)l.push(a._children[i].clone(t));r.children(l)}return r.length(a._length),r.scale(a._scale),r.alignment(a._alignment),r.defaultExpr(a._defaultExpr),r.defaultValue(a._defaultValue),r.label(a._label),r.displayLabel(a._displayLabel),r.shortName(a._shortName),r.tip(a._tip),r.displayWidth(a._displayWidth),a._editMask&&r.editMask(a._editMask.clone()),r.displayOrder(a._displayOrder),r.tabIndex(a._tabIndex),r.displayFormat(a._displayFormat),r.formula(a._formula),r.unique(a._unique),r.required(a._required),r.readOnly(a._readOnly),r.disabled(a._disabled),r.unitConverted(a._underted),a._lookup&&r.lookup(a._lookup.clone(t.name())),a._detailDataset&&r.detailDataset(a._subDataset),r.displayControl(a._displayControl),r.editControl(a._editControl),r.urlExpr(a._urlExpr),r.urlTarget(a._urlTarget),r.valueStyle(a._valueStyle),r.valueCountLimit(a._valueCountLimit),r.nullText(a._nullText),r.dataRange(a._dataRange),a._regularExpr&&r.regularExpr(a._regularExpr),r.antiXss(a._antiXss),r.customValidator(a._customValidator),r.customValueConverter(a._customValueConverter),r.customValueAccessor(a._customValueAccessor),r.validChars(a._validChars),r.mergeSame(a._mergeSame),r.mergeSameBy(a._mergeSameBy),r.fixedValue(a._fixedValue),r.valueFollow(a._valueFollow),r.focused(a._focused),r.aggraded(a._aggraded),r.aggradedBy(a._aggradedBy),r.trueValue(a._trueValue),r.falseValue(a._falseValue),r.trueText(a._trueText),r.falseText(a._falseText),r._addRelation(),r},_clearFieldCache:function(){var e=this;e._dataset&&e._fieldName&&jslet.data.FieldValueCache.clearAll(e._dataset,e._fieldName)}},jslet.data.Field.URLTARGETBLANK="_blank",jslet.data.createField=function(e,t){function a(e){var t=r[e];void 0!==t&&s[e](t)}jslet.Checker.test("createField#fieldConfig",e).required().isObject();var r=e,l=r.name;if(!l)throw console.error(r),new Error(jslet.formatMessage(jslet.locale.Dataset.fieldNameRequired));var i=r.type||r.dataType;null===i||void 0===i?i=jslet.data.DataType.STRING:(i=i.toUpperCase(),i!=jslet.data.DataType.STRING&&i!=jslet.data.DataType.NUMBER&&i!=jslet.data.DataType.DATE&&i!=jslet.data.DataType.BOOLEAN&&i!=jslet.data.DataType.CROSS&&i!=jslet.data.DataType.PROXY&&i!=jslet.data.DataType.DATASET&&(i=jslet.data.DataType.STRING));var s=new jslet.data.Field(r.shortName||l,i);if(e.datasetName&&(s._datasetName=e.datasetName),s.parent(t),t&&s.dataset(t.dataset()),r.crossSource){var n=jslet.data.createCrossFieldSource(r.crossSource);s.crossSource(n)}if(a("tabIndex"),a("displayOrder"),a("label"),a("displayLabel"),a("shortName"),a("tip"),i===jslet.data.DataType.PROXY)return jslet.Checker.test("Field.proxyHostFieldName",r.proxyHostFieldName).required().isString(),jslet.Checker.test("Field.proxyFieldChanged",r.proxyFieldChanged).required().isFunction(),a("proxyHostFieldName"),a("proxyFieldChanged"),s;if(i==jslet.data.DataType.DATASET){var o=r.detailDataset||r.subDataset||r.subdataset;if(!o)throw new Error(jslet.formatMessage(jslet.locale.Dataset.invalidDatasetField,[l]));return s.detailDataset(o),s.visible(!1),s}a("visible"),a("unique"),a("required"),a("readOnly"),a("disabled"),a("length"),a("scale"),a("alignment"),a("formula"),a("defaultExpr"),a("defaultValue"),a("displayWidth"),a("editMask"),a("displayFormat"),a("nullText"),a("unitConverted"),a("editControl"),a("urlExpr"),a("urlTarget"),a("valueStyle"),a("valueCountLimit"),a("dataRange"),a("customValidator"),a("customValueConverter"),a("customValueAccessor"),a("trueValue"),a("falseValue"),a("mergeSame"),a("mergeSameBy"),a("aggraded"),a("valueFollow"),a("focused"),a("aggradedBy"),a("mergeSameBy"),a("fixedValue"),a("antiXss"),a("validChars"),a("trueValue"),a("falseValue"),a("trueText"),a("falseText");var d=r.regularExpr,u=r.regularMessage;d&&s.regularExpr(d,u);var c=r.lookup;if(void 0===c){var f=r.lookupSource||r.lookupsource||r.lookupDataset||r.lookupdataset,h=r.lookupParam||r.lookupparam,v=r.realSource||r.realsource||r.realDataset||r.realdataset;f&&(c=h?jslet.isString(h)?jslet.JSON.parse(h):h:{},c.dataset=f,v&&(c.realDataset=v))}if(void 0!==c&&c&&(jslet.isString(c)&&(c=c.trim(),c&&(c=c.trim().startsWith("{")?jslet.JSON.parse(c):{dataset:c})),s.lookup(jslet.data.createFieldLookup(c,s._datasetName))),r.children){for(var _,g=[],p=0,j=r.children.length;j>p;p++)_=jslet.data.createField(r.children[p],s),_.displayOrder(p),g.push(_);s.children(g),s.alignment("center")}return s},jslet.data.createStringField=function(e,t,a){var r=new jslet.data.Field(e,jslet.data.DataType.STRING,a);return r.length(t),r},jslet.data.createNumberField=function(e,t,a,r){var l=new jslet.data.Field(e,jslet.data.DataType.NUMBER,r);return l.length(t),l.scale(a),l},jslet.data.createBooleanField=function(e,t){return new jslet.data.Field(e,jslet.data.DataType.BOOLEAN,t)},jslet.data.createDateField=function(e,t){var a=new jslet.data.Field(e,jslet.data.DataType.DATE,t);return a},jslet.data.createDatasetField=function(e,t,a){jslet.Checker.test("createDatasetField#detailDataset",t).required();var r=new jslet.data.Field(e,jslet.data.DataType.DATASET,a);return r.detailDataset(t),r.visible(!1),r},jslet.data.createCrossField=function(e,t,a){var r=new jslet.data.Field(e,jslet.data.DataType.CROSS,a);r.crossSource(t)},jslet.data.FieldLookup=function(){var e=this;e._hostDatasetName=null,e._hostField=null,e._dataset=null,e._realDataset=null,e._dsParsed=!1,e._keyField=null,e._codeField=null,e._nameField=null,e._codeFormat=null,e._displayFields=null,e._innerdisplayFields=null,e._parentField=null,e._onlyLeafLevel=!0,e._returnFieldMap=null,e._editFilter=null,e._editItemDisabled=!1},jslet.data.FieldLookup.className="jslet.data.FieldLookup",jslet.data.FieldLookup.prototype={className:jslet.data.FieldLookup.className,clone:function(e){var t=this,a=new jslet.data.FieldLookup;return a._hostDatasetName=e,a.dataset(t._dataset),a.keyField(t._keyField),a.codeField(t._codeField),a.nameField(t._nameField),a.displayFields(t._displayFields),a.parentField(t._parentField),a.onlyLeafLevel(t._onlyLeafLevel),a.returnFieldMap(t._returnFieldMap),a.editFilter(t._editFilter),a.editItemDisabled(t._editItemDisabled),a},hostField:function(e){var t=this;return void 0===e?t._hostField:(jslet.Checker.test("FieldLookup.hostField",e).isClass(jslet.data.Field.className),t._hostField=e,this)},_fireLookupChangedEvent:function(){var e=this;e._hostField&&e._hostField._fireLookupChangedEvent()},dataset:function(e){var t=this;if(void 0===e){if(!t._dsParsed&&(t.dataset(t._dataset),!t._dsParsed))throw new Error("Not found lookup dataset: "+t._dataset);return t._dataset}var a;if(e&&(a="string"==typeof e?e:e.name(),a==t._hostDatasetName))throw new Error(jslet.locale.Dataset.LookupDatasetNotSameAsHost);var r=e;return"string"==typeof r&&(r=jslet.data.getDataset(r),!r&&jslet.data.onCreatingDataset&&jslet.data.onCreatingDataset(e,jslet.data.DatasetType.LOOKUP,t._realDataset,t._hostDatasetName)),r?(t._dataset=r,t._dataset.autoRefreshHostDataset(!0),t._dsParsed=!0,t._fireLookupChangedEvent()):(t._dataset=e,t._dsParsed=!1),this},realDataset:function(e){var t=this;return void 0===e?t._realDataset:(jslet.Checker.test("FieldLookup.realDataset",e).isString(),t._realDataset=e,this)},keyField:function(e){var t=this;return void 0===e?t._keyField||t.dataset().keyField():(jslet.Checker.test("FieldLookup.keyField",e).isString(),t._keyField=jQuery.trim(e),t._fireLookupChangedEvent(),this)},codeField:function(e){var t=this;return void 0===e?t._codeField||t.dataset().codeField():(jslet.Checker.test("FieldLookup.codeField",e).isString(),t._codeField=jQuery.trim(e),t._fireLookupChangedEvent(),this)},codeFormat:function(e){var t=this;return void 0===e?t._codeFormat:(jslet.Checker.test("FieldLookup.codeFormat",e).isString(),t._codeFormat=jQuery.trim(e),t._fireLookupChangedEvent(),this)},nameField:function(e){var t=this;return void 0===e?t._nameField||t.dataset().nameField():(jslet.Checker.test("FieldLookup.nameField",e).isString(),t._nameField=jQuery.trim(e),t._fireLookupChangedEvent(),this)},parentField:function(e){var t=this;return void 0===e?t._parentField||t.dataset().parentField():(jslet.Checker.test("FieldLookup.parentField",e).isString(),t._parentField=jQuery.trim(e),t._fireLookupChangedEvent(),this)},displayFields:function(e){var t=this;return void 0===e?t._displayFields?t._displayFields:this.getDefaultDisplayFields():(jslet.Checker.test("FieldLookup.displayFields",e).isString(),e=jQuery.trim(e),t._displayFields!=e&&(t._displayFields=e,t._innerdisplayFields=null,t._hostField&&t._hostField._clearFieldCache()),t._fireLookupChangedEvent(),this)},returnFieldMap:function(e){return void 0===e?this._returnFieldMap:(jslet.Checker.test("FieldLookup.returnFieldMap",e).isObject(),void(this._returnFieldMap=e))},getDefaultDisplayFields:function(){var e="["+(this.nameField()||this.codeField()||this.keyField())+"]";return e},getCurrentDisplayValue:function(){var e=this;return null===e._displayFields&&this.displayFields(this.getDefaultDisplayFields()),e._innerdisplayFields||(e._innerdisplayFields=new jslet.Expression(e.dataset(),e.displayFields())),e._innerdisplayFields.eval()},onlyLeafLevel:function(e){var t=this;return void 0===e?t._onlyLeafLevel:(t._onlyLeafLevel=!!e,t._fireLookupChangedEvent(),this)},editFilter:function(e){var t=this;return void 0===e?t._editFilter:(jslet.Checker.test("FieldLookup.editFilter",e).isString(),t._editFilter!=e&&(t._editFilter=e),t._fireLookupChangedEvent(),this)},editItemDisabled:function(e){var t=this;return void 0===e?t._editItemDisabled:(t._editItemDisabled=!!e,t._fireLookupChangedEvent(),this)}},jslet.data.createFieldLookup=function(e,t){jslet.Checker.test("createFieldLookup#param",e).required().isObject();var a=e.dataset;if(!a)throw new Error("Property: dataset required!");var r=new jslet.data.FieldLookup;return r._hostDatasetName=t,void 0!==e.realDataset&&r.realDataset(e.realDataset),r.dataset(a),void 0!==e.keyField&&r.keyField(e.keyField),void 0!==e.codeField&&r.codeField(e.codeField),void 0!==e.nameField&&r.nameField(e.nameField),void 0!==e.codeFormat&&r.codeFormat(e.codeFormat),void 0!==e.displayFields&&r.displayFields(e.displayFields),void 0!==e.parentField&&r.parentField(e.parentField),void 0!==e.onlyLeafLevel&&r.onlyLeafLevel(e.onlyLeafLevel),void 0!==e.returnFieldMap&&r.returnFieldMap(e.returnFieldMap),void 0!==e.editFilter&&r.editFilter(e.editFilter),void 0!==e.editItemDisabled&&r.editItemDisabled(e.editItemDisabled),r},jslet.data.CrossFieldSource=function(){var e=this;e._sourceType=0,e._sourceField=null,e._lookupLevel=1,e._labels=null,e._values=null,e._matchExpr=null,e._hideEmptyValue=!1,e._hasSubtotal=!0,e._subtotalPosition=1,e._subtotalLabel=null},jslet.data.CrossFieldSource.className="jslet.data.CrossFieldSource",jslet.data.CrossFieldSource.prototype={className:jslet.data.CrossFieldSource.className,clone:function(){var e=this,t=new jslet.data.CrossFieldSource;return t.sourceType(e._sourceType),t.sourceField(e._sourceField),t.lookupLevel(e._lookupLevel),t.labels(e._labels),t.values(e._values),t.matchExpr(e._matchExpr),t.hideEmptyValue(e._hideEmptyValue),t.hasSubtotal(e._hasSubtotal),t.subtotalPosition(e._subtotalPosition),t.subtotalLabel(e._subtotalLabel),t},sourceType:function(e){var t=this;return void 0===e?t._sourceType:(jslet.Checker.test("CrossFieldSource.sourceType",e).isNumber(),t._sourceType=e,this)},sourceField:function(e){var t=this;return void 0===e?t._sourceField:(jslet.Checker.test("CrossFieldSource.sourceField",e).isString(),t._sourceField=e,this)},labels:function(e){var t=this;return void 0===e?t._labels:(jslet.Checker.test("CrossFieldSource.labels",e).isArray(),t._labels=e,this)},values:function(e){var t=this;return void 0===e?t._values:(jslet.Checker.test("CrossFieldSource.values",e).isArray(),t._values=e,this)},matchExpr:function(e){var t=this;return void 0===e?t._matchExpr:(jslet.Checker.test("CrossFieldSource.matchExpr",e).isString(),t._matchExpr=e,this)},hasSubtotal:function(e){var t=this;return void 0===e?t._hasSubtotal:(jslet.Checker.test("CrossFieldSource.hasSubtotal",e).isString(),t._hasSubtotal=e,this)},subtotalPosition:function(e){var t=this;return void 0===e?t._subtotalPosition:(jslet.Checker.test("CrossFieldSource.subtotalPosition",e).isNumber(),t._subtotalPosition=e,this)},subtotalLabel:function(e){var t=this;return void 0===e?t._subtotalLabel:(jslet.Checker.test("CrossFieldSource.subtotalLabel",e).isString(),t._subtotalLabel=e,this)}},jslet.data.createCrossFieldSource=function(e){var t=new jslet.data.CrossFieldSource,a=e.sourceType||0;return t.sourceType(a),void 0!==e.hasSubtotal&&t.hasSubtotal(e.hasSubtotal),void 0!==e.subtotalPosition&&t.subtotalPosition(e.subtotalPosition),void 0!==e.subtotalLabel&&t.subtotalLabel(e.subtotalLabel),0===a?t.sourceField(e.sourceField):(t.labels(e.labels),t.values(e.values),t.matchExpr(e.matchExpr)),t},jslet.data.FilterDataset=function(e){if(!jslet.data.getDataset("ds_logical_opr_")){var t=jslet.data.createEnumDataset("ds_logical_opr_",{and:jslet.locale.FilterDataset.and,or:jslet.locale.FilterDataset.or});t.isFireGlobalEvent(!1)}if(!jslet.data.getDataset("ds_operator_")){var a=[{name:"code",type:"S",length:10,label:"code"},{name:"name",
type:"S",length:30,label:"name"},{name:"range",type:"S",length:30,label:"range"}],r=jslet.data.createDataset("ds_operator_",a,{keyField:"code",codeField:"code",nameField:"name",autoRefreshHostDataset:!0,isFireGlobalEvent:!1});r.dataList([{code:"==",name:jslet.locale.FilterDataset.equal,range:"NDSB"},{code:"!=",name:jslet.locale.FilterDataset.notEqual,range:"NDS"},{code:">",name:jslet.locale.FilterDataset.greatThan,range:"ND"},{code:">=",name:jslet.locale.FilterDataset.greatThanAndEqual,range:"ND"},{code:"<",name:jslet.locale.FilterDataset.lessThan,range:"ND"},{code:"<=",name:jslet.locale.FilterDataset.lessThanAndEqual,range:"ND"},{code:"likeany",name:jslet.locale.FilterDataset.likeany,range:"S"},{code:"likefirst",name:jslet.locale.FilterDataset.likefirst,range:"S"},{code:"likelast",name:jslet.locale.FilterDataset.likelast,range:"S"},{code:"between",name:jslet.locale.FilterDataset.between,range:"NDS"},{code:"select",name:jslet.locale.FilterDataset.select,range:"LH"},{code:"selfchildren0",name:jslet.locale.FilterDataset.selfchildren0,range:"H"},{code:"children0",name:jslet.locale.FilterDataset.children0,range:"H"},{code:"selfchildren1",name:jslet.locale.FilterDataset.selfchildren1,range:"H"},{code:"children1",name:jslet.locale.FilterDataset.children1,range:"H"}])}this._hostDataset=e,this._filterDataset=null,this._varValues=null},jslet.data.FilterDataset.prototype={filterDataset:function(){function e(e,a,r){var l=jslet.data.getDataset(t._hostDataset).getField(a);if(r.dataType(l.dataType()),r.length(l.length()),r.scale(l.scale()),r.editMask(l.editMask()),r.displayFormat(l.displayFormat()),r.dateFormat(l.dateFormat()),r.displayControl(l.displayControl()),r.validChars(l.validChars()),l.lookup()){var i=l.lookup(),s=new jslet.data.FieldLookup;s.dataset(i.dataset()),s.keyField(i.keyField()),s.codeField(i.codeField()),s.nameField(i.nameField()),s.displayFields(i.displayFields()),s.parentField(i.parentField()),s.onlyLeafLevel(!1),r.lookup(s),r.editControl("DBComboSelect")}else{r.lookup(null);var n=l.editControl();0===jslet.compareValue(n.type,"DBTextArea")&&(n={type:"DBText"}),r.editControl(n)}var o=e.operator,d=jslet.data.FieldValueStyle.NORMAL;"between"==o?d=jslet.data.FieldValueStyle.BETWEEN:"select"==o&&(d=jslet.data.FieldValueStyle.MULTIPLE),r.valueStyle(d)}var t=this;if(t._filterDataset)return t._filterDataset;var a=jslet.nextId(),r=[{name:"name",type:"S",length:30,label:"Field Code"},{name:"label",type:"S",length:50,label:"Field Name"},{name:"dataType",type:"S",length:2,label:"Data Type"},{name:"parentName",type:"S",length:30,label:"Parent Field Code"}],l=jslet.data.createDataset("ds_fields_"+a,r,{keyField:"name",codeField:"name",nameField:"label",parentField:"parentName",autoRefreshHostDataset:!0,isFireGlobalEvent:!1}),i=[];t._appendFields(t._hostDataset,i),l.dataList(i);var s=[{name:"lParenthesis",type:"S",length:10,label:jslet.locale.FilterDataset.lParenthesis,validChars:"(",tabIndex:90980},{name:"hostField",type:"S",length:30,label:"Host Field",visible:!1},{name:"field",type:"S",length:200,displayWidth:30,label:jslet.locale.FilterDataset.field,tabIndex:90981,lookup:{dataset:l,onlyLeafLevel:!1},editControl:{type:"DBComboSelect",textReadOnly:!0},required:!0},{name:"dataType",type:"S",length:10,label:jslet.locale.FilterDataset.dataType,visible:!1},{name:"operator",type:"S",length:50,displayWidth:20,label:jslet.locale.FilterDataset.operator,lookup:{dataset:"ds_operator_"},required:!0,tabIndex:90982},{name:"value",type:"P",length:200,displayWidth:30,label:jslet.locale.FilterDataset.value,tabIndex:90983,proxyHostFieldName:"field",proxyFieldChanged:e,visible:!1},{name:"valueExpr",type:"S",length:30,visible:!1},{name:"valueExprInput",type:"S",length:2,label:" ",readOnly:!0,visible:!1,fixedValue:'<button class="btn btn-defualt btn-xs">...</button>',tabIndex:90984},{name:"rParenthesis",type:"S",length:10,label:jslet.locale.FilterDataset.rParenthesis,validChars:")",tabIndex:90985},{name:"logicalOpr",type:"S",length:10,label:jslet.locale.FilterDataset.logicalOpr,lookup:{dataset:"ds_logical_opr_"},required:!0,defaultValue:"and",tabIndex:90986}],n=jslet.data.createDataset("dsFilter_"+a,s,{isFireGlobalEvent:!1}),o={condition:"[field]",rules:[{field:"value",customized:function(e,a){var r=n.getFieldValue("field");if(r){var i,s=(n.getField("value",!0),jslet.data.getDataset(t._hostDataset).getField(r));if(s){var o=s.lookup();i=o?o.dataset().parentField()?"H":"L":s.getType()}else i=l.getFieldValue("dataType");a&&n.setFieldValue("dataType",i)}}}]},d={condition:"[dataType]",rules:[{field:"operator",customized:function(e,t){var a=n.getFieldValue("dataType");if(a){e=n.getField("operator");var r=e.lookup().dataset();if(r.filter('[range].indexOf("'+a+'") >= 0'),r.filtered(!0),r.first(),t){var l=r.getFieldValue("code");n.setFieldValue("operator",l)}}}}]},u={condition:"[operator]",rules:[{field:"value",customized:function(e,t){if(t){var a=n.getField("value").valueStyle(),r=n.getFieldValue("operator"),l=jslet.data.FieldValueStyle.NORMAL;"between"==r?l=jslet.data.FieldValueStyle.BETWEEN:"select"==r&&(l=jslet.data.FieldValueStyle.MULTIPLE),a!=l&&e.valueStyle(l)}}}]};return n.contextRules([o,d,u]),n.enableContextRule(),n.onFieldChanged(function(e,t){"field"!=e&&"operator"!=e||(this.setFieldValue("value",null),this.focusEditControl("value"))}),this._filterDataset=n,n},getFilterExprText:function(){var e=this,t=e._filterDataset;if(!t||0===t.recordCount())return null;this.validate();var a,r="",l=t.recordCount()-1;return t.iterate(function(){a=this.recno(),r+=this.getFieldValue("lParenthesis")||"",r+=this.getFieldText("field")+" ",r+=this.getFieldText("operator")+" ",r+=this.getFieldText("value"),r+=this.getFieldText("valueExpr"),r+=this.getFieldValue("rParenthesis")||"",a!=l&&(r+=" "+this.getFieldText("logicalOpr")+" ")}),r},getFilterExpr:function(){var e=this,t=e._filterDataset;if(!t||0===t.recordCount())return null;this.validate();var a,r="",l=t.recordCount()-1;return t.iterate(function(){a=this.recno();this.getFieldValue("dataType");r+=this.getFieldValue("lParenthesis")||"",r+=e._getFieldFilter(this),r+=this.getFieldValue("rParenthesis")||"",a!=l&&(r+=" "+("or"==this.getFieldValue("logicalOpr")?"||":"&&")+" ")}),r},_appendFields:function(e,t,a,r){for(var l,i=jslet.data.getDataset(e).getNormalFields(),s=0,n=i.length;n>s;s++)if(l=i[s],l.visible()&&!l.fixedValue()&&l.getType()!==jslet.data.Dataset.DATASET){var o=l.name(),d=l.label(),u=l.getType();a&&(o=a+"."+o,d=r+"."+d);var c={name:o,label:d,dataType:u};a&&(c.parentName=a),t.push(c),u===jslet.data.DataType.DATE&&(t.push({name:o+".Y",label:d+"."+jslet.locale.FilterDataset.year,dataType:"N",parentName:o}),t.push({name:o+".M",label:d+"."+jslet.locale.FilterDataset.month,dataType:"N",parentName:o}),t.push({name:o+".YM",label:d+"."+jslet.locale.FilterDataset.yearMonth,dataType:"N",parentName:o}));var f=l.lookup();f&&this._appendFields(f.dataset(),t,o,d)}},_getFieldFilter:function(e){function t(e,t){return"D"===e?"new Date("+t.getTime()+")":"S"===e?'"'+t+'"':t}var a=e.getFieldValue("field"),r=e.getFieldValue("dataType"),l=e.getFieldValue("operator"),i=e.getFieldValue("value"),s=(e.getFieldValue("valueExpr"),"");if("B"==r)return s="["+a+"]",i||(s="!"+s),s;var n="["+a+"]";if("N"===r&&(a.endsWith(".Y")?(n="["+a.substring(0,a.length-2)+"]",n="jslet.getYear("+n+")"):a.endsWith(".M")?(n="["+a.substring(0,a.length-2)+"]",n="jslet.getMonth("+n+")"):a.endsWith(".YM")&&(n="["+a.substring(0,a.length-3)+"]",n="jslet.getYearMonth("+n+")")),"=="==l||"!="==l||">"==l||">="==l||"<"==l||"<="==l)return s="jslet.compareValue("+n+", "+t(r,i)+")",s+=l+"0";if("between"==l){var o=i[0],d=null;return i.length>1&&(d=i[1]),null!==o&&void 0!==o&&(s+="jslet.compareValue("+n+", "+t(r,o)+") >=0"),null!==d&&void 0!==d&&(s.length>0&&(s+=" && "),s+="jslet.compareValue("+n+", "+t(r,d)+") <=0"),"("+s+")"}if("likeany"==l||"likefirst"==l||"likelast"==l)return s="like("+n+', "',"likeany"!=l&&"likelast"!=l||(s+="%"),s+=i,"likeany"!=l&&"likefirst"!=l||(s+="%"),s+='")';if("select"==l){r=this._hostDataset.getField(a).getType(),s="inlist("+n;for(var u=0,c=i.length;c>u;u++)s+=","+t(r,i[u]);return s+=")"}if("selfchildren0"==l||"children0"==l||"selfchildren1"==l||"children1"==l){var f="inChildren";return"selfchildren0"==l||"selfchildren1"==l?f="inChildrenAndSelf":s="inChildren",r=this._hostDataset.getField(a).getType(),s=f+'("'+a+'", '+t(r,i)+",",s+="selfchildren0"==l||"children0"==l?"false)":"true)"}return s},_getFilterValue:function(e){return e.getFieldValue("value")},validate:function(){var e=this._filterDataset,t=0,a=null;return e.iterate(function(){return t=(this.getFieldValue("lParenthesis")||"").length-(this.getFieldValue("rParenthesis")||"").length,null===this.getFieldValue("value")&&null===this.getFieldValue("valueExpr")?(a=jslet.locale.FilterDataset.valueRequired,!0):void 0}),a||0===t||(a=jslet.locale.FilterDataset.parenthesisNotMatched),a&&console.error(a),a},destroy:function(){var e=this._filterDataset.getField("field").lookup().dataset();this._filterDataset.destroy(),e.destroy()}},jslet.data||(jslet.data={}),jslet.data.ApplyAction={QUERY:"query",SAVE:"save",SELECTED:"selected"},jslet.data.DataProvider=function(){this.sendRequest=function(e,t,a){var r;if(jslet.global.beforeSubmit&&(r=jslet.global.beforeSubmit({url:t})),r||(r={}),r.type="POST",r.contentType="application/json",r.mimeType="application/json",r.dataType="json",r.data=a,r.context=e,e.csrfToken){var l=r.headers||{};l.csrfToken=e.csrfToken,r.headers=l}var i=jQuery.Deferred();return jQuery.ajax(t,r).done(function(e,t,a){if(e){e.csrfToken&&(this.csrfToken=e.csrfToken);var r=e.errorCode;if(r)return void i.reject(e,this)}i.resolve(e,this)}).fail(function(e,t,a){var r,l=e.responseJSON;if(l&&l.errorCode)r={errorCode:l.errorCode,errorMessage:l.errorMessage};else{var s=t,n=t;"error"==t&&(s="0000",n=jslet.locale.Common.ConnectError),r={errorCode:s,errorMessage:n}}i.reject(r,this)}).always(function(e,t,a){if(e&&jQuery.isFunction(e.done)){var r,l=e.responseJSON;r=l&&l.errorCode?{errorCode:l.errorCode,errorMessage:l.errorMessage}:{errorCode:t,errorMessage:a},i.always(r,this)}else i.always(e,this)}),i.promise()}},jslet.data||(jslet.data={}),jslet.data.XLSXXPorter={importData:function(e,t){function a(e){var t=[];if(e["!ref"]){var a,r=XLSX.utils.decode_range(e["!ref"]),l=r.s.r;for(a=r.s.c;a<=r.e.c;++a){var i=e[XLSX.utils.encode_cell({c:a,r:l})],s="UNKNOWN "+a;i&&i.t&&(s=XLSX.utils.format_cell(i)),t.push(s)}return t}}if(!XLSX)throw new Error("js-xlsx.js(https://github.com/SheetJS/js-xlsx) NOT loaded!");var r=XLSX.read(t,{type:"binary"}),l={};if(0===r.SheetNames.length)return null;var i=r.SheetNames[0],s=r.Sheets[i],n=a(s),o=XLSX.utils.sheet_to_row_object_array(s);return l.data=o,l.header=n,l},exportData:function(e,t,a){function r(e,t,a,r,l){var i=XLSX.utils.encode_cell({c:a,r:t}),s={t:r,v:l};e[i]=s}function l(e){for(var t=e.length,a=new ArrayBuffer(t),r=new Uint8Array(a),l=0;l!=t;++l)r[l]=255&e.charCodeAt(l);return a}if(!XLSX)throw new Error("js-xlsx.js(https://github.com/SheetJS/js-xlsx) NOT loaded!");e.confirm(),e.existDatasetError()&&console.warn(jslet.locale.Dataset.cannotConfirm);var i=!0,s=!1,n=null,o=null;a&&jQuery.isPlainObject(a)&&(void 0!==a.exportHeader&&(i=!!a.exportHeader),void 0!==a.onlySelected&&(s=!!a.onlySelected),void 0!==a.includeFields&&(n=a.includeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.includeFields",n).isArray()),void 0!==a.excludeFields&&(o=a.excludeFields,jslet.Checker.test("Dataset.exportCsv#exportOption.excludeFields",o).isArray()));var d,u,c,f,h=e.getNormalFields(),v=h.length,_=[];for(d=0;v>d;d++){if(u=h[d],c=u.name(),n&&n.length>0){if(n.indexOf(c)<0)continue}else if(!u.visible())continue;o&&o.length>0&&o.indexOf(c)>=0||_.push(u)}var g,p,j={},F=0,y=null,m=null;if(v=_.length,i){for(d=0;v>d;d++)u=_[d],r(j,F,d,"s",u.label());F++,y||(y={r:0,c:0}),g=0,p=v-1}var f,C,E=e.startSilenceMove(),D=/<\/?[^>]*>/g;try{for(e.first();!e.isEof();)if(!s||e.selected()){for(d=0;v>d;d++)if(u=_[d],f=u.getValue(),null!==f&&void 0!==f){if(c=u.name(),C=u.getType(),C!==jslet.data.DataType.NUMBER||u.lookup()){if(f=e.getFieldText(c),null===f||void 0===f)continue;if(f&&C===jslet.data.DataType.STRING){var x=f.replace;x?f=x.call(f,D,""):f+=""}r(j,F,d,"s",f)}else r(j,F,d,"n",f);y||(y={r:F,c:d}),g=F}F++,e.next()}else e.next();m={r:g,c:p}}finally{e.endSilenceMove(E)}j["!ref"]=XLSX.utils.encode_range({s:y,e:m});var R="Sheet1",S={SheetNames:[],Sheets:{}};S.SheetNames.push(R),S.Sheets[R]=j;var b={bookType:"xlsx",bookSST:!0,type:"binary"},T=XLSX.write(S,b);return saveAs(new Blob([l(T)],{type:"application/octet-stream"}),t),T}},jslet.data||(jslet.data={}),jslet.data.XPorter=function(){this._excelXPorter=null},jslet.data.XPorter.prototype={excelXPorter:function(e){return void 0===e?this._excelXPorter||jslet.data.XLSXXPorter:void(this._excelXPorter=e)}},jslet.data.defaultXPorter=new jslet.data.XPorter,jslet});
//# sourceMappingURL=jslet-data.min.js.map

if(!jslet.rootUri){var ohead=document.getElementsByTagName("head")[0],uri=ohead.lastChild.src;if(uri){uri=uri.substring(0,uri.lastIndexOf("/")+1);jslet.rootUri=uri}}jslet.global={version:"3.0.0",changeStateField:"rs",selectStateField:"_sel_",valueSeparator:",",defaultRecordClass:null,debugMode:true};jslet.global.serverErrorHandler=function(a,b){return false};if(window.jslet===undefined||jslet===undefined){jslet=window.jslet=function(b){var a=jQuery(b)[0];return(a&&a.jslet)?a.jslet:null}}jslet._AUTOID=0;jslet.nextId=function(){return"jslet"+(jslet._AUTOID++)};if(!jslet.data){jslet.data={}}if(!jslet.locale){jslet.locale={}}if(!jslet.temp){jslet.temp={}}if(!Array.indexOf){Array.prototype.indexOf=function(c){for(var b=0,a=this.length;b<a;b++){if(this[b]==c){return b}}return -1}}if(!Object.deepClone){}if(!String.prototype.trim){String.prototype.trim=function(){this.replace(/^\s+/,"").replace(/\s+$/,"")}}if(!String.prototype.startsWith){String.prototype.startsWith=function(a){return this.lastIndexOf(a,0)===0}}if(!String.prototype.endsWith){String.prototype.endsWith=function(a){var b=this.length-a.length;return b>=0&&this.indexOf(a,b)===b}}jslet.debounce=function(b,d,a){var c;return function(){var g=this,f=arguments;if(!d){b.apply(g,f);return}var e=function(){c=null;b.apply(g,f)};if(c){clearTimeout(c)}c=setTimeout(e,d)}};jslet.deepClone=function(a){var c;if(a.constructor==Object){c=new a.constructor()}else{c=new a.constructor(a.valueOf())}for(var b in a){if(c[b]!=a[b]){if(typeof(a[b])=="object"){c[b]=a[b].deepClone()}else{c[b]=a[b]}}}c.toString=a.toString;c.valueOf=a.valueOf;return c};jslet.SimpleMap=function(){var a=[],b=[];this.get=function(e){var c=a.length;for(var d=0;d<c;d++){if(e==a[d]){return b[d]}}return null};this.set=function(d,e){var c=a.indexOf(d);if(c>=0){b[c]=e}else{a.push(d);b.push(e)}};this.clear=function(){a.length=0;b.length=0};this.unset=function(e){var c=a.length;for(var d=0;d<c;d++){if(a[d]==e){a.splice(d,1);b.splice(d,1);return}}};this.count=function(){return a.length};this.keys=function(){return a}};jslet.formatString=function(g,c){jslet.Checker.test("jslet.formatString#msg",g).required().isString();if(c===undefined||c===null){return g}if(c===false){c="false"}if(c===true){c="true"}var a=g,e,d;if(jslet.isArray(c)){e=c.length;for(d=0;d<e;d++){a=a.replace("{"+d+"}",c[d])}}else{if(c.keys){var b=c.keys(),f;e=b.length;for(d=0;d<e;d++){f=b[d];a=a.replace("{"+f+"}",c.get(f))}}else{return g.replace("{0}",c)}}return a};jslet._SCALEFACTOR="100000000000000000000000000000000000";jslet.formatNumber=function(h,s){if(!s){return h}if(!h&&h!==0){return""}var a="",u,r;for(r=0;r<s.length;r++){u=s.substr(r,1);if(u=="#"||u=="0"||u==","){if(r>0){a=s.substr(0,r);s=s.substr(r)}break}}var e="";for(r=s.length-1;r>=0;r--){u=s.substr(r,1);if(u=="#"||u=="0"||u==","){if(r>0){e=s.substr(r+1);s=s.substr(0,r+1)}break}}var b=s?s.split("."):[""],w=0;if(b.length>1){w=b[1].length}var p=h?h.toString().split("."):["0"],j=0;if(p.length>1){j=p[1].length}if(j>w){var m=parseInt(jslet._SCALEFACTOR.substring(0,w+1));h=Math.round(h*m)/m;p=h?h.toString().split("."):["0"]}var g="",n=p[0],d=b[0],v=false,q=n.length-1,t;for(t=d.length-1;t>=0;t--){switch(d.substr(t,1)){case"#":if(q>=0){g=n.substr(q--,1)+g}break;case"0":if(q>=0){g=n.substr(q--,1)+g}else{g="0"+g}break;case",":v=true;g=","+g;break}}if(q>=0){if(v){var o=n.length;for(;q>=0;q--){g=n.substr(q,1)+g;if(q>0&&((o-q)%3)===0){g=","+g}}}else{g=n.substr(0,q+1)+g}}g=g+".";n=p.length>1?p[1]:"";d=b.length>1?b[1]:"";q=0;for(t=0;t<d.length;t++){switch(d.substr(t,1)){case"#":if(q<n.length){g+=n.substr(q++,1)}break;case"0":if(q<n.length){g+=n.substr(q++,1)}else{g+="0"}break}}return a+g.replace(/^,+/,"").replace(/\.$/,"")+e};jslet.formatDate=function(b,c){if(!b){return""}jslet.Checker.test("jslet.formatDate#date",b).isDate();jslet.Checker.test("jslet.formatDate#format",c).required().isString();var d={"M+":b.getMonth()+1,"d+":b.getDate(),"h+":b.getHours(),"m+":b.getMinutes(),"s+":b.getSeconds(),"q+":Math.floor((b.getMonth()+3)/3),S:b.getMilliseconds()};if(/(y+)/.test(c)){c=c.replace(RegExp.$1,(b.getFullYear()+"").substr(4-RegExp.$1.length))}for(var a in d){if(new RegExp("("+a+")").test(c)){c=c.replace(RegExp.$1,RegExp.$1.length==1?d[a]:("00"+d[a]).substr((""+d[a]).length))}}return c};jslet.parseDate=function(h,j){if(!h){return null}jslet.Checker.test("jslet.parseDate#strDate",h).isString();jslet.Checker.test("jslet.parseDate#format",j).required().isString();var c=null,a,l,b=-1,d=0;var k={y:0,M:0,d:0,h:0,m:0,s:0,S:0};for(var e=0,f=j.length;e<f;e++){a=j.charAt(e);if(a!=c){if(c&&k[c]!==undefined&&b>=0){d=e;l=parseInt(h.substring(b,d));k[c]=isNaN(l)?0:l}b=e;c=a}}if(b>=0){l=parseInt(h.substring(b));k[a]=isNaN(l)?0:l}var g=k.y;if(g<100){g+=2000}var m=new Date(g,k.M-1,k.d,k.h,k.m,k.s,k.S);return m};Date.prototype.toJSON=function(){return jslet.formatDate(this,"yyyy-MM-ddThh:mm:ss")};jslet.convertISODate=function(d){if(!d){return null}if(jslet.isDate(d)){return d}var b=d.substr(10,1);if("T"==b){var f=d.substr(0,4),g=d.substr(5,2),c=d.substr(8,2),a=d.substr(11,2),h=d.substr(14,2),e=d.substr(17,2);if("Z"==d.substr(-1,1)){return new Date(Date.UTC(+f,+g-1,+c,+a,+h,+e))}return new Date(+f,+g-1,+c,+a,+h,+e)}return d};jslet._currentPattern={};jslet._convertToJsPattern=function(g,m){if(jslet._currentPattern.pattern==g&&jslet._currentPattern.escapeChar==m){return jslet._currentPattern.result}jslet._currentPattern.pattern=g;jslet._currentPattern.escapeChar=m;var e=[],f=g.length-1,h,a,j=0,b=f,k=false,l=false;if(g.charAt(0)=="%"){j=1;k=true}if(g.charAt(f)=="%"){b=f-1;l=true}if(k&&l){e.push(".*")}else{if(l){e.push("^")}}for(var d=j;d<=b;d++){h=g.charAt(d);if(h=="\\"&&d<f){a=g.charAt(d+1);if(a=="%"||a=="_"){e.push(a);d++;continue}}else{if(h=="_"){e.push(".")}else{if(h=="."||h=="*"||h=="["||h=="]"||h=="{"||h=="}"||h=="+"||h=="("||h==")"||h=="\\"||h=="?"||h=="$"||h=="^"){e.push("\\")}e.push(h)}}}if(k&&l||l){e.push(".*")}else{if(k){e.push("$")}}jslet._currentPattern.result=new RegExp(e.join(""),"ig");return jslet._currentPattern.result};jslet.like=like=window.like=function(c,b,a){if(!c||!b){return false}if(b.length===0){return false}if(!a){a="\\"}var d=jslet._convertToJsPattern(b,a);return c&&c.match(d)!==null};jslet.between=between=window.between=function(c,a,b){if(arguments.length!=3){return false}return c>=a&&c<=b};jslet.inlist=inlist=window.inlist=function(d,a){var c=arguments.length;if(c<=2){return false}for(var b=1;b<c;b++){if(d==arguments[b]){return true}}return false};jslet.isArray=function(a){return !a||Object.prototype.toString.apply(a)==="[object Array]"};jslet.isDate=function(a){return !a||a.constructor==Date};jslet.isString=function(a){return a===null||a===undefined||typeof a=="string"};jslet.isObject=function(a){return a===null||a===undefined||jQuery.type(this.varValue)!=="object"};jslet.setTimeout=function(c,a,b){jslet.delayFunc=function(){a.call(c)};setTimeout(jslet.delayFunc,b)};jslet.htmlEncode=function(a){if(a){return jQuery("<div />").text(a).html()}else{return""}};jslet.htmlDecode=function(a){if(a){return jQuery("<div />").html(a).text()}else{return""}};jslet.getArrayValue=function(c,b){if(!c){return null}if(jslet.isArray(c)){var a=c.length;if(b<a){return c[b]}else{return null}}else{if(b===0){return c}else{return null}}};jslet.Checker={varName:null,varValue:null,test:function(b,a){this.varName=b;this.varValue=a;return this},testValue:function(a){this.varValue=a;return this},required:function(){if(this.varValue===null||this.varValue===undefined||this.varValue===""){throw new Error("["+this.varName+"] is Required!")}return this},isBoolean:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==""&&this.varValue!==0&&this.varValue!==true&&this.varValue!==false){throw new Error("["+this.varName+"] must be a boolean value!")}return this},isString:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&!jslet.isString(this.varValue)){throw new Error("["+this.varName+":"+this.varValue+"] must be a String!")}return this},isDate:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&!jslet.isDate(this.varValue)){throw new Error("["+this.varName+"] must be a Date!")}return this},isNumber:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&!jQuery.isNumeric(this.varValue)){throw new Error("["+this.varName+":"+this.varValue+"] must be a Numberic!")}return this},isGTZero:function(){this.isNumber();if(this.varValue<=0){throw new Error("["+this.varName+":"+this.varValue+"] must be great than zero!")}},isGTEZero:function(){this.isNumber();if(this.varValue<0){throw new Error("["+this.varName+":"+this.varValue+"] must be great than or equal zero!")}},between:function(b,d){var a=b!==null&&b!==undefined;var c=d!==null&&d!==undefined;if(a&&c&&(this.varValue<b||this.varValue>d)){throw new Error("["+this.varName+":"+this.varValue+"] must be between ["+b+"] and ["+d+"]!")}if(!a&&c&&this.varValue>d){throw new Error("["+this.varName+":"+this.varValue+"] must be less than ["+d+"]!")}if(a&&!c&&this.varValue<b){throw new Error("["+this.varName+":"+this.varValue+"] must be great than ["+b+"]!")}},isArray:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&!jslet.isArray(this.varValue)){throw new Error("["+this.varName+"] must be an Array!")}return this},isObject:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&jQuery.type(this.varValue)!=="object"){throw new Error("["+this.varName+"] must be a Object!")}return this},isFunction:function(){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&!jQuery.isFunction(this.varValue)){throw new Error("["+this.varName+"] must be a Function!")}return this},isClass:function(a){this.isObject();if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&this.varValue.className!=a){throw new Error("["+this.varName+"] must be instance of ["+a+"]!")}return this},isDataType:function(a){if(a=="S"){this.isString()}if(a=="N"){this.isNumber()}if(a=="D"){this.isDate()}return this},inArray:function(a){if(this.varValue!==null&&this.varValue!==undefined&&this.varValue!==false&&a.indexOf(this.varValue)<0){throw new Error("["+this.varName+":"+this.varValue+"] must be one of ["+a.join(",")+"]!")}return this}};jslet.JSON={normalize:function(m){m=jQuery.trim(m);var n=[],j,f,k=false,g=false,b=true,l="",d=null;var j=m.charAt(0),a=false;if(j!="{"&&j!="["){n.push('{"');a=true}for(var e=0,h=m.length;e<h;e++){j=m.charAt(e);if(d){if(j==d){d=null;n.push('"');l='"'}else{n.push(j)}continue}if(j=="["){g=true;b=false}if(j=="]"||j=="{"){g=false;b=true}if(k&&(j==" "||j=="\b")){continue}if(b&&(j=="{"||j==",")){k=true;n.push(j);l=j;continue}if(l=="{"||l==","){n.push('"')}if(k&&j=="'"){n.push('"');continue}if(j==":"){k=false;if(l!='"'){n.push('"')}}if(!k){if(j=="'"||j=='"'){d=j;n.push('"');continue}}l=j;n.push(j)}if(a){n.push("}")}return n.join("")},parse:function(a){return JSON.parse(this.normalize(a))},stringify:function(c,a,b){return JSON.stringify(c,a,b)}};jslet.showError=function(a){var b;if(typeof(a)=="string"){b=a}else{b=a.message}if(jslet.ui.MessageBox){jslet.ui.MessageBox.error(b)}else{alert(b)}};jslet.showInfo=function(a){var b;if(typeof(a)=="string"){b=a}else{b=a.message}if(jslet.ui.MessageBox){jslet.ui.MessageBox.alert(b)}else{alert(b)}};jslet.toArray=function(c){if(!c){return[]}if("toArray" in Object(c)){return c.toArray()}var b=c.length||0,a=new Array(b);while(b--){a[b]=c[b]}return a};jslet.extend=function(a,c){for(var b in c){a[b]=c[b]}return a};jslet.emptyFunction=function(){};jslet.keys=function(a){if((typeof a)!="object"){return[]}var b=[];for(var c in a){if(a.hasOwnProperty(c)){b.push(c)}}return b};jslet.extend(Function.prototype,(function(){var l=Array.prototype.slice;function d(p,m){var o=p.length,n=m.length;while(n--){p[o+n]=m[n]}return p}function j(n,m){n=l.call(n,0);return d(n,m)}function g(){var m=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return m.length==1&&!m[0]?[]:m}function h(o){if(arguments.length<2&&(typeof arguments[0]==="undefined")){return this}var m=this,n=l.call(arguments,1);return function(){var p=j(n,arguments);return m.apply(o,p)}}function f(o){var m=this,n=l.call(arguments,1);return function(q){var p=d([q||window.event],n);return m.apply(o,p)}}function k(){if(!arguments.length){return this}var m=this,n=l.call(arguments,0);return function(){var o=j(n,arguments);return m.apply(this,o)}}function e(o){var m=this,n=l.call(arguments,1);o=o*1000;return window.setTimeout(function(){return m.apply(m,n)},o)}function a(){var m=d([0.01],arguments);return this.delay.apply(this,m)}function c(n){var m=this;return function(){var o=d([m.bind(this)],arguments);return n.apply(this,o)}}function b(){if(this._methodized){return this._methodized}var m=this;this._methodized=function(){var n=d([this],arguments);return m.apply(null,n)};return this._methodized}return{argumentNames:g,bind:h,bindAsEventListener:f,curry:k,delay:e,defer:a,wrap:c,methodize:b}})());jslet.Class=(function(){var d=(function(){for(var e in {toString:1}){if(e==="toString"){return false}}return true})();function a(){}function b(){var h=null,g=jslet.toArray(arguments);if(jQuery.isFunction(g[0])){h=g.shift()}function e(){this.initialize.apply(this,arguments)}jslet.extend(e,jslet.Class.Methods);e.superclass=h;e.subclasses=[];if(h){a.prototype=h.prototype;e.prototype=new a();h.subclasses.push(e)}for(var f=0,j=g.length;f<j;f++){e.addMethods(g[f])}if(!e.prototype.initialize){e.prototype.initialize=jslet.emptyFunction}e.prototype.constructor=e;return e}function c(l){var g=this.superclass&&this.superclass.prototype,f=jslet.keys(l);if(d){if(l.toString!=Object.prototype.toString){f.push("toString")}if(l.valueOf!=Object.prototype.valueOf){f.push("valueOf")}}for(var e=0,h=f.length;e<h;e++){var k=f[e],j=l[k];if(g&&jQuery.isFunction(j)&&j.argumentNames()[0]=="$super"){var m=j;j=(function(n){return function(){return g[n].apply(this,arguments)}})(k).wrap(m);j.valueOf=m.valueOf.bind(m);j.toString=m.toString.bind(m)}this.prototype[k]=j}return this}return{create:b,Methods:{addMethods:c}}})();if(!jslet.getCookie){jslet.getCookie=function(c){var d=document.cookie.indexOf(c+"=");var a=d+c.length+1;if((!d)&&(c!=document.cookie.substring(0,c.length))){return null}if(d==-1){return null}var b=document.cookie.indexOf(";",a);if(b==-1){b=document.cookie.length}return unescape(document.cookie.substring(a,b))}}if(!jslet.setCookie){jslet.setCookie=function(c,e,a,h,d,g){var b=new Date();b.setTime(b.getTime());if(a){a=a*1000*60*60*24}var f=new Date(b.getTime()+(a));document.cookie=c+"="+escape(e)+((a)?";expires="+f.toGMTString():"")+((h)?";path="+h:"")+((d)?";domain="+d:"")+((g)?";secure":"")}}if(!jslet.deleteCookie){jslet.deleteCookie=function(a,c,b){if(getCookie(a)){document.cookie=a+"="+((c)?";path="+c:"")+((b)?";domain="+b:"")+";expires=Thu, 01-Jan-1970 00:00:01 GMT"}}}jslet.data.dataModule=new jslet.SimpleMap();jslet.data.getDataset=function(a){return jslet.data.dataModule.get(a)};jslet.data.DataType={NUMBER:"N",STRING:"S",DATE:"D",TIME:"T",BOOLEAN:"B",DATASET:"V",GROUP:"G"};jslet.data.FieldValueStyle={NORMAL:0,BETWEEN:1,MULTIPLE:2};jslet.data.EditMask=function(a,c,b){this.mask=a;this.keepChar=(c!==undefined?c:true);this.transform=b;this.clone=function(){return new jslet.data.EditMask(this.mask,this.keepChar,this.transform)}};jslet.data.DatasetEvent={BEFORESCROLL:"beforeScroll",AFTERSCROLL:"afterScroll",BEFOREINSERT:"beforeInsert",AFTERINSERT:"afterInsert",BEFOREUPDATE:"beforeUpdate",AFTERUPDATE:"afterUpdate",BEFOREDELETE:"beforeDelete",AFTERDELETE:"afterDelete",BEFORECONFIRM:"beforeConfirm",AFTERCONFIRM:"afterConfirm",BEFORECANCEL:"beforeCancel",AFTERCANCEL:"afterCancel"};jslet.data.DataSetStatus={BROWSE:0,INSERT:1,UPDATE:2,DELETE:3};jslet.data.RefreshEvent={updateRecordEvent:function(a){return{eventType:jslet.data.RefreshEvent.UPDATERECORD,fieldName:a}},updateColumnEvent:function(a){return{eventType:jslet.data.RefreshEvent.UPDATECOLUMN,fieldName:a}},updateAllEvent:function(){return this._updateAllEvent},changeMetaEvent:function(a,b){return{eventType:jslet.data.RefreshEvent.CHANGEMETA,metaName:a,fieldName:b}},beforeScrollEvent:function(a){return{eventType:jslet.data.RefreshEvent.BEFORESCROLL,recno:a}},scrollEvent:function(a,b){return{eventType:jslet.data.RefreshEvent.SCROLL,prevRecno:b,recno:a}},insertEvent:function(b,a,c){return{eventType:jslet.data.RefreshEvent.INSERT,prevRecno:b,recno:a,updateAll:c}},deleteEvent:function(a){return{eventType:jslet.data.RefreshEvent.DELETE,recno:a}},selectRecordEvent:function(b,a){return{eventType:jslet.data.RefreshEvent.SELECTRECORD,recno:b,selected:a}},selectAllEvent:function(a){return{eventType:jslet.data.RefreshEvent.SELECTALL,selected:a}},changePageEvent:function(){return this._changePageEvent},errorEvent:function(a){return{eventType:jslet.data.RefreshEvent.ERROR,message:a}},lookupEvent:function(a){return{eventType:jslet.data.RefreshEvent.UPDATELOOKUP,fieldName:a}}};jslet.data.RefreshEvent.CHANGEMETA="changeMeta";jslet.data.RefreshEvent.UPDATEALL="updateAll";jslet.data.RefreshEvent.UPDATERECORD="updateRecord";jslet.data.RefreshEvent.UPDATECOLUMN="updateColumn";jslet.data.RefreshEvent.BEFORESCROLL="beforescroll";jslet.data.RefreshEvent.SCROLL="scroll";jslet.data.RefreshEvent.SELECTRECORD="selectRecord";jslet.data.RefreshEvent.SELECTALL="selectAll";jslet.data.RefreshEvent.INSERT="insert";jslet.data.RefreshEvent.DELETE="delete";jslet.data.RefreshEvent.CHANGEPAGE="changePage";jslet.data.RefreshEvent.UPDATELOOKUP="updateLookup";jslet.data.RefreshEvent.ERROR="error";jslet.data.RefreshEvent._updateAllEvent={eventType:jslet.data.RefreshEvent.UPDATEALL};jslet.data.RefreshEvent._changePageEvent={eventType:jslet.data.RefreshEvent.CHANGEPAGE};jslet.data.FieldValidator=function(){};jslet.data.FieldValidator.prototype={intRegular:{expr:/^(-)?[1-9]*\d+$/ig},floatRegular:{expr:/((^-?[1-9])|\d)\d*(\.[0-9]*)?$/ig},checkInputChar:function(e,b){var a=e.validChars();if(a&&b){var d=b.charAt(0);return a.indexOf(d)>=0}return true},checkInputText:function(g,f){var b=this.checkRequired(g,f);if(b){return b}if(f===""){return null}var c=g.getType();var d=g.regularExpr();if(!d){if(c==jslet.data.DataType.DATE){d=g.dateRegular()}else{if(c==jslet.data.DataType.NUMBER){if(!this.intRegular.message){this.intRegular.message=jslet.locale.Dataset.invalidInt;this.floatRegular.message=jslet.locale.Dataset.invalidFloat}if(!g.scale()){d=this.intRegular}else{d=this.floatRegular}}}}if(d){var a=d.expr;if(typeof a=="string"){a=new RegExp(d.expr,"ig")}a.lastIndex=0;if(!a.test(f)){return d.message}}var e=f;if(!g.lookup()){if(c==jslet.data.DataType.NUMBER){if(g.scale()===0){e=parseInt(f)}else{e=parseFloat(f)}}if(c==jslet.data.DataType.DATE){e=jslet.parseDate(f,g.displayFormat())}}return this.checkValue(g,e)},checkRequired:function(c,b){if(c.required()){var a=true;if(b===null||b===undefined){a=false}if(a&&jslet.isString(b)&&jQuery.trim(b).length===0){a=false}if(a&&jslet.isArray(b)&&b.length===0){a=false}if(c.getType()===jslet.data.DataType.BOOLEAN&&!b){a=false}if(!a){return jslet.formatString(jslet.locale.Dataset.fieldValueRequired,[c.label()])}else{return null}}return null},checkValue:function(f,q){var p=f.getType();var a=f.dataRange(),e=f.lookup()?true:false;if(e){q=f.dataset().getFieldText(f.name(),true)}if(a){var j=a.min,r=j,o=a.max,d=o;var c=f.displayFormat();if(p==jslet.data.DataType.DATE){if(j){r=jslet.formatDate(j,c)}if(o){d=jslet.formatDate(o,c)}}if(!e&&p==jslet.data.DataType.NUMBER){r=jslet.formatNumber(j,c);d=jslet.formatNumber(o,c)}if(j!==undefined&&o!==undefined&&(q<j||q>o)){return jslet.formatString(jslet.locale.Dataset.notInRange,[r,d])}if(j!==undefined&&o===undefined&&q<j){return jslet.formatString(jslet.locale.Dataset.moreThanValue,[r])}if(j===undefined&&o!==undefined&&q>o){return jslet.formatString(jslet.locale.Dataset.lessThanValue,[d])}}if(f.unique()){var m=f.dataset(),n=m.dataList();if(q!==null&&q!==undefined&&n&&n.length>1){var h=m.getRecord(),b=f.name(),g;for(var k=0,l=n.length;k<l;k++){g=n[k];if(g===h){continue}if(g[b]==q){return jslet.locale.Dataset.notUnique}}}}if(f.customValidator()){return f.customValidator().call(f.dataset(),f,q)}return null}};jslet.data.FieldValueConverter=jslet.Class.create({className:"jslet.data.FieldValueConverter",textToValue:function(c,b){var a=b;return a},valueToText:function(d,b,a){var c=b;return c}});jslet.data.FieldValueConverter.className="jslet.data.FieldValueConverter";jslet.data.NumberValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(c,b){var a=0;if(b){if(c.scale()===0){a=parseInt(b)}else{a=parseFloat(b)}}return a},valueToText:function(e,c,a){var d=this;if(e.unitConverted()){c=c*d._unitConvertFactor}if(!a){var b=jslet.formatNumber(c,e.displayFormat());if(e.unitConverted()&&d._unitName){b+=d._unitName}return b}else{return c}}});jslet.data.DateValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(c,b){var a=jslet.parseDate(b,c.displayFormat());return a},valueToText:function(c,b,a){if(!(b instanceof Date)){throw new Error(jslet.formatString(jslet.locale.Dataset.invalidDateFieldValue,[c.name()]))}return b?jslet.formatDate(b,c.displayFormat()):""}});jslet.data.StringValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(c,b){var a=b;if(c.antiXss()){a=jslet.htmlEncode(a)}return a}});jslet.data.BooleanValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(b,a){if(!a){return false}return a.toLowerCase()=="true"},valueToText:function(c,b,a){return b?"true":"false"}});jslet.data.LookupValueConverter=jslet.Class.create(jslet.data.FieldValueConverter,{textToValue:function(c,e,g){var h="",k=c.lookup();h=k.dataset()._convertFieldValue(k.codeField(),e,k.keyField());if(h===null){var f=jslet.formatString(jslet.locale.Dataset.valueNotFound);c.message(f,g);return null}if(c.valueStyle()===jslet.data.FieldValueStyle.NORMAL){var b=k.returnFieldMap(),j=k.dataset();mainDs=this;if(j.findByKey(h)){var a,d;for(var a in b){d=b[a];mainDs.setFieldValue(a,j.getFieldValue(d))}}}return h},valueToText:function(f,e,c){var d=f.lookup(),b=d.dataset(),a;if(!c){a=b._convertFieldValue(d.keyField(),e,d.displayFields())}else{a=b._convertFieldValue(d.keyField(),e,"["+d.codeField()+"]")}return a}});jslet.data._valueConverters={};jslet.data._valueConverters[jslet.data.DataType.NUMBER]=new jslet.data.NumberValueConverter();jslet.data._valueConverters[jslet.data.DataType.STRING]=new jslet.data.StringValueConverter();jslet.data._valueConverters[jslet.data.DataType.DATE]=new jslet.data.DateValueConverter();jslet.data._valueConverters[jslet.data.DataType.BOOLEAN]=new jslet.data.BooleanValueConverter();jslet.data._valueConverters.lookup=new jslet.data.LookupValueConverter();jslet.data.getValueConverter=function(a){if(a.lookup()){return jslet.data._valueConverters.lookup}return jslet.data._valueConverters[a.getType()]};jslet.data._record2JsonFilter=function(a,b){if(a==jslet.data.FieldValueCache.CACHENAME){return undefined}else{return b}};jslet.data.record2Json=function(a){if(!window.JSON||!JSON){alert("Your browser does not support JSON!");return}return JSON.stringify(a,jslet.data._record2JsonFilter)};jslet.data.FieldValueCache={CACHENAME:"_cache_",put:function(b,f,d,e){if(!b){throw new Error("Record can't be null!")}var c=b[this.CACHENAME];if(!c){c={};b[this.CACHENAME]=c}if(e||e===0){var a=c[f];if(!a||!jslet.isObject(a)){a={};c[f]=a}a[e+""]=d}else{c[f]=d}},get:function(b,e,d){if(!b){return undefined}var c=b[this.CACHENAME];if(c){if(d||d===0){var a=c[e];if(a&&jslet.isObject(a)){return a[d+""]}return undefined}else{return c[e]}}else{return undefined}},clear:function(a,c){if(!a){return}var b=a[this.CACHENAME];if(b){b[c]=undefined}},clearAll:function(e,g){var d=e.dataList();if(!d){return}var f,b;for(var c=0,a=d.length;c<a;c++){f=d[c];b=f[this.CACHENAME];if(b){delete b[g]}}},removeCache:function(a){if(a){a[this.CACHENAME]={}}}};jslet.data.DatasetRelationManager=function(){var a=[];this.addRelation=function(f,g,e){for(var c=0,b=a.length;c<b;c++){var d=a[c];if(d.hostDataset==f&&d.hostField==g&&d.lookupDataset==e){return}}a.push({hostDataset:f,hostField:g,lookupDataset:e})};this.removeRelation=function(f,g,e){for(var c=0,b=a.length;c<b;c++){var d=a[c];if(d.hostDataset==f&&d.hostField==g&&d.lookupDataset==e){a.splice(c,1)}}};this.refreshHostDataset=function(f){var e,c;for(var d=0,b=a.length;d<b;d++){e=a[d];if(e.lookupDataset==f){c=jslet.data.getDataset(e.hostDataset);if(c){c.handleLookupDatasetChanged(e.hostField)}}}}};jslet.data.datasetRelationManager=new jslet.data.DatasetRelationManager();jslet.data.convertDateFieldValue=function(h,d){var a=h;if(!d){d=a.dataList()}if(!d||d.length===0){return}var p=[],k,l=a.getNormalFields(),c=l.length,e;for(k=0;k<c;k++){e=l[k];if(e.getType()==jslet.data.DataType.DATE){p.push(e.name())}}if(p.length===0){return}var f,b,o,n=d.length;for(k=0;k<n;k++){f=d[k];for(var g=0,m=p.length;g<m;g++){b=p[g];o=f[b];if(!jslet.isDate(o)){o=jslet.parseDate(o,"yyyy-MM-ddThh:mm:ss");if(o){f[b]=o}else{throw new Error(jslet.formatString(jslet.locale.Dataset.invalidDateFieldValue,[fldName]))}}}}};jslet.Expression=function(b,a){jslet.Checker.test("jslet.Expression#expr",a).required().isString();this._fields=[];this._otherDatasetFields=[];this._expr=a;this._parsedExpr="";if(typeof b=="string"){this._dataset=jslet.data.dataModule.get(b);if(!this._dataset){throw new Error(jslet.formatString(jslet.locale.Dataset.datasetNotFound,[dsName]))}}else{this._dataset=b}this.context={mainds:b};this.parse()};jslet.Expression.prototype={_ParserPattern:/\[[_a-zA-Z][\.!\w]*(,\d){0,1}]/gim,parse:function(){var a=0,e,d,b,c,f,l,h,j=[],g=null;this._ParserPattern.lastIndex=0;while((l=this._ParserPattern.exec(this._expr))!==null){c=l[0];if(!c||c.endsWith("(")){continue}b=null;c=c.substr(1,c.length-2);d=c.indexOf(",");if(d>0){g=parseInt(c.substr(d+1));if(isNaN(g)){g=null}c=c.substr(0,d)}d=c.indexOf("!");if(d>0){b=c.substr(0,d);c=c.substr(d+1)}e=l.index;h=this._dataset;if(b){f=jslet.data.dataModule.get(b);if(!f){throw new Error(jslet.formatString(jslet.locale.Dataset.datasetNotFound,[b]))}this.context[b]=f;h=f}if(h.getField(c)===null){throw new Error(jslet.formatString(jslet.locale.Dataset.fieldNotFound,[c]))}if(!b){j.push(this._expr.substring(a,e));j.push('context.mainds.fieldValueByRec(context.dataRec, "');this._fields.push(c)}else{j.push(this._expr.substring(a,e));j.push("context.");j.push(b);j.push('.getFieldValue("');this._otherDatasetFields.push({dataset:b,fieldName:c})}j.push(c);j.push('"');if(g!==null){j.push(",");j.push(g)}j.push(")");a=e+l[0].length}j.push(this._expr.substr(a));this._parsedExpr=j.join("")},mainFields:function(){return this._fields},otherDatasetFields:function(){return this._otherDatasetFields},eval:function(){var context=this.context;context.mainds=this._dataset;return eval(this._parsedExpr)},destroy:function(){this._dataset=null;this._fields=null;this._otherDatasetFields=[];this._parsedExpr=null;this._expr=null;this.context=null}};jslet.data.dataModule=new jslet.SimpleMap();jslet.data.getDataset=function(a){return jslet.data.dataModule.get(a)};jslet.data.Dataset=function(a){jslet.Checker.test("Dataset.name",a).isString();a=jQuery.trim(a);jslet.Checker.test("Dataset.name",a).required();var b=this;b._name=null;b._recordClass=jslet.global.defaultRecordClass;b._dataList=null;b._datasetListener=null;b._fields=[];b._normalFields=[];b._recno=-1;b._filteredRecnoArray=null;b._unitConvertFactor=1;b._unitName=null;b._aborted=false;b._insertedDelta=[];b._updatedDelta=[];b._deletedDelta=[];b._status=0;b._subDatasetFields=null;b._filter=null;b._filtered=false;b._innerFilter=null;b._findCondition=null;b._innerFindCondition=null;b._innerFormularFields=null;b._bof=false;b._eof=false;b._igoreEvent=false;b._logChanged=true;b._modiObject=null;b._lockCount=0;b._fixedIndexFields=null;b._innerFixedIndexFields=[];b._indexFields="";b._innerIndexFields=[];b._sortingFields=null;b._convertDestFields=null;b._innerConvertDestFields=null;b._masterDataset=null;b._detailDatasets=null;b._datasetField=null;b._linkedControls=[];b._linkedLabels=[];b._silence=0;b._keyField=null;b._codeField=null;b._nameField=null;b._parentField=null;b._selectField=null;b._contextRules=null;b._contextRuleEngine=null;b._contextRuleEnabled=false;b._dataProvider=jslet.data.DataProvider?new jslet.data.DataProvider():null;b._queryCriteria=null;b._queryUrl=null;b._submitUrl=null;b._pageSize=500;b._pageNo=0;b._pageCount=0;b._ignoreFilter=false;b._ignoreFilterRecno=0;b.fieldValidator=new jslet.data.FieldValidator();b.onFieldChange=null;b._onCheckSelectable=null;b._autoShowError=false;b._autoRefreshHostDataset=false;b._readOnly=false;var c=this._name;if(c){jslet.data.dataModule.unset(c)}jslet.data.dataModule.unset(a);jslet.data.dataModule.set(a,this);this._name=a};jslet.data.Dataset.className="jslet.data.Dataset";jslet.data.Dataset.prototype={className:jslet.data.Dataset.className,name:function(){if(arguments.length>0){throw new Error("Can't change dataset name! Use new jslet.data.Dataset('dsName') instead!")}return this._name},recordClass:function(a){var b=this;if(a===undefined){return b._recordClass}jslet.Checker.test("Dataset.recordClass",a).isString();b._recordClass=a?a.trim():null;return this},clone:function(e,m){var a=this;if(!e){e=a._name+"_clone"}var n=new jslet.data.Dataset(e);n._datasetListener=a._datasetListener;n._unitConvertFactor=a._unitConvertFactor;n._unitName=a._unitName;n._filter=a._filter;n._filtered=a._filtered;n._logChanged=a._logChanged;n._fixedIndexFields=a._fixedIndexFields;n._indexFields=a._indexFields;var j=a._keyField,k=a._codeField,l=a._nameField,h=a._parentField,d=a._selectField;if(m){j=j&&m.indexOf(j)>=0?j:null;k=k&&m.indexOf(k)>=0?k:null;l=l&&m.indexOf(l)>=0?l:null;h=h&&m.indexOf(h)>=0?h:null;d=d&&m.indexOf(d)>=0?d:null}n._keyField=j;n._codeField=k;n._nameField=l;n._parentField=h;n._selectField=d;n._contextRules=a._contextRules;var f,b;for(var g=0,c=a._fields.length;g<c;g++){f=a._fields[g];b=f.name();if(m){if(m.indexOf(b)<0){continue}}n.addField(f.clone(b,n))}return n},cloneRecord:function(l,m){var n=m||{},b,e,h,a,d=this.getNormalFields();for(var g=0,k=d.length;g<k;g++){e=d[g];b=e.name();h=l[b];if(h===undefined){continue}if(h&&jslet.isArray(h)){a=[];for(var f=0,c=h.length;f<c;f++){a.push(h[f])}}else{a=h}n[b]=a}jslet.data.FieldValueCache.removeCache(n);return n},addFieldFromDataset:function(e,f){jslet.Checker.test("Dataset.addFieldFromDataset#srcDataset",e).required().isClass(jslet.data.Dataset.className);jslet.Checker.test("Dataset.addFieldFromDataset#fieldNames",f).isArray();var g,a,b=e.getFields();for(var d=0,c=b.length;d<c;d++){g=b[d];a=g.name();if(f){if(f.indexOf(a)<0){continue}}this.addField(g.clone(a,this))}},readOnly:function(f){var d=this;if(f===undefined){return d._readOnly}d._readOnly=f?true:false;var b=d.getNormalFields(),e;for(var c=0,a=b.length;c<a;c++){e=b[c];e._fireMetaChangedEvent("readOnly")}return this},pageSize:function(a){if(a===undefined){return this._pageSize}jslet.Checker.test("Dataset.pageSize#pageSize",a).isGTZero();this._pageSize=a;return this},pageNo:function(a){if(a===undefined){return this._pageNo}jslet.Checker.test("Dataset.pageNo#pageNo",a).isGTZero();this._pageNo=a;return this},pageCount:function(){return this._pageCount},autoShowError:function(a){if(a===undefined){return this._autoShowError}this._autoShowError=a?true:false;return this},autoRefreshHostDataset:function(a){if(a===undefined){return this._autoRefreshHostDataset}this._autoRefreshHostDataset=a?true:false;return this},unitConvertFactor:function(f,c){var g=this;if(arguments.length===0){return g._unitConvertFactor}jslet.Checker.test("Dataset.unitConvertFactor#factor",f).isGTZero();jslet.Checker.test("Dataset.unitConvertFactor#unitName",c).isString();if(f>0){g._unitConvertFactor=f}else{g._unitConvertFactor=1}g._unitName=c;for(var e=0,d=g._normalFields.length,h;e<d;e++){h=g._normalFields[e];if(h.getType()==jslet.data.DataType.NUMBER&&h.unitConverted()){var b=h.name();jslet.data.FieldValueCache.clearAll(g,b);var a=jslet.data.RefreshEvent.updateColumnEvent(b);g.refreshControl(a)}}return g},datasetListener:function(a){if(arguments.length===0){return this._datasetListener}jslet.Checker.test("Dataset.datasetListener#listener",a).isFunction();this._datasetListener=a;return this},onCheckSelectable:function(a){if(a===undefined){return this._onCheckSelectable}jslet.Checker.test("Dataset.onCheckSelectable",a).isFunction();this._onCheckSelectable=a;return this},getFields:function(){return this._fields},getNormalFields:function(){return this._normalFields},setVisibleFields:function(b){jslet.Checker.test("Dataset.setVisibleFields#fieldNameArray",b).isArray();this._travelField(this._fields,function(f){f.visible(false);return false});if(!b){return}for(var d=0,a=b.length;d<a;d++){var c=jQuery.trim(b[d]);var e=this.getField(c);if(e){e.visible(true)}}},_travelField:function(b,c){if(!c||!b){return}var e=false;for(var d=0,a=b.length;d<a;d++){var f=b[d];e=c(f);if(e){break}if(f.getType()==jslet.data.DataType.GROUP){e=this._travelField(f.children(),c);if(e){break}}}return e},_cacheNormalFields:function(){var a=this._normalFields=[];this._travelField(this._fields,function(b){if(b.getType()!=jslet.data.DataType.GROUP){a.push(b)}return false})},datasetField:function(a){if(a===undefined){return this._datasetField}jslet.Checker.test("Dataset.datasetField#fldObj",a).isClass(jslet.data.Field.className);this._datasetField=a;return this},addField:function(b){jslet.Checker.test("Dataset.addField#fldObj",b).required().isClass(jslet.data.Field.className);var a=this;a._fields.push(b);b.dataset(a);if(b.displayOrder()!==0){a._fields.sort(b.sortByIndex)}if(b.getType()==jslet.data.DataType.DATASET){if(!a._subDatasetFields){a._subDatasetFields=[]}a._subDatasetFields.push(b)}a._cacheNormalFields();return a},removeField:function(a){jslet.Checker.test("Dataset.removeField#fldName",a).required().isString();a=jQuery.trim(a);var d=this,e=d.getField(a);if(e){if(e.getType()==jslet.data.DataType.DATASET){var b=d._subDatasetFields.indexOf(e);if(b>=0){d._subDatasetFields.splice(b,1)}}var c=d._fields.indexOf(e);d._fields.splice(c,1);e.dataset(null);d._cacheNormalFields();jslet.data.FieldValueCache.clearAll(d,a)}return d},getField:function(b){jslet.Checker.test("Dataset.getField#fldName",b).isString().required();b=jQuery.trim(b);var a=b.split("."),d=a[0];var f=null;this._travelField(this._fields,function(h){var g=false;if(h.name()==d){f=h;g=true}return g});if(!f){return null}if(a.length==1){return f}else{a.splice(0,1);var e=f.lookup();if(e){var c=e.dataset();if(c){return c.getField(a.join("."))}}}return null},getTopField:function(a){jslet.Checker.test("Dataset.getField#fldName",a).isString().required();a=jQuery.trim(a);var b=this.getField(a);if(b){while(true){if(b.parent()===null){return b}b=b.parent()}}return null},sortFunc:function(e,d){var h=jslet.temp.sortDataset;var k=h._sortingFields,j,g,b,f=1;for(var c=0,a=k.length;c<a;c++){b=k[c].fieldName;j=h.fieldValueByRec(e,b);g=h.fieldValueByRec(d,b);if(j==g){continue}if(j!==null&&g!==null){if(j<g){f=-1}else{f=1}}else{if(j===null&&g!==null){f=-1}else{if(j!==null&&g===null){f=1}}}return f*k[c].order}return 0},fixedIndexFields:function(c){var g=this;if(c===undefined){return g._fixedIndexFields}jslet.Checker.test("Dataset.fixedIndexFields",c).isString();indFlds=jQuery.trim(c);g._fixedIndexFields=c;g._innerFixedIndexFields=c?g._parseIndexFields(c):[];var e,f;for(var d=g._innerIndexFields.length-1;d>=0;d--){e=g._innerIndexFields[d];for(var b=0,a=g._innerFixedIndexFields.length;b<a;b++){f=g._innerFixedIndexFields[b];if(e.fieldName===f.fieldName){g._innerIndexFields.splice(d,1)}}}g._sortByFields();return this},indexFields:function(g){var f=this;if(g===undefined){return f._indexFields}jslet.Checker.test("Dataset.indexFields",g).isString();g=jQuery.trim(g);f._indexFields=g;f._innerIndexFields=g?f._parseIndexFields(g):[];var d,e;for(var c=f._innerIndexFields.length-1;c>=0;c--){d=f._innerIndexFields[c];for(var b=0,a=f._innerFixedIndexFields.length;b<a;b++){e=f._innerFixedIndexFields[b];if(d.fieldName===e.fieldName){e.order=d.order;f._innerIndexFields.splice(c,1)}}}f._sortByFields();return this},mergedIndexFields:function(){var d=this,b=[];for(var c=0,a=d._innerFixedIndexFields.length;c<a;c++){b.push(d._innerFixedIndexFields[c])}for(var c=0,a=d._innerIndexFields.length;c<a;c++){b.push(d._innerIndexFields[c])}return b},toggleIndexField:function(a,d){var f=this,c,e=false;for(var b=f._innerFixedIndexFields.length-1;b>=0;b--){c=f._innerFixedIndexFields[b];if(c.fieldName===a){c.order=(c.order===1?-1:1);e=true;break}}if(e){if(d){f._innerIndexFields=[]}f._sortByFields();return}e=false;for(var b=f._innerIndexFields.length-1;b>=0;b--){c=f._innerIndexFields[b];if(c.fieldName===a){c.order=(c.order===1?-1:1);e=true;break}}if(e){if(d){f._innerIndexFields=[];f._innerIndexFields.push(c)}}else{if(d){f._innerIndexFields=[]}c={fieldName:a,order:1};f._innerIndexFields.push(c)}f._sortByFields()},_parseIndexFields:function(h){var d=h.split(","),g,f,c,e,b=1;var a=[];for(i=0,cnt=d.length;i<cnt;i++){g=jQuery.trim(d[i]);c=g.split(" ");if(c.length==1){b=1}else{if(c[1].toLowerCase()=="asce"){b=1}else{b=-1}}a.push({fieldName:c[0],order:b})}return a},_sortByFields:function(){var f=this;if(!f._dataList||f._dataList.length===0){return}f._sortingFields=[];var d;for(var c=0,b=f._innerFixedIndexFields.length;c<b;c++){d=f._innerFixedIndexFields[c];f._createIndexCfg(d.fieldName,d.order)}for(var c=0,b=f._innerIndexFields.length;c<b;c++){d=f._innerIndexFields[c];f._createIndexCfg(d.fieldName,d.order)}var e=f.getRecord(),a=f.isContextRuleEnabled();if(a){f.disableContextRule()}f.disableControls();jslet.temp.sortDataset=f;try{f._dataList.sort(f.sortFunc);f._refreshInnerRecno()}finally{jslet.temp.sortDataset=null;f.moveToRecord(e);if(a){f.enableContextRule()}f.enableControls()}},_createIndexCfg:function(g,a){var e=this,f=g;if(jslet.isString(g)){f=e.getField(g)}if(!f){return}if(f.dataset()!==e){e._combineIndexCfg(g,a);return}if(f.getType()!=jslet.data.DataType.GROUP){e._combineIndexCfg(f.name(),a)}else{var c=f.children();if(c){for(var b=0,d=c.length;b<d;b++){e._createIndexCfg(c[b],a)}}}},_combineIndexCfg:function(c,b){for(var e=0,a=this._sortingFields.length;e<a;e++){if(this._sortingFields[e].fieldName==c){this._sortingFields.splice(e,1)}}var d={fieldName:c,order:b};this._sortingFields.push(d)},filter:function(c){var b=this;if(c===undefined){return b._filter}jslet.Checker.test("dataset.filter#filterExpr",c).isString();c=jQuery.trim(c);var a=b._filter;if(!c){b._innerFilter=null;b._filtered=false;b._filter=null;b._filteredRecnoArray=null}else{b._filter=c;if(a==b._filter){return this}else{b._innerFilter=new jslet.Expression(b,c)}}b._doFilterChanged();return this},filtered:function(b){var d=this;if(b===undefined){return d._filtered}var a=d._filter,c=d._filtered;if(b&&!d._filter){d._filtered=false}else{d._filtered=b?true:false}if(a==d._filter&&c==d._filtered){return this}this._doFilterChanged();return this},_doFilterChanged:function(){var a=this;a.disableControls();try{if(!a._filtered){a._filteredRecnoArray=null}else{a._refreshInnerRecno()}a.first()}finally{a.enableControls()}a.refreshHostDataset();return this},_filterData:function(){var Z=this;if(!Z._filtered||!Z._filter||Z._status==jslet.data.DataSetStatus.INSERT||Z._status==jslet.data.DataSetStatus.UPDATE){return true}var result=Z._innerFilter.eval();return result},_refreshInnerRecno:function(){var d=this;if(!d._dataList||d._dataList.length===0){d._filteredRecnoArray=null;return}d._filteredRecnoArray=null;var a=[];for(var c=0,b=d._dataList.length;c<b;c++){d._recno=c;if(d._filterData()){a.push(c)}}d._filteredRecnoArray=a},_fireDatasetEvent:function(b){var a=this;if(a._silence||a._igoreEvent||!a._datasetListener){return}a._datasetListener.call(a,b)},recordCount:function(){if(this._dataList){if(!this._filteredRecnoArray){return this._dataList.length}else{return this._filteredRecnoArray.length}}return 0},hasRecord:function(){return this.recordCount()>0},recno:function(a){var b=this;if(a===undefined){return b._recno}jslet.Checker.test("dataset.recno#recno",a).isGTEZero();a=parseInt(a);if(!b.hasRecord()){b._bof=b._eof=true;return this}if(a==b._recno){return this}if(b._status!=jslet.data.DataSetStatus.BROWSE){b.confirm();if(b._aborted){return this}}b._gotoRecno(a);b._bof=b._eof=false;return this},recnoSilence:function(a){this._recno=a},_gotoRecno:function(b){var a=this;var h=a.recordCount();if(h==0){return false}if(b>=h){b=h-1}else{if(b<0){b=0}}if(a._recno==b){return false}var j;if(!a._silence){a._aborted=false;a._fireDatasetEvent(jslet.data.DatasetEvent.BEFORESCROLL);if(a._aborted){return false}if(!a._lockCount){j=jslet.data.RefreshEvent.beforeScrollEvent(a._recno);jslet.debounce(a.refreshControl,100).call(a,j)}}var d=a._recno;a._recno=b;if(a._subDatasetFields&&a._subDatasetFields.length>0){var c,k;for(var e=0,g=a._subDatasetFields.length;e<g;e++){c=a._subDatasetFields[e];k=c.subDataset();if(k){k.confirm();k.dataList(a.getFieldValue(c.name()));var f=k.indexFields();if(f){k.indexFields(f)}else{k.refreshControl()}}}}if(a._contextRuleEnabled){this.calcContextRule()}if(!a._silence){a._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL);if(!a._lockCount){j=jslet.data.RefreshEvent.scrollEvent(a._recno,d);jslet.debounce(a.refreshControl,100).call(a,j)}}return true},abort:function(){this._aborted=true},aborted:function(){return this._aborted},_moveCursor:function(a){var b=this;if(b._status!=jslet.data.DataSetStatus.BROWSE){b.confirm();if(b._aborted){return}}b._gotoRecno(a)},moveToRecord:function(b){var c=this;if(c._status!=jslet.data.DataSetStatus.BROWSE){c.confirm();if(c._aborted){return}}if(!c._dataList||c._dataList.length===0){return false}jslet.Checker.test("dataset.moveToRecord#recordObj",b).required().isObject();var a=c._dataList.indexOf(b);if(a<0){return false}if(c._filteredRecnoArray){a=c._filteredRecnoArray.indexOf(a);if(a<0){return false}}c._gotoRecno(a);return true},startSilenceMove:function(b){var c=this;var a={};if(!b){a.recno=c._recno}else{a.recno=-999}c._silence++;return a},endSilenceMove:function(a){var b=this;if(a.recno!=-999&&a.recno!=b._recno){b._gotoRecno(a.recno)}b._silence--},isBof:function(){return this._bof},isEof:function(){return this._eof},first:function(){var a=this;if(!a.hasRecord()){a._bof=a._eof=true;return}a._moveCursor(0);a._bof=a._eof=false},next:function(){var a=this;var b=a.recordCount();if(b===0){a._bof=a._eof=true;return}if(a._recno==b-1){a._bof=false;a._eof=true;return}a._bof=a._eof=false;a._moveCursor(a._recno+1)},prior:function(){var a=this;if(!a.hasRecord()){a._bof=a._eof=true;return}if(a._recno===0){a._bof=true;a._eof=false;return}a._bof=a._eof=false;a._moveCursor(a._recno-1)},last:function(){var a=this;if(!a.hasRecord()){a._bof=a._eof=true;return}a._bof=a._eof=false;a._moveCursor(a.recordCount()-1);a._bof=a._eof=false},_checkStatusAndConfirm:function(){if(this._status!=jslet.data.DataSetStatus.BROWSE){this.confirm()}},checkStatusByCancel:function(){if(this._status!=jslet.data.DataSetStatus.BROWSE){this.cancel()}},insertChild:function(e){var d=this;if(!d._parentField||!d.keyField()){throw new Error("parentField and keyField not set,use insertRecord() instead!")}if(!d._dataList||d._dataList.length===0){d.innerInsert();return}var a=d.startSilenceMove(true);try{d.getRecord()._expanded_=true;if(e){if(!d.findByKey(e)){return}}else{e=d.keyValue()}var b=d.parentField(),c=d.getFieldValue(b);while(true){d.next();if(d.isEof()){break}if(c==d.getFieldValue(b)){d.prior();break}}}finally{d.endSilenceMove(a)}d.innerInsert(function(f){f[d._parentField]=e})},insertSibling:function(){var d=this;if(!d._parentField||!d._keyField){throw new Error("parentField and keyField not set,use insertRecord() instead!")}if(!d._dataList||d._dataList.length===0){d.innerInsert();return}var g=d.getFieldValue(d.parentField()),b=d.startSilenceMove(true),c=false,a=[],f,e=d.keyValue();try{d.next();while(!d.isEof()){f=d.parentValue();if(f==e){a.push(e);lastPKey=e}else{if(lastPKey!=f){if(a.indexOf(f)<0){d.prior();c=true;break}}}e=f;d.next()}if(!c){d.last()}}finally{d.endSilenceMove(b)}d.innerInsert(function(h){h[d._parentField]=g})},insertRecord:function(){this.innerInsert()},appendRecord:function(){var a=this;a._silence++;try{a.last()}finally{a._silence--}a.insertRecord()},status:function(a){this._status=a;return this},changedStatus:function(b){var a=this.getRecord();if(!a){return null}var c=a[jslet.data.FieldValueCache.CACHENAME];if(b===undefined){if(!c){return jslet.data.DataSetStatus.BROWSE}return c._data_status_}var d=-1;if(!c){c={};a[jslet.data.FieldValueCache.CACHENAME]=c}else{d=c._data_status_}if(d!=b){if(this._contextRuleEngine){this._contextRuleEngine.evalStatus()}}c._data_status_=b},innerInsert:function(e){var a=this;var g=a._datasetField,j=null;if(g){j=g.dataset();if(j.recordCount()===0){throw new Error(jslet.locale.Dataset.insertMasterFirst)}}if(a._dataList===null){a._dataList=[]}a._aborted=false;a._checkStatusAndConfirm();if(a._aborted){return}a._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREINSERT);if(a._aborted){return}var f=a.recno(),b;if(this.recordCount()>0){b=a._dataList.indexOf(this.getRecord())+1}else{b=0}a._modiObject={};a._dataList.splice(b,0,a._modiObject);if(a._filteredRecnoArray&&a._filteredRecnoArray.length>0){for(var c=a._filteredRecnoArray.length-1;c>=0;c--){if(a._filteredRecnoArray[c]<b){a._filteredRecnoArray.splice(c+1,0,b);a._recno=b;break}a._filteredRecnoArray[c]+=1}}else{a._recno=b}a.status(jslet.data.DataSetStatus.INSERT);a.changedStatus(jslet.data.DataSetStatus.INSERT);a._calcDefaultValue();if(e){e(a._modiObject)}if(g&&j){j.editRecord();var d=g.name();if(!j.getFieldValue(d)){j.setFieldValue(d,a._dataList)}}a._aborted=false;a._fireDatasetEvent(jslet.data.DatasetEvent.AFTERINSERT);a._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL);var h=jslet.data.RefreshEvent.insertEvent(f,a.recno(),a._recno<a.recordCount()-1);a.refreshControl(h)},insertDataset:function(c){var d=this;d.filtered(false);var a;if(this.recordCount()>0){a=d._dataList.indexOf(this.getRecord())+1}else{a=d._dataList.length}var b=c.startSilenceMove(true),e;try{c.first();while(!c.isEof()){e=c.getRecord();d._dataList.splice(a++,0,e);c.next()}}finally{c.endSilenceMove(b)}},appendDataset:function(a){var b=this;b._silence++;try{b.last()}finally{b._silence--}b.insertDataset(a)},batchAppendRecords:function(b,d){jslet.Checker.test("dataset.records",b).required().isArray();var f=this;f.disableControls();try{var h=f.keyField(),g,e;for(var c=0,a=b.length;c<a;c++){g=b[c];e=g[h];if(!e){throw new Error("batchAppend: Key Value required!")}if(f.findByKey(e)){if(d){f.editRecord();f.cloneRecord(g,f.getRecord());f.confirm()}else{continue}}else{f.appendRecord();f.cloneRecord(g,f.getRecord());f.confirm()}}}finally{f.enableControls();f.refreshControl(jslet.data.RefreshEvent._updateAllEvent);f.refreshHostDataset()}},_calcDefaultValue:function(){var Z=this,fldObj,expr,value,fname;for(var i=0,fldcnt=Z._normalFields.length;i<fldcnt;i++){fldObj=Z._normalFields[i];fname=fldObj.name();if(fldObj.getType()==jslet.data.DataType.DATASET){var subds=fldObj.subDataset();Z.setFieldValue(fname,null);continue}value=fldObj.defaultValue();if(value===undefined||value===null){expr=fldObj.defaultExpr();if(!expr){continue}value=window.eval(expr)}var valueStyle=fldObj.valueStyle();if(valueStyle==jslet.data.FieldValueStyle.BETWEEN){value=[value,value]}else{if(valueStyle==jslet.data.FieldValueStyle.MULTIPLE){value=[value]}}Z.setFieldValue(fname,value)}},getRecord:function(b){var c=this,a;if(!c._dataList||c._dataList.length===0){return null}if(c._ignoreFilter){return c._dataList[c._ignoreFilterRecno||0]}if(c.recordCount()===0){return null}if(b===undefined){b=c._recno>=0?c._recno:0}else{if(b<0||b>=c.recordCount()){return null}}if(c._filteredRecnoArray){a=c._filteredRecnoArray[b]}else{a=b}return c._dataList[a]},getRelativeRecord:function(a){return this.getRecord(this._recno+a)},isSameAsPrevious:function(c){var a=this,j=a.getRelativeRecord(-1);if(!j){return false}var f=a.getRecord(),g=(j[c]==f[c]);if(!g){return g}var e=a.getField(c),l=e.mergeSameBy();if(l){var b=l.split(","),d;for(var h=0,k=b.length;h<k;h++){d=jQuery.trim(b[h]);if(j[d]!=f[d]){return false}}}return g},hasChildren:function(){var d=this;if(!d._parentField){return false}var b=d.startSilenceMove();var c=d.keyValue();try{d.next();if(!d.isEof()){var a=d.parentValue();if(a==c){return true}}return false}finally{d.endSilenceMove(b)}},editRecord:function(){var b=this;if(b._status==jslet.data.DataSetStatus.UPDATE||b._status==jslet.data.DataSetStatus.INSERT){return}if(b._dataList===null||b._dataList.length===0){b.insertRecord()}else{b._aborted=false;b._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREUPDATE);if(b._aborted){return}b._modiObject={};jQuery.extend(b._modiObject,b.getRecord());var a=b._datasetField;if(a&&a.dataset()){a.dataset().editRecord()}b.status(jslet.data.DataSetStatus.UPDATE);b.changedStatus(jslet.data.DataSetStatus.UPDATE);b._aborted=false;b._fireDatasetEvent(jslet.data.DatasetEvent.AFTERUPDATE)}},deleteRecord:function(){var a=this;var h=a.recordCount();if(h===0){return}if(a._status==jslet.data.DataSetStatus.INSERT){a.cancel();return}a._silence++;try{a.checkStatusByCancel()}finally{a._silence--}if(a.hasChildren()){jslet.showInfo(jslet.locale.Dataset.cannotDelParent);return}a._aborted=false;a._fireDatasetEvent(jslet.data.DatasetEvent.BEFOREDELETE);if(a._aborted){return}if(a._logChanged){var d=a.getRecord(),g=false,f,b;b=a._insertedDelta.length;for(f=0;f<b;f++){if(a._insertedDelta[f]==d){a._insertedDelta.splice(f,1);g=true;break}}if(!g){b=a._updatedDelta.length;for(f=0;f<b;f++){if(a._updatedDelta[f]==d){a._updatedDelta.splice(f,1);break}}a._deletedDelta.push(d)}}var j=a.recno(),e=j==(h-1),c=a._recno;a.changedStatus(jslet.data.DataSetStatus.DELETE);a._dataList.splice(c,1);a._refreshInnerRecno();var l=a._datasetField;if(l&&l.dataset()){l.dataset().editRecord()}a.status(jslet.data.DataSetStatus.BROWSE);var m=jslet.data.RefreshEvent.deleteEvent(j);a.refreshControl(m);if(e){a._silence++;try{a.prior()}finally{a._silence--}}a._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL);if(a.isBof()&&a.isEof()){return}m=jslet.data.RefreshEvent.scrollEvent(a._recno);a.refreshControl(m)},_innerValidateData:function(){var a=this;if(a._status==jslet.data.DataSetStatus.BROWSE||a.recordCount()===0){return}var e,m,c,o,b,n,j,h;for(var g=0,d=a._normalFields.length;g<d;g++){e=a._normalFields[g];if(e.disabled()||e.readOnly()||!e.visible()){continue}c=e.name();j=a.getFieldValue(c);if(e.valueStyle()==jslet.data.FieldValueStyle.NORMAL){if(!e.message()){h=a.fieldValidator.checkRequired(e,j);h=h||a.fieldValidator.checkValue(e,j);if(h){e.message(h)}}}else{h=a.fieldValidator.checkRequired(e,j);if(h){e.message(h);return}if(j){for(var f=0,l=j.length;f<l;f++){if(!e.message(f)){h=h||a.fieldValidator.checkValue(e,j);if(h){e.message(h,f)}}}}}}},errorMessage:function(b){var a=jslet.data.RefreshEvent.errorEvent(b||"");this.refreshControl(a)},confirm:function(){var c=this;if(c._silence||c._status==jslet.data.DataSetStatus.BROWSE){return true}c._innerValidateData();var a;if(c.hasFieldErrorMessage()||!c._confirmSubDataset()){console.error(jslet.locale.Dataset.cannotConfirm);if(c._autoShowError){jslet.showInfo(jslet.locale.Dataset.cannotConfirm)}c._aborted=true;a=jslet.data.RefreshEvent.updateRecordEvent();c.refreshControl(a);c.errorMessage(jslet.locale.Dataset.cannotConfirm);return false}c.errorMessage();c._aborted=false;c._fireDatasetEvent(jslet.data.DatasetEvent.BEFORECONFIRM);if(c._aborted){return false}var d;if(c._status==jslet.data.DataSetStatus.INSERT){if(c._logChanged){d=c.getRecord();c._insertedDelta.push(d)}}else{if(c._logChanged){d=c.getRecord();if(c._insertedDelta.indexOf(d)<0){var b=c._updatedDelta.indexOf(d);if(b<0){c._updatedDelta.push(d)}else{c._updatedDelta[b]=d}}}}c._modiObject=null;c.status(jslet.data.DataSetStatus.BROWSE);c.clearFieldErrorMessage();c._fireDatasetEvent(jslet.data.DatasetEvent.AFTERCONFIRM);a=jslet.data.RefreshEvent.updateRecordEvent();c.refreshControl(a);return true},_confirmSubDataset:function(){var e=this,f,c=[];for(var d=0,b=e._normalFields.length;d<b;d++){f=e._normalFields[d];if(f.getType()===jslet.data.DataType.DATASET){c.push(f.subDataset())}}var a;for(var d=0,b=c.length;d<b;d++){a=c[d];if(!a.confirm()){console.error("Error in ["+a.name()+"], can't confirm!");return false}}return true},cancel:function(){var c=this;if(c._status==jslet.data.DataSetStatus.BROWSE){return}c.clearFieldErrorMessage();if(c.recordCount()===0){return}c._aborted=false;c._fireDatasetEvent(jslet.data.DatasetEvent.BEFORECANCEL);if(c._aborted){return}var a,b=c._recno;if(c._status==jslet.data.DataSetStatus.INSERT){var d=c.recno();c._dataList.splice(b,1);c._refreshInnerRecno();if(d>=c.recordCount()){c._recno=c.recordCount()-1}a=jslet.data.RefreshEvent.deleteEvent(d);c.refreshControl(a);c.status(jslet.data.DataSetStatus.BROWSE);c.changedStatus(jslet.data.DataSetStatus.BROWSE);c._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL);return}else{if(c._filteredRecnoArray){b=c._filteredRecnoArray[c._recno]}jslet.data.FieldValueCache.removeCache(c._modiObject);c._dataList[b]=c._modiObject;c._modiObject=null}c.status(jslet.data.DataSetStatus.BROWSE);c.changedStatus(jslet.data.DataSetStatus.BROWSE);c._aborted=false;c._fireDatasetEvent(jslet.data.DatasetEvent.AFTERCANCEL);c._fireDatasetEvent(jslet.data.DatasetEvent.AFTERSCROLL);a=jslet.data.RefreshEvent.updateRecordEvent();c.refreshControl(a)},logChanges:function(a){if(a===undefined){return Z._logChanged}this._logChanged=a},disableControls:function(){this._lockCount++;var e,d,a;for(var c=0,b=this._normalFields.length;c<b;c++){e=this._normalFields[c];d=e.lookup();if(d!==null){a=d.dataset();if(a!==null){a.disableControls()}}}},enableControls:function(d){if(this._lockCount>0){this._lockCount--}if(!d){this.refreshControl()}var f,e,a;for(var c=0,b=this._normalFields.length;c<b;c++){f=this._normalFields[c];e=f.lookup();if(e!==null){a=e.dataset();if(a!==null){a.enableControls(d)}}}},getFieldValue:function(a,c){if(this.recordCount()===0){return null}var b=this.getRecord();if(!b){return null}return this.fieldValueByRec(b,a,c)},setFieldValue:function(c,j,h){var b=this,d=b.getField(c);if(b._status==jslet.data.DataSetStatus.BROWSE){b.editRecord()}var e=b.getRecord();if(d.valueStyle()==jslet.data.FieldValueStyle.NORMAL||h===undefined){e[c]=j;if(d.getType()==jslet.data.DataType.DATASET){var l=d.subDataset();l.dataList(j);return this}}else{var a=e[c];if(!a||!jslet.isArray(a)){a=[];e[c]=a}var g=a.length;if(h<g){a[h]=j}else{for(var f=g;f<h;f++){a.push(null)}a.push(j)}}d.message(null,h);if(b.onFieldChange){b.onFieldChange.call(b,c,j,h)}if(!b._silence&&b._contextRuleEnabled&&j){b.calcContextRule(c)}jslet.data.FieldValueCache.clear(b.getRecord(),c);var k=jslet.data.RefreshEvent.updateRecordEvent(c);b.refreshControl(k);b.updateFormula();return this},removeInnerFormularFields:function(a){if(this._innerFormularFields){this._innerFormularFields.remove(a)}},fieldValueByRec:function(dataRec,fldName,valueIndex){var Z=this;if(Z.recordCount()===0){return null}if(!dataRec){dataRec=Z.getRecord()}var k=fldName.indexOf("."),subfldName,fldValue=null,fldObj=Z.getField(fldName),value,lkds;if(k>0){subfldName=fldName.substr(0,k);fldObj=Z.getField(subfldName);var lkf=fldObj.lookup();if(!lkf){throw new Error(jslet.formatString(jslet.locale.Dataset.lookupNotFound,[subfldName]))}value=dataRec[subfldName];lkds=lkf.dataset();if(lkds.findByField(lkds.keyField(),value)){fldValue=lkds.getFieldValue(fldName.substr(k+1))}else{throw new Error(jslet.formatString(jslet.locale.Dataset.valueNotFound,[lkds.name(),lkds.keyField(),value]))}}else{if(!fldObj){throw new Error(jslet.formatString(jslet.locale.Dataset.fieldNotFound,[fldName]))}var formula=fldObj.formula();if(!formula){value=dataRec[fldName];fldValue=value!==undefined?value:null}else{if(Z._innerFormularFields===null){Z._innerFormularFields=new jslet.SimpleMap()}var evaluator=Z._innerFormularFields.get(fldName);if(evaluator===null){evaluator=new jslet.Expression(this,formula);Z._innerFormularFields.set(fldName,evaluator)}evaluator.context.dataRec=dataRec;fldValue=evaluator.eval();dataRec[fldName]=fldValue}}if(fldObj.valueStyle()==jslet.data.FieldValueStyle.NORMAL||valueIndex===undefined){return fldValue}return jslet.getArrayValue(fldValue,valueIndex)},hasFieldErrorMessage:function(){var b=this.getNormalFields();for(var c=0,a=b.length;c<a;c++){if(b[c].message()){console.error(b[c].message());return true}}return false},clearFieldErrorMessage:function(){var b=this.getNormalFields();for(var c=0,a=b.length;c<a;c++){b[c].message(null)}},getFieldText:function(h,j,b){var a=this;if(a.recordCount()===0){return""}var e=a.getRecord(),n=h.indexOf("."),t,w,v,m;if(n>0){h=h.substr(0,n);t=a.getField(h);if(!t){throw new Error(jslet.formatString(jslet.locale.Dataset.fieldNotFound,[h]))}w=t.lookup();if(!w){throw new Error(jslet.formatString(jslet.locale.Dataset.lookupNotFound,[h]))}m=e[h];if(m===null||m===undefined){return""}v=w.dataset();if(v.findByField(v.keyField(),m)){h=h.substr(n+1);if(h.indexOf(".")>0){return v.getFieldValue(h)}else{return v.getFieldText(h,j,b)}}else{throw new Error(jslet.formatString(jslet.locale.Dataset.valueNotFound,[v.name(),v.keyField(),m]))}}t=a.getField(h);if(!t){throw new Error(jslet.formatString(jslet.locale.Dataset.lookupNotFound,[h]))}if(t.getType()==jslet.data.DataType.DATASET){return"[dataset]"}var o=t.valueStyle(),f=[];if(o==jslet.data.FieldValueStyle.BETWEEN&&b===undefined){var u=a.getFieldText(h,j,0),d=a.getFieldText(h,j,1);if(!j&&!u&&!d){return""}f.push(u);if(j){f.push(jslet.global.valueSeparator)}else{f.push(jslet.locale.Dataset.betweenLabel)}f.push(d);return f.join("")}if(o==jslet.data.FieldValueStyle.MULTIPLE&&b===undefined){var p=a.getFieldValue(h),r=0;if(p&&jslet.isArray(p)){r=p.length-1}for(var q=0;q<=r;q++){f.push(a.getFieldText(h,j,q));if(q<r){f.push(jslet.global.valueSeparator)}}return f.join("")}if(!j){var l=jslet.data.FieldValueCache.get(a.getRecord(),h,b);if(l!==undefined){return l}}m=a.getFieldValue(h,b);if(m===null||m===undefined){var s=t.fixedValue();if(s){return s}return""}var c=t.customValueConverter()||jslet.data.getValueConverter(t);if(!c){throw new Error("Can't find any field value converter!")}var g=c.valueToText.call(a,t,m,j);if(!j){jslet.data.FieldValueCache.put(a.getRecord(),h,g,b)}return g},updateFormula:function(){var d=this._normalFields.length,f,e=this.getRecord();for(var c=0;c<d;c++){f=this._normalFields[c];var b=f.name();if(f.formula()){jslet.data.FieldValueCache.clear(e,b);var a=jslet.data.RefreshEvent.updateRecordEvent(b);this.refreshControl(a)}}},setFieldValueLength:function(c,a){if(c.valueStyle()==jslet.data.FieldValueStyle.NORMAL){return}var b=this.getFieldValue(c.name());if(b&&jslet.isArray(b)){b.length=a}},setFieldText:function(c,g,l){var a=this,d=a.getField(c);if(d===null){throw new Error(jslet.formatString(jslet.locale.Dataset.fieldNotFound,[c]))}var b=d.getType();if(b==jslet.data.DataType.DATASET){throw new Error(jslet.formatString(jslet.locale.Dataset.datasetFieldNotBeSetValue,[c]))}if(d.valueStyle()!==jslet.data.FieldValueStyle.NORMAL&&l===undefined){if(!jslet.isArray(g)){g=g.split(jslet.global.valueSeparator)}var h=g.length;for(var e=0;e<h;e++){a.setFieldText(c,g[e],e)}a.setFieldValueLength(d,h);return}var f=a.fieldValidator.checkInputText(d,g);if(f){d.message(f,l);return}if(!g){a.setFieldValue(c,null,l);return}var j=d.customValueConverter()||jslet.data.getValueConverter(d);if(!j){throw new Error("Can't find any field value converter!")}var m=j.textToValue.call(a,d,g,l);a.setFieldValue(c,m,l)},keyValue:function(){if(!this._keyField||this.recordCount()===0){return null}return this.getFieldValue(this._keyField)},parentValue:function(){if(!this._parentField||this.recordCount()===0){return null}return this.getFieldValue(this._parentField)},find:function(condition){var Z=this;if(Z.recordCount()===0){return false}if(condition===null){Z._findCondition=null;Z._innerFindCondition=null;return false}if(condition!=Z._findCondition){Z._innerFindCondition=new jslet.Expression(this,condition)}if(Z._innerFindCondition.eval()){return true}Z._silence++;var foundRecno=-1,oldRecno=Z._recno;try{Z.first();while(!Z.isEof()){if(Z._innerFindCondition.eval()){foundRecno=Z._recno;break}Z.next()}}finally{Z._silence--;Z._recno=oldRecno}if(foundRecno>=0){Z._gotoRecno(foundRecno);return true}return false},findByField:function(b,e){var a=this;var j,g;if(a._ignoreFilter){if(!a._dataList||a._dataList.length===0){return false}var h=a._dataList.length;for(g=0;g<h;g++){j=a.fieldValueByRec(a._dataList[g],b);if(j==e){a._ignoreFilterRecno=g;return true}}}if(a.recordCount()===0){return false}j=a.getFieldValue(b);if(j==e){return true}var d=-1,f=a.recno();try{var c=a.recordCount();for(g=0;g<c;g++){a.recnoSilence(g);j=a.getFieldValue(b);if(j==e){d=a._recno;break}}}finally{a.recnoSilence(f)}if(d>=0){a._gotoRecno(d);return true}return false},findByKey:function(a){var b=this.keyField();if(!b){return false}return this.findByField(b,a)},lookup:function(a,b,c){if(this.findByField(a,b)){return this.getFieldValue(c)}else{return null}},lookupByKey:function(b,a){if(this.findByKey(b)){return this.getFieldValue(a)}else{return null}},copyDataset:function(d){var f=this;if(f.recordCount()===0){return null}var a=[];if((!d||!f._filtered)){return f._dataList.slice(0)}var c=-1,b=f._recno,e=f._filtered;if(!d){f._filtered=false}f._silence++;try{f.first();while(!f.isEof()){a.push(f.getRecord());f.next()}}finally{f._silence--;f._recno=b;if(!d){f._filtered=e}}return a},keyField:function(a){if(a===undefined){return this._keyField}jslet.Checker.test("Dataset.keyField",a).isString();this._keyField=jQuery.trim(a);return this},codeField:function(a){if(a===undefined){return this._codeField}jslet.Checker.test("Dataset.codeField",a).isString();this._codeField=jQuery.trim(a);return this},nameField:function(a){if(a===undefined){return this._nameField}jslet.Checker.test("Dataset.nameField",a).isString();this._nameField=jQuery.trim(a);return this},parentField:function(a){if(a===undefined){return this._parentField}jslet.Checker.test("Dataset.parentField",a).isString();this._parentField=jQuery.trim(a);return this},selectField:function(a){if(a===undefined){return this._selectField}jslet.Checker.test("Dataset.selectField",a).isString();this._selectField=jQuery.trim(a);return this},_convertFieldValue:function(srcField,srcValues,destFields){var Z=this;if(destFields===null){throw new Error("NOT set destFields in method: ConvertFieldValue")}var isExpr=destFields.indexOf("[")>-1;if(isExpr){if(destFields!=Z._convertDestFields){Z._innerConvertDestFields=new jslet.Expression(this,destFields);Z._convertDestFields=destFields}}if(typeof(srcValues)!="string"){srcValues+=""}var separator=jslet.global.valueSeparator;var values=srcValues.split(separator),valueCnt=values.length-1;Z._ignoreFilter=true;try{if(valueCnt===0){if(!Z.findByField(srcField,values[0])){return null}if(isExpr){return Z._innerConvertDestFields.eval()}else{return Z.getFieldValue(destFields)}}var fldcnt,destValue="";for(var i=0;i<=valueCnt;i++){if(!Z.findByField(srcField,values[i])){return null}if(isExpr){destValue+=Z._innerConvertDestFields.eval()}else{destValue+=Z.getFieldValue(destFields)}if(i!=valueCnt){destValue+=separator}}return destValue}finally{Z._ignoreFilter=false}},contextRules:function(d){if(d===undefined){return this._contextRules}jslet.Checker.test("Dataset.contextRule",d).isArray();if(!d||d.length===0){this._contextRules=null;this._contextRuleEngine=null}else{var c;for(var b=0,a=d.length;b<a;b++){c=d[b];if(!c.className||c.className!=jslet.data.ContextRule.className){d[b]=jslet.data.createContextRule(c)}}this._contextRules=d;this._contextRuleEngine=new jslet.data.ContextRuleEngine(this);this._contextRuleEngine.compile()}return this},disableContextRule:function(){this._contextRuleEnabled=false},enableContextRule:function(){this._contextRuleEnabled=true;this.calcContextRule()},isContextRuleEnabled:function(){return this._contextRuleEnabled},calcContextRule:function(a){if(this.recordCount()===0){return}if(this._contextRuleEngine){if(!a){this._contextRuleEngine.evalStatus()}this._contextRuleEngine.evalRule(a)}},checkSelectable:function(){if(this.recordCount()===0){return false}if(this._onCheckSelectable){return this._onCheckSelectable.call(this)}return true},selected:function(b){var a=this._selectField||jslet.global.selectStateField,c=this.getRecord();if(b===undefined){return c&&c[a]}if(c){if(this.checkSelectable()){c[a]=b}}return this},selectAll:function(c,f,j){var a=this;if(a.recordCount()===0){return}jslet.Checker.test("Dataset.selectAll#onSelectAll",f).isFunction();var d=a.recno();try{for(var e=0,b=a.recordCount();e<b;e++){a.recnoSilence(e);if(f){var g=f(this,c);if(g!==undefined&&!g){continue}}a.selected(c)}}finally{a.recnoSilence(d)}if(!j){var h=jslet.data.RefreshEvent.selectAllEvent(c);a.refreshControl(h)}},selectByKeyValue:function(d,c,j){var a=this,e=a.recno(),b=a.recordCount(),k,g=[];try{for(var f=0;f<b;f++){a.recnoSilence(f);k=a.getFieldValue(a._keyField);if(k==c){a.selected(d);g.push(f);break}}}finally{a.recnoSilence(e)}if(!j){var h=jslet.data.RefreshEvent.selectRecordEvent(g,d);a.refreshControl(h)}},select:function(e,m){var a=this;if(a.recordCount()===0){return}var g=[];if(!m){a.selected(e);g.push(a.recno())}else{var c=m.split(","),h=[],f,b=c.length;for(f=0;f<b;f++){h[f]=a.getFieldValue(c[f])}var p,n=a.recno(),l;try{for(var d=0,j=a.recordCount();d<j;d++){a.recnoSilence(d);l=1;for(f=0;f<b;f++){p=a.getFieldValue(c[f]);if(p!=h[f]){l=0;break}}if(l){a.selected(e);g.push(a.recno())}}}finally{a.recnoSilence(n)}}var o=jslet.data.RefreshEvent.selectRecordEvent(g,e);a.refreshControl(o)},dataProvider:function(a){if(a===undefined){return this._dataProvider}this._dataProvider=a;return this},_checkDataProvider:function(){if(!this._dataProvider){throw new Error("DataProvider required, use: yourDataset.dataProvider(yourDataProvider);")}},insertedRecords:function(){this._checkStatusAndConfirm();return this._insertedDelta},updatedRecords:function(){this._checkStatusAndConfirm();return this._updatedDelta},deletedRecords:function(){return this._deletedDelta},selectedRecords:function(){var d=this;if(d._dataList===null||d._dataList.length===0){return null}var c=d.recno(),a=[];try{for(var b=0,e=d.recordCount();b<e;b++){d.recnoSilence(b);if(d.selected()){a.push(d.getRecord())}}}finally{d.recnoSilence(c)}return a},selectedKeyValues:function(){var b=this.recno(),a=[];try{for(var d=0,c=this.recordCount();d<c;d++){this.recnoSilence(d);if(this.selected()){a.push(this.getFieldValue(this._keyField))}}}finally{this.recnoSilence(b)}if(a.length>0){return a}else{return null}},queryUrl:function(a){if(a===undefined){return this._queryUrl}jslet.Checker.test("Dataset.queryUrl",a).isString();this._queryUrl=jQuery.trim(a);return this},query:function(a){this._queryCriteria=a;return this.requery()},_doQuerySuccess:function(a,g){var f=g;if(!a){f.dataList(null);return}var c=a.main;if(c){f.dataList(c)}var d=a.extraEntities;if(d){var h,e;for(var h in d){e=jslet.data.dataModule.get(h);if(e){e.dataList(d[h])}}}if(a.pageNo){f._pageNo=a.pageNo}if(a.pageCount){f._pageCount=a.pageCount}var b=jslet.data.RefreshEvent.changePageEvent();f.refreshControl(b)},_doApplyError:function(a,f){var e=f,b=a.errorCode,d=a.errorMessage;if(jslet.global.serverErrorHandler){var c=jslet.global.serverErrorHandler(b,d);if(c){return}}e.errorMessage(b+" : "+d);if(e._autoShowError){jslet.showError(b+" : "+d)}},requery:function(){var b=this;b._checkDataProvider();if(!this._queryUrl){throw new Error("QueryUrl required! Use: yourDataset.queryUrl(yourUrl)")}var a={};if(b._pageNo>0){a.pageNo=b._pageNo;a.pageSize=b._pageSize}var c=b._queryCriteria;if(c){if(jslet.isArray(c)){a.criteria=c}else{a.simpleCriteria=c}}if(b.csrfToken){a.csrfToken=b.csrfToken}var a=jslet.data.record2Json(a);return b._dataProvider.sendRequest(b,b._queryUrl,a).done(b._doQuerySuccess).fail(b._doApplyError)},_setChangedState:function(c,e,f){var b=this._addRecordClassFlag(e,c,this._recordClass);for(var d=0,a=b.length;d<a;d++){f.push(b[d])}},_addRecordClassFlag:function(f,n,p){var l=this.getFields(),g,b=null;for(var j=0,m=l.length;j<m;j++){g=l[j];if(g.getType()===jslet.data.DataType.DATASET){if(!b){b={}}b[g.name()]=g.subDataset().recordClass()}}var o=[],h,c,e;for(var j=0,d=f.length;j<d;j++){h=f[j];c={};if(p){c["@type"]=p}h[jslet.global.changeStateField]=n+j;var k;for(var a in h){k=h[a];if(k&&b){e=b[a];if(e){k=this._addRecordClassFlag(k,n,e)}}c[a]=k}o.push(c)}return o},_clearChangeState:function(c){if(!c){return}var d;for(var b=0,a=c.length;b<a;b++){d=c[b];delete d[jslet.global.changeStateField]}},_doSaveSuccess:function(p,h){if(!p){return}p=p.main;var a=h;jslet.data.convertDateFieldValue(a,p);var b,g,m,n,o;for(var j=0,l=p.length;j<l;j++){g=p[j];b=g[jslet.global.changeStateField];if(!b){continue}m=b.charAt(0);if(m=="i"||m=="u"){n=(m=="i"?a.insertedRecords():a.updatedRecords());for(var f=0,e=n.length;f<e;f++){o=n[f];if(o[jslet.global.changeStateField]==b){for(var d in g){o[d]=g[d]}break}}jslet.data.FieldValueCache.removeCache(o)}}a._clearChangeState(a.insertedRecords());a._clearChangeState(a.updatedRecords());a._insertedDelta=[];a._updatedDelta=[];a._deletedDelta=[];a.refreshControl();a.refreshHostDataset()},submitUrl:function(a){if(a===undefined){return this._submitUrl}jslet.Checker.test("Dataset.submitUrl",a).isString();this._submitUrl=jQuery.trim(a);return this},submit:function(c){var d=this;d._checkDataProvider();if(!d._submitUrl){throw new Error("SubmitUrl required! Use: yourDataset.submitUrl(yourUrl)")}if(!d.confirm()){return}var b=[];d._setChangedState("i",d.insertedRecords(),b);d._setChangedState("u",d.updatedRecords(),b);d._setChangedState("d",d.deletedRecords(),b);if(!b||b.length===0){jslet.showInfo(jslet.locale.Dataset.noDataSubmit);return}var a={main:b};if(c){a.extraInfo=c}if(d.csrfToken){a.csrfToken=d.csrfToken}a=jslet.data.record2Json(a);return d._dataProvider.sendRequest(d,d._submitUrl,a).done(d._doSaveSuccess).fail(d._doApplyError)},_doSubmitSelectedSuccess:function(n,d){n=n.main;if(!n||n.length===0){return}var a=d;var l=a._deleteOnSuccess_;var j=a.selectedRecords(),e,c;if(l){for(e=j.length;e>=0;e--){rec=j[e];c=a._dataList.indexOf(rec);a._dataList.splice(c,1)}}else{var b,m,g;jslet.data.convertDateFieldValue(a,n);for(e=j.length-1;e>=0;e--){m=j[e];g=n.length;for(c=0;c<g;c++){b=n[c];if(m[jslet.global.changeStateField]==b[jslet.global.changeStateField]){for(var f in b){m[f]=b[f]}delete m[jslet.global.changeStateField];var h=a._selectField||jslet.global.selectStateField;delete m[h];break}}jslet.data.FieldValueCache.removeCache(m)}}a.refreshControl();a.refreshHostDataset()},submitSelected:function(d,e,f){var g=this;g._checkDataProvider();if(!d){throw new Error("Url required! Use: yourDataset.submitSelected(yourUrl)")}var c=[];var b=g.selectedRecords();g._setChangedState("s",b,c);g._deleteOnSuccess_=e;var a={main:c};if(g.csrfToken){a.csrfToken=g.csrfToken}if(f){a.extraInfo=f}a=jslet.data.record2Json(a);return g._dataProvider.sendRequest(g,d,a).done(g._doSubmitSelectedSuccess).fail(g._doApplyError)},_refreshInnerControl:function(c){var b,a,d;if(c.eventType==jslet.data.RefreshEvent.UPDATEALL||c.eventType==jslet.data.RefreshEvent.CHANGEMETA){a=this._linkedLabels.length;for(b=0;b<a;b++){d=this._linkedLabels[b];if(d.refreshControl){d.refreshControl(c)}}}a=this._linkedControls.length;for(b=0;b<a;b++){d=this._linkedControls[b];if(d.refreshControl){d.refreshControl(c)}}},focusEditControl:function(a){var d,c;for(var b=this._linkedControls.length-1;b>=0;b--){d=this._linkedControls[b];if(d.field&&d.field==a){c=d.el;if(c.focus){try{c.focus()}catch(f){}}}}},refreshControl:function(a){if(this._lockCount){return}if(!a){a=jslet.data.RefreshEvent.updateAllEvent()}this._refreshInnerControl(a)},addLinkedControl:function(a){if(a.isLabel){this._linkedLabels.push(a)}else{this._linkedControls.push(a)}},removeLinkedControl:function(c){var b=c.isLabel?this._linkedLabels:this._linkedControls;var a=b.indexOf(c);if(a>=0){b.splice(a,1)}},refreshHostDataset:function(){if(this._autoRefreshHostDataset){jslet.data.datasetRelationManager.refreshHostDataset(this._name)}},handleLookupDatasetChanged:function(a){this.refreshControl(jslet.data.RefreshEvent.lookupEvent(a))},exportCsv:function(e,n,h){var b=this,c=",",m='"';var d=b.startSilenceMove();try{b.first();var o=[],k,a=b._normalFields.length,g,f,l,j;if(e){k=[];for(j=0;j<a;j++){g=b._normalFields[j];f=g.label()||g.name();f=m+f+m;k.push(f)}o.push(k.join(c))}while(!b.isEof()){if(h&&!b.selected()){b.next();continue}k=[];for(j=0;j<a;j++){g=b._normalFields[j];f=g.name();if(n){l=b.getFieldText(f)}else{l=b.getFieldValue(f)}if(!l){l=""}else{l+=""}l=l.replace(/"/,"");l=m+l+m;k.push(l)}o.push(k.join(c));b.next()}return o.join("\n")}finally{b.endSilenceMove(d)}},dataList:function(b){var a=this;if(b===undefined){return a._dataList}jslet.Checker.test("Dataset.dataList",b).isArray();a._dataList=b;a.clearFieldErrorMessage();jslet.data.convertDateFieldValue(a);a._insertedDelta.length=0;a._updatedDelta.length=0;a._deletedDelta.length=0;a.status(jslet.data.DataSetStatus.BROWSE);a.filter(null);a.indexFields(a.indexFields());a.first();a.refreshControl(jslet.data.RefreshEvent._updateAllEvent);a.refreshHostDataset();return this},textList:function(){var a=this,h=a.recno(),m=[],b=a._normalFields.length,e,c,f,l;try{for(var k=0,d=a.recordCount();k<d;k++){a.recnoSilence(k);l={};for(var g=0;g<b;g++){e=a._normalFields[g];c=e.name();f=a.getFieldText(c);l[c]=f}m.push(l)}return m}finally{this.recnoSilence(h)}},destroy:function(){var a=this;a._masterDataset=null;a._detailDatasets=null;a._fields=null;a._linkedControls=null;a._innerFilter=null;a._innerFindCondition=null;a._sortingFields=null;a._innerFormularFields=null;a._datasetField=null;jslet.data.dataModule.unset(a._name)}};jslet.data.createEnumDataset=function(b,g){jslet.Checker.test("createEnumDataset#enumStrOrObj",g).required();var j=new jslet.data.Dataset(b);j.addField(jslet.data.createStringField("code",10));j.addField(jslet.data.createStringField("name",20));j.keyField("code");j.codeField("code");j.nameField("name");var e=[];if(jslet.isString(g)){var f=jQuery.trim(g);var h=f.split(","),a;for(var d=0,c=h.length;d<c;d++){a=jQuery.trim(h[d]);rec=a.split(":");e[e.length]={code:jQuery.trim(rec[0]),name:jQuery.trim(rec[1])}}}else{for(var k in g){e[e.length]={code:k,name:g[k]}}}j.dataList(e);j.indexFields("code");return j};jslet.data.createDataset=function(e,c,g){var d=new jslet.data.Dataset(e),f;for(var b=0,a=c.length;b<a;b++){f=jslet.data.createField(c[b]);d.addField(f)}if(g){if(g.keyField){d.keyField(g.keyField)}if(g.codeField){d.codeField(g.codeField)}if(g.nameField){d.nameField(g.nameField)}if(g.parentField){d.parentField(g.parentField)}if(g.queryUrl){d.queryUrl(g.queryUrl)}if(g.submitUrl){d.submitUrl(g.submitUrl)}if(g.autoShowError){d.autoShowError(g.autoShowError)}if(g.pageSize){d.pageSize(g.pageSize)}if(g.indexFields){d.indexFields(g.indexFields)}if(g.filter){d.filter(g.filter)}if(g.filtered){d.filtered(g.filtered)}if(g.autoRefreshHostDataset){d.autoRefreshHostDataset(g.autoRefreshHostDataset)}}return d};if(!jslet.data){jslet.data={}}jslet.data.ApplyAction={QUERY:"query",SAVE:"save",SELECTED:"selected"};jslet.data.DataProvider=function(){this.sendRequest=function(d,b,a){var f={};if(d.csrfToken){f.csrfToken=d.csrfToken}var c={async:true,type:"POST",contentType:"application/json",mimeType:"application/json",dataType:"json",headers:f,data:a,context:d};var e=jQuery.Deferred();jQuery.ajax(b,c).done(function(h,k,g){if(h){if(h.csrfToken){this.csrfToken=h.csrfToken}var j=h.errorCode;if(j){e.reject(h,this);return}}e.resolve(h,this)}).fail(function(g,k,j){var h={errorCode:k,errorMessage:j};e.reject(h,this)}).always(function(g,j,h){if(jQuery.isFunction(g.done)){e.always({errorCode:j,errorMessage:h},this)}else{e.always(g,this)}});return e.promise()}};jslet.data.Field=function(c,a){jslet.Checker.test("Field#fieldName",c).isString();c=jQuery.trim(c);jslet.Checker.test("Field#fieldName",c).required();jslet.Checker.test("Field#dataType",a).isString().required();var b=this;b._dataset=null;b._displayOrder=0;b._fieldName=c;b._dataType=a;b._length=0;b._scale=0;b._unique=false;if(a==jslet.data.DataType.NUMBER){b._alignment="right"}else{if(a==jslet.data.DataType.BOOLEAN){b._alignment="center"}else{b._alignment="left"}}b._defaultExpr=null;b._defaultValue=null;b._label=null;b._tip=null;b._message=null;b._displayWidth=0;b._editMask=null;b._displayFormat=null;b._dateFormat=null;b._formula=null;b._readOnly=false;b._visible=true;b._disabled=false;b._customValueConverter=null;b._unitConverted=false;b._lookup=null;b._displayControl=null;b._editControl=null;b._subDataset=null;b._urlExpr=null;b._innerUrlExpr=null;b._urlTarget=null;b._valueStyle=jslet.data.FieldValueStyle.NORMAL;b._valueCountLimit=0;b._required=false;b._nullText=jslet.locale.Dataset.nullText;b._dataRange=null;b._regularExpr=null;b._antiXss=true;b._customValidator=null;b._validChars=null;b._dateChar=null;b._dateRegular=null;b._parent=null;b._children=null;b._trueValue=true;b._falseValue=false;b._mergeSame=false;b._mergeSameBy=null;b._fixedValue=null;b._aggrateType="sum";b._aggrateBy=null};jslet.data.Field.className="jslet.data.Field";jslet.data.Field.prototype={className:jslet.data.Field.className,clone:function(b,c){var g=this;jslet.Checker.test("Field.clone#fldName",b).required().isString();var a=new jslet.data.Field(b,g._dataType);a.dataset(c?c:this.dataset());a.length(g._length);a.scale(g._scale);a.alignment(g._alignment);a.defaultExpr(g._defaultExpr);a.defaultValue(g._defaultValue);a.label(g._label);a.tip(g._tip);a.displayWidth(g._displayWidth);if(g._editMask){a.editMask(g._editMask.clone())}a.displayFormat(g._displayFormat);a.dateFormat(g._dateFormat);a.formula(g._formula);a.unique(g._unique);a.required(g._required);a.readOnly(g._readOnly);a.visible(g._visible);a.disabled(g._disabled);a.unitConverted(g._unitConverted);if(g._lookup){a.lookup(g._lookup.clone())}a.displayControl(g._displayControl);a.editControl(g._editControl);a.urlExpr(g._urlExpr);a.urlTarget(g._urlTarget);a.valueStyle(g._valueStyle);a.valueCountLimit(g._valueCountLimit);a.nullText(g._nullText);a.dataRange(g._dataRange);if(g._regularExpr){a.regularExpr(g._regularExpr)}a.antiXss(g._antiXss);a.customValidator(g._customValidator);a.customValueConverter(g._customValueConverter);a.validChars(g._validChars);if(g._parent){a.parent(g._parent.clone(c))}if(g._children&&g._children.length>0){var f=[];for(var e=0,d=g._children.length;e<d;e++){f.push(g._children[e].clone(c))}a.children(f)}a.mergeSame(g._mergeSame);a.mergeSameBy(g._mergeSameBy);a.fixedValue(g._fixedValue);a.aggrateType(g._aggrateType);a.aggrateBy(g._aggrateBy);return a},_clearFieldCache:function(){var a=this;if(a._dataset&&a._fieldName){jslet.data.FieldValueCache.clearAll(a._dataset,a._fieldName)}},dataset:function(b){var a=this;if(b===undefined){if(a._parent){return a._parent.dataset()}return a._dataset}if(jslet.isString(b)){b=jslet.data.getDataset(b)}else{jslet.Checker.test("Field.dataset",b).isClass(jslet.data.Dataset.className)}a._dataset=b;a._clearFieldCache();a.addLookupRelation()},name:function(){if(arguments.length>0){alert("Can't change field name!")}return this._fieldName},label:function(a){var b=this;if(a===undefined){return b._label||b._fieldName}jslet.Checker.test("Field.label",a).isString();b._label=a;b._fireMetaChangedEvent("label");return this},tip:function(a){var b=this;if(a===undefined){return b._tip}jslet.Checker.test("Field.tip",a).isString();b._tip=a;b._fireMetaChangedEvent("tip");return this},message:function(f,h){var g=this,c=f===undefined&&h===undefined?0:(h===undefined?1:2);var b="",e,a;switch(c){case 0:if(!g._message){return b}if(jslet.isArray(g._message)){a=g._message.length;for(e=0;e<a;e++){if(e>0){b+=", "}b+=jslet.locale.Dataset.value+e+": "+g._message[e]}return b}else{return g._message}break;case 1:if(jQuery.isNumeric(f)){if(!g._message){return b}h=f;if(jslet.isArray(g._message)){if(h<g._message.length){b=g._message[h]}}else{if(h===0){b=g._message}}return b}else{if(g._message==f){return this}g._message=f}break;case 2:if(!g._message||!jslet.isArray(g._message)){g._message=[]}if(g._message.length<=h){g._message.length=h+1}g._message[h]=f;var d=true;a=g._message.length;for(e=0;e<a;e++){if(g._message[e]){d=false;break}}if(d){g._message=null}break}g._fireMetaChangedEvent("message");return this},getType:function(){return this._dataType},parent:function(a){var b=this;if(a===undefined){return b._parent}jslet.Checker.test("Field.parent",a).isClass(this.className);b._parent=a;return this},children:function(c){var d=this;if(c===undefined){return d._children}jslet.Checker.test("Field.children",c).isArray();for(var b=0,a=c.length;b<a;b++){jslet.Checker.test("Field.children#childField",c[b]).isClass(this.className)}d._children=c;return this},displayOrder:function(b){var a=this;if(b===undefined){return a._displayOrder}jslet.Checker.test("Field.displayOrder",b).isNumber();a._displayOrder=parseInt(b);return this},length:function(a){var b=this;if(a===undefined){return b._length}jslet.Checker.test("Field.length",a).isGTEZero();b._length=parseInt(a);return this},getEditLength:function(){var c=this;if(c._lookup){var b=c._lookup.codeField();var a=c._lookup.dataset();if(a&&b){var d=a.getField(b);if(d){return d.getEditLength()}}}return c._length>0?c._length:10},scale:function(b){var a=this;if(b===undefined){return a._scale}jslet.Checker.test("Field.scale",b).isGTEZero();a._scale=parseInt(b);return this},alignment:function(b){var a=this;if(b===undefined){return a._alignment}jslet.Checker.test("Field.alignment",b).isString();a._alignment=jQuery.trim(b);a._fireColumnUpdatedEvent();return this},nullText:function(a){var b=this;if(a===undefined){return b._nullText}jslet.Checker.test("Field.nullText",a).isString();a=jQuery.trim(a);b._nullText=a;b._clearFieldCache();b._fireColumnUpdatedEvent();return this},displayWidth:function(a){var b=this;if(a===undefined){if(b._displayWidth<=0){return b._length>0?b._length:12}else{return b._displayWidth}}jslet.Checker.test("Field.displayWidth",a).isGTEZero();b._displayWidth=parseInt(a);return this},defaultExpr:function(a){var b=this;if(a===undefined){return b._defaultExpr}jslet.Checker.test("Field.defaultExpr",a).isString();b._defaultExpr=a;return this},displayFormat:function(b){var a=this;if(b===undefined){if(a._displayFormat){return a._displayFormat}else{if(a._dataType==jslet.data.DataType.DATE){return jslet.locale.Date.format}else{return a._displayFormat}}}jslet.Checker.test("Field.format",b).isString();a._displayFormat=jQuery.trim(b);a._dateFormat=null;a._dateChar=null;a._dateRegular=null;a._clearFieldCache();a._fireColumnUpdatedEvent();return this},defaultValue:function(a){var b=this;if(a===undefined){return b._defaultValue}jslet.Checker.test("Field.defaultValuen",b.dftValue).isDataType(b._dateType);b._defaultValue=a;return this},unique:function(b){var a=this;if(b===undefined){return a._unique}a._unique=b?true:false;return this},required:function(b){var a=this;if(b===undefined){return a._required}a._required=b?true:false;a._fireMetaChangedEvent("required");return this},editMask:function(a){var b=this;if(a===undefined){return b._editMask}if(a){if(jslet.isString(a)){a={mask:a,keepChar:true}}}else{a=null}b._editMask=a;b._clearFieldCache();b._fireMetaChangedEvent("editMask");return this},dateFormat:function(){var e=this;if(e._dateFormat){return e._dateFormat}if(this.getType()!=jslet.data.DataType.DATE){return null}var d=this.displayFormat().toUpperCase();e._dateFormat="";var f;for(var b=0,a=d.length;b<a;b++){f=d.charAt(b);if("YMD".indexOf(f)<0){continue}if(e._dateFormat.indexOf(f)<0){e._dateFormat+=f}}return e._dateFormat},dateSeparator:function(){var e=this;if(e._dateChar){return e._dateChar}if(this.getType()!=jslet.data.DataType.DATE){return null}var d=this.displayFormat().toUpperCase();for(var b=0,f,a=d.length;b<a;b++){f=d.charAt(b);if("YMD".indexOf(f)<0){e._dateChar=f;return f}}},dateRegular:function(){var e=this;if(e._dateRegular){return e._dateRegular}var d=this.dateFormat(),f=this.dateSeparator(),a=["^"];for(var b=0,g;b<d.length;b++){if(b>0){a.push("\\");a.push(f)}g=d.charAt(b);if(g=="Y"){a.push("(\\d{4}|\\d{2})")}else{if(g=="M"){a.push("(0?[1-9]|1[012])")}else{a.push("(0?[1-9]|[12][0-9]|3[01])")}}}a.push("(\\s+\\d{2}:\\d{2}:\\d{2}(\\.\\d{3}){0,1}){0,1}");a.push("$");e._dateRegular={expr:new RegExp(a.join(""),"gim"),message:jslet.locale.Dataset.invalidDate};return e._dateRegular},formula:function(b){var a=this;if(b===undefined){return a._formula}jslet.Checker.test("Field.formula",b).isString();a._formula=jQuery.trim(b);a._clearFieldCache();if(this.dataset()){this.dataset().removeInnerFormularFields(a._fieldName);a._fireColumnUpdatedEvent()}return this},visible:function(c){var b=this;if(c===undefined){if(b._visible){var a=this.parent();while(a){if(!a.visible()){return false}a=a.parent()}}return b._visible}b._visible=c?true:false;b._fireMetaChangedEvent("visible");return this},disabled:function(a){var b=this;if(a===undefined){return b._disabled}b._disabled=a?true:false;b._fireMetaChangedEvent("disabled");return this},readOnly:function(b){var a=this;if(b===undefined){if(a._formula||a._dataType==jslet.data.DataType.DATASET||a._dataType==jslet.data.DataType.GROUP){return true}return a._readOnly||a._dataset.readOnly()}a._readOnly=b?true:false;a._fireMetaChangedEvent("readOnly");return this},_fireMetaChangedEvent:function(c){var b=this.dataset();if(b){var a=jslet.data.RefreshEvent.changeMetaEvent(c,this._fieldName);b.refreshControl(a)}},_fireColumnUpdatedEvent:function(){var b=this.dataset();if(b){var a=jslet.data.RefreshEvent.updateColumnEvent(this._fieldName);b.refreshControl(a)}},unitConverted:function(c){var b=this;if(c===undefined){return b._dataType==jslet.data.DataType.NUMBER?b._unitConverted:false}b._unitConverted=c?true:false;var a=this.dataset();b._clearFieldCache();if(b._dataType==jslet.data.DataType.NUMBER&&a&&a.unitConvertFactor()!=1){b._fireColumnUpdatedEvent()}return this},valueStyle:function(a){var b=this;if(a===undefined){if(b._dataType==jslet.data.DataType.DATASET||b._dataType==jslet.data.DataType.GROUP){return jslet.data.FieldValueStyle.NORMAL}return b._valueStyle}jslet.Checker.test("Field.valueStyle",a).isNumber().inArray([0,1,2]);b._valueStyle=a;b._clearFieldCache();b._fireColumnUpdatedEvent();return this},valueCountLimit:function(a){var b=this;if(a===undefined){return b._valueCountLimit}jslet.Checker.test("Field.valueCountLimit",a).isNumber();b._valueCountLimit=parseInt(a);return this},displayControl:function(b){var a=this;if(b===undefined){if(a._dataType==jslet.data.DataType.BOOLEAN&&!a._displayControl){return{type:"dbcheckbox"}}return a._displayControl}a._displayControl=(typeof(a._fieldName)=="string")?{type:b}:b;return this},editControl:function(a){var b=this;if(a===undefined){if(b._editControl){return b._editControl}if(b._dataType==jslet.data.DataType.BOOLEAN){return{type:"dbcheckbox"}}if(b._dataType==jslet.data.DataType.DATE){return{type:"dbdatepicker"}}return(b._lookup!==null)?{type:"dbselect"}:{type:"dbtext"}}if(typeof(a)==="string"){if(a.indexOf(":")>0){a=jslet.JSON.parse(a)}else{a={type:a}}}b._editControl=a},onCustomFormatFieldText:null,addLookupRelation:function(){var a=this;if(a._dataset&&a._lookup&&a._lookup.dataset()){jslet.data.datasetRelationManager.addRelation(a._dataset.name(),a._fieldName,a._lookup.dataset().name())}},lookup:function(a){var b=this;if(a===undefined){return b._lookup}jslet.Checker.test("Field.lookup",a).isClass(jslet.data.FieldLookup.className);b._lookup=a;a.hostField(b);if(b._alignment!="left"){b._alignment="left"}this.addLookupRelation();b._clearFieldCache();b._fireColumnUpdatedEvent();return this},subDataset:function(b){var a=this;if(b===undefined){return a._subDataset}jslet.Checker.test("Field.subDataset",b).isClass(jslet.data.Dataset.className);if(a._subDataset){a._subDataset.datasetField(null)}a._subDataset=b;b.datasetField(this);return this},urlExpr:function(a){var b=this;if(a===undefined){return b._urlExpr}jslet.Checker.test("Field.urlExpr",a).isString();b._urlExpr=jQuery.trim(a);b._innerUrlExpr=null;b._clearFieldCache();b._fireColumnUpdatedEvent();return this},urlTarget:function(b){var a=this;if(b===undefined){return !a._urlTarget?jslet.data.Field.URLTARGETBLANK:a._urlTarget}jslet.Checker.test("Field.urlTarget",b).isString();a._urlTarget=jQuery.trim(b);a._clearFieldCache();a._fireColumnUpdatedEvent()},calcUrl:function(){var Z=this;if(!this.dataset()||!Z._urlExpr){return null}if(!Z._innerUrlExpr){Z._innerUrlExpr=new jslet.Expression(this.dataset(),Z._urlExpr)}return Z._innerUrlExpr.eval()},antiXss:function(a){var b=this;if(a===undefined){return b._antiXss}b._antiXss=a?true:false},dataRange:function(a){var b=this;if(a===undefined){return b._dataRange}if(a&&jslet.isString(a)){a=jslet.JSON.parse(a)}jslet.Checker.test("Field.dataRange",a).isObject();if(a){if(a.min){jslet.Checker.test("Field.dataRange.min",a.min).isDataType(b._dateType)}if(a.max){jslet.Checker.test("Field.dataRange.max",a.max).isDataType(b._dateType)}}b._dataRange=a;return this},regularExpr:function(d,b){var c=this;var a=arguments.length;if(a===0){return c._regularExpr}if(a==1){c._regularExpr=d}else{c._regularExpr={expr:d,message:b}}return this},customValueConverter:function(a){var b=this;if(a===undefined){return b._customValueConverter}b._customValueConverter=a;b._clearFieldCache();b._fireColumnUpdatedEvent();return this},customValidator:function(a){var b=this;if(a===undefined){return b._customValidator}jslet.Checker.test("Field.customValidator",a).isFunction();b._customValidator=a;return this},validChars:function(a){var b=this;if(a===undefined){if(b._validChars){return b._validChars}if(b._dataType==jslet.data.DataType.NUMBER){return b._scale?"+-0123456789.":"+-0123456789"}if(b._dataType==jslet.data.DataType.DATE){return"0123456789"+(this.dateSeparator()?this.dateSeparator():"")}}b._validChars=a},trueValue:function(a){var b=this;if(a===undefined){return b._trueValue}jslet.Checker.test("Field.trueValue",a).required();b._trueValue=a;return this},falseValue:function(a){var b=this;if(a===undefined){return b._falseValue}b._falseValue=a;return this},mergeSame:function(a){var b=this;if(a===undefined){return b._mergeSame}b._mergeSame=a?true:false},mergeSameBy:function(b){var a=this;if(b===undefined){return a._mergeSameBy}jslet.Checker.test("Field.mergeSameBy",b).isString();a._mergeSameBy=jQuery.trim(b)},aggrateType:function(b){var c=this;if(b===undefined){return c._aggrateType}var a=jslet.Checker.test("Field.aggrateType",b).isString();if(b){c._aggrateType=jQuery.trim(b);a.inArray(["count","sum","avg"])}return this},aggrateBy:function(a){var b=this;if(a===undefined){return b._aggrateBy}jslet.Checker.test("Field.aggrateBy",a).isString();b._aggrateBy=jQuery.trim(a)},fixedValue:function(a){var b=this;if(a===undefined){return b._fixedValue}jslet.Checker.test("Field.fixedValue",a).isString();b._fixedValue=jQuery.trim(a)},getValue:function(a){return this._dataset.getFieldValue(this._fieldName,a)},setValue:function(a,b){this._dataset.setFieldValue(this._fieldName,a,b)},getTextValue:function(a,b){return this._dataset.getFieldText(this._fieldName,a,b)},setTextValue:function(a,b){this._dataset.setFieldText(this._fieldName,inputText,b)}};jslet.data.Field.URLTARGETBLANK="_blank";jslet.data.createField=function(b,h){jslet.Checker.test("createField#fieldConfig",b).required().isObject();var e=b;if(!e.name){throw new Error("Property: name required!")}var l=e.type;if(l===null){l=jslet.data.DataType.STRING}else{l=l.toUpperCase();if(l!=jslet.data.DataType.STRING&&l!=jslet.data.DataType.NUMBER&&l!=jslet.data.DataType.DATE&&l!=jslet.data.DataType.BOOLEAN&&l!=jslet.data.DataType.DATASET&&l!=jslet.data.DataType.GROUP){l=jslet.data.DataType.STRING}}var c=new jslet.data.Field(e.name,l);if(e.displayOrder!==undefined){c.displayOrder(e.displayOrder)}c.parent(h);if(h){c.dataset(h.dataset())}if(e.label!==undefined){c.label(e.label)}if(e.tip!==undefined){c.tip(e.tip)}if(l==jslet.data.DataType.DATASET){var k=e.subDataset;if(k){if(typeof(k)=="string"){k=jslet.data.dataModule.get(k)}c.subDataset(k)}c.visible(false);return c}if(e.unique!==undefined){c.unique(e.unique)}if(e.required!==undefined){c.required(e.required)}if(e.readOnly!==undefined){c.readOnly(e.readOnly)}if(e.visible!==undefined){c.visible(e.visible)}if(e.disabled!==undefined){c.disabled(e.disabled)}if(l==jslet.data.DataType.GROUP){if(e.children){var j=[],f;for(var d=0,a=e.children.length;d<a;d++){j.push(jslet.data.createField(e.children[d],c))}c.children(j)}c.alignment("center");return c}if(e.length!==undefined){c.length(e.length)}if(e.scale!==undefined){c.scale(e.scale)}if(e.alignment!==undefined){c.alignment(e.alignment)}if(e.defaultExpr!==undefined){c.defaultExpr(e.defaultExpr)}if(e.defaultValue!==undefined){c.defaultValue(e.defaultValue)}if(e.displayWidth!==undefined){c.displayWidth(e.displayWidth)}if(e.editMask!==undefined){c.editMask(e.editMask)}if(e.displayFormat!==undefined){c.displayFormat(e.displayFormat)}if(e.formula!==undefined){c.formula(e.formula)}if(e.nullText!==undefined){c.nullText(e.nullText)}if(e.unitConverted!==undefined){c.unitConverted(e.unitConverted)}var g=e.lookup;if(g!==undefined&&g){if(jslet.isString(g)){g=g.trim();if(g){if(g.trim().startsWith("{")){g=jslet.JSON.parse(g)}else{g={dataset:g}}}}c.lookup(jslet.data.createFieldLookup(g))}if(e.editControl!==undefined&&e.editControl){c.editControl(e.editControl)}if(e.urlExpr!==undefined){c.urlExpr(e.urlExpr)}if(e.urlTarget!==undefined){c.urlTarget(e.urlTarget)}if(e.valueStyle!==undefined){c.valueStyle(e.valueStyle)}if(e.valueCountLimit!==undefined){c.valueCountLimit(e.valueCountLimit)}if(e.dataRange){c.dataRange(e.dataRange)}if(e.customValidator){c.customValidator(e.customValidator)}if(e.trueValue!==undefined){c.trueValue(e.trueValue)}if(e.falseValue!==undefined){c.falseValue(e.falseValue)}if(e.mergeSame!==undefined){c.mergeSame(e.mergeSame)}if(e.mergeSameBy!==undefined){c.mergeSameBy(e.mergeSameBy)}if(e.aggrateType!==undefined){c.aggrateType(e.aggrateType)}if(e.aggrateBy!==undefined){c.aggrateBy(e.aggrateBy)}if(e.fixedValue!==undefined){c.fixedValue(e.fixedValue)}return c};jslet.data.createStringField=function(a,c,b){var d=new jslet.data.Field(a,jslet.data.DataType.STRING,b);d.length(c);return d};jslet.data.createNumberField=function(a,c,d,b){var e=new jslet.data.Field(a,jslet.data.DataType.NUMBER,b);e.length(c);e.scale(d);return e};jslet.data.createBooleanField=function(a,b){return new jslet.data.Field(a,jslet.data.DataType.BOOLEAN,b)};jslet.data.createDateField=function(a,b){var c=new jslet.data.Field(a,jslet.data.DataType.DATE,b);return c};jslet.data.createDatasetField=function(a,b,c){if(!b){throw new Error("expected property:dataset in DatasetField!")}if(typeof(b)=="string"){b=jslet.data.dataModule.get(b)}var d=new jslet.data.Field(a,jslet.data.DataType.DATASET,c);d.subDataset(b);d.visible(false);return d};jslet.data.createGroupField=function(a,b,c){var d=new jslet.data.Field(a,jslet.data.DataType.GROUP,c);d.label(b);return d};jslet.data.Field.prototype.sortByIndex=function(b,a){return b.displayOrder()-a.displayOrder()};jslet.data.FieldLookup=function(){var a=this;a._hostField=null;a._dataset=null;a._keyField=null;a._codeField=null;a._nameField=null;a._codeFormat=null;a._displayFields=null;a._innerdisplayFields=null;a._parentField=null;a._onlyLeafLevel=true;a._returnFieldMap=null};jslet.data.FieldLookup.className="jslet.data.FieldLookup";jslet.data.FieldLookup.prototype={className:jslet.data.FieldLookup.className,clone:function(){var b=this,a=new jslet.data.FieldLookup();a.dataset(b._dataset);a.keyField(b._keyField);a.codeField(b._codeField);a.nameField(b._nameField);a.displayFields(b._displayFields);a.parentField(b._parentField);a.onlyLeafLevel(b._onlyLeafLevel);return a},hostField:function(b){var a=this;if(b===undefined){return a._hostField}jslet.Checker.test("FieldLookup.hostField",b).isClass(jslet.data.Field.className);a._hostField=b;return this},dataset:function(a){var b=this;if(a===undefined){return b._dataset}b._dataset=a;return this},keyField:function(a){var b=this;if(a===undefined){return b._keyField||b._dataset.keyField()}jslet.Checker.test("FieldLookup.keyField",a).isString();b._keyField=jQuery.trim(a);return this},codeField:function(a){var b=this;if(a===undefined){return b._codeField||b._dataset.codeField()}jslet.Checker.test("FieldLookup.codeField",a).isString();b._codeField=jQuery.trim(a);return this},codeFormat:function(b){var a=this;if(b===undefined){return a._codeFormat}jslet.Checker.test("FieldLookup.codeFormat",b).isString();a._codeFormat=jQuery.trim(b);return this},nameField:function(a){var b=this;if(a===undefined){return b._nameField||b._dataset.nameField()}jslet.Checker.test("FieldLookup.nameField",a).isString();b._nameField=jQuery.trim(a);return this},parentField:function(b){var a=this;if(b===undefined){return a._parentField||a._dataset.parentField()}jslet.Checker.test("FieldLookup.parentField",b).isString();a._parentField=jQuery.trim(b);return this},displayFields:function(a){var b=this;if(a===undefined){return b._displayFields?b._displayFields:this.getDefaultDisplayFields()}jslet.Checker.test("FieldLookup.displayFields",a).isString();a=jQuery.trim(a);if(b._displayFields!=a){b._displayFields=a;b._innerdisplayFields=null;if(b._hostField){b._hostField._clearFieldCache()}}return this},returnFieldMap:function(a){if(a===undefined){return this._returnFieldMap}jslet.Checker.test("FieldLookup.returnFieldMap",a).isObject();this._returnFieldMap=a},getDefaultDisplayFields:function(){var a="["+this.nameField()+"]";return a},getCurrentDisplayValue:function(){var Z=this;if(Z._displayFields===null){this.displayFields(this.getDefaultDisplayFields())}if(!Z._innerdisplayFields){Z._innerdisplayFields=new jslet.Expression(Z._dataset,Z.displayFields())}return Z._innerdisplayFields.eval()},onlyLeafLevel:function(a){var b=this;if(a===undefined){return b._onlyLeafLevel}b._onlyLeafLevel=a?true:false;return this},};jslet.data.createFieldLookup=function(c){jslet.Checker.test("createFieldLookup#param",c).required().isObject();var a=c.dataset;if(!a){throw new Error("Property: dataset required!")}var b=new jslet.data.FieldLookup();if(typeof(a)=="string"){a=jslet.data.dataModule.get(a)}b.dataset(a);if(c.keyField!==undefined){b.keyField(c.keyField)}if(c.codeField!==undefined){b.codeField(c.codeField)}if(c.nameField!==undefined){b.nameField(c.nameField)}if(c.codeFormat!==undefined){b.codeFormat(c.codeFormat)}if(c.displayFields!==undefined){b.displayFields(c.displayFields)}if(c.parentField!==undefined){b.parentField(c.parentField)}if(c.onlyLeafLevel!==undefined){b.onlyLeafLevel(c.onlyLeafLevel)}if(c.returnFieldMap!==undefined){b.returnFieldMap(c.returnFieldMap)}return b};jslet.data.ContextRule=function(){var a=this;a._name="";a._description="";a._status=undefined;a._condition=undefined;a._rules=[]};jslet.data.ContextRule.className="jslet.data.ContextRule";jslet.data.ContextRule.prototype={className:jslet.data.ContextRule.className,dataStatus:["insert","update","other"],name:function(a){if(a===undefined){return this._name}jslet.Checker.test("ContextRule.name",a).isString();this._name=jQuery.trim(a);return this},status:function(b){if(b===undefined){return this._status}jslet.Checker.test("ContextRule.status",b).isArray();if(b){var e,c;for(var d=0,a=b.length;d<a;d++){e=jQuery.trim(b[d]);c=jslet.Checker.test("ContextRule.status"+d,e).isString().required();e=e.toLowerCase();c.testValue(e).inArray(this.dataStatus);b[d]=e}}this._status=b;return this},condition:function(a){if(a===undefined){return this._condition}jslet.Checker.test("ContextRule.status",a).isString();this._condition=jQuery.trim(a);return this},rules:function(a){if(a===undefined){return this._rules}jslet.Checker.test("ContextRule.rules",a).isArray();this._rules=a;return this}};jslet.data.ContextRuleItem=function(a){var b=this;jslet.Checker.test("ContextRule.field",a).isString();a=jQuery.trim(a);jslet.Checker.test("ContextRule.field",a).required();b._field=a;b._meta=undefined;b._value=undefined;b._lookup=undefined};jslet.data.ContextRuleItem.className="jslet.data.ContextRuleItem";jslet.data.ContextRuleItem.prototype={className:jslet.data.ContextRuleItem.className,field:function(){return this._field},meta:function(a){if(a===undefined){return this._meta}jslet.Checker.test("ContextRuleItem.meta",a).isClass(jslet.data.ContextRuleMeta.className);this._meta=a;return this},lookup:function(a){if(a===undefined){return this._lookup}jslet.Checker.test("ContextRuleItem.lookup",a).isClass(jslet.data.ContextRuleLookup.className);this._lookup=a;return this},value:function(a){if(a===undefined){return this._value}this._value=a;return this}};jslet.data.ContextRuleMeta=function(){var a=this;a._label=undefined;a._tip=undefined;a._nullText=undefined;a._required=undefined;a._disabled=undefined;a._readOnly=undefined;a._visible=undefined;a._formula=undefined;a._scale=undefined;a._defaultValue=undefined;a._displayFormat=undefined;a._editMask=undefined;a._editControl=undefined;a._range=undefined;a._regularExpr=undefined;a._valueCountLimit=undefined;a._validChars=undefined;a._customValidator=undefined};jslet.data.ContextRuleMeta.className="jslet.data.ContextRuleMeta";jslet.data.ContextRuleMeta.prototype={className:jslet.data.ContextRuleMeta.className,properties:["label","tip","nullText","required","disabled","readOnly","visible","formula","scale","defaultValue","displayFormat","editMask","editControl","range","regularExpr","valueCountLimit","validChars","customValidator"],label:function(a){if(a===undefined){return this._label}jslet.Checker.test("ContextRuleMeta.label",a).isString();this._label=a;return this},tip:function(a){if(a===undefined){return this._tip}jslet.Checker.test("ContextRuleMeta.tip",a).isString();this._tip=a;return this},nullText:function(a){if(a===undefined){return this._nullText}jslet.Checker.test("ContextRuleMeta.nullText",a).isString();this._nullText=jQuery.trim(a);return this},required:function(b){var a=this;if(b===undefined){return a._required}a._required=b?true:false;return this},visible:function(b){var a=this;if(b===undefined){return a._visible}a._visible=b?true:false;return this},disabled:function(a){var b=this;if(a===undefined){return b._disabled}b._disabled=a?true:false;return this},readOnly:function(b){var a=this;if(b===undefined){return a._readOnly}a._readOnly=b?true:false;return this},editMask:function(a){var b=this;if(a===undefined){return b._editMask}b._editMask=a;return this},scale:function(b){var a=this;if(b===undefined){return a._scale}jslet.Checker.test("ContextRuleMeta.scale",b).isNumber();a._scale=parseInt(b);return this},formula:function(b){var a=this;if(b===undefined){return a._formula}jslet.Checker.test("ContextRuleMeta.formula",b).isString();a._formula=jQuery.trim(b);return this},displayFormat:function(b){var a=this;if(b===undefined){return a._displayFormat}jslet.Checker.test("ContextRuleMeta.format",b).isString();a._displayFormat=jQuery.trim(b);return this},editControl:function(a){var b=this;if(a===undefined){return b._editControl}b._editControl=(typeof(a)==="string")?{type:a}:a},defaultValue:function(a){var b=this;if(a===undefined){return b._defaultValue}b._defaultValue=a;return this},range:function(a){var b=this;if(a===undefined){return b._range}if(jslet.isString(a)){b._range=new Function("return "+a)}else{b._range=a}return this},regularExpr:function(a){var b=this;if(a===undefined){return b._regularExpr}if(jslet.isString(a)){b._range=new Function("return "+a)}else{b._regularExpr=a}return this},valueCountLimit:function(a){var b=this;if(a===undefined){return b._valueCountLimit}jslet.Checker.test("ContextRuleMeta.valueCountLimit",a).isNumber();b._valueCountLimit=parseInt(a);return this},customValidator:function(a){var b=this;if(a===undefined){return b._customValidator}jslet.Checker.test("ContextRuleMeta.customValidator",a).isFunction();b._customValidator=a;return this},validChars:function(a){var b=this;if(a===undefined){return b._validChars}jslet.Checker.test("ContextRuleMeta.validChars",a).isString();b._validChars=jQuery.trim(a)}};jslet.data.ContextRuleLookup=function(){var a=this;a._dataset=undefined;a._filter=undefined;a._criteria=undefined;a._displayFields=undefined;a._onlyLeafLevel=undefined};jslet.data.ContextRuleLookup.className="jslet.data.ContextRuleLookup";jslet.data.ContextRuleLookup.prototype={className:jslet.data.ContextRuleLookup.className,properties:["dataset","filter","criteria","displayFields","onlyLeafLevel"],dataset:function(b){var a=this;if(b===undefined){return a._dataset}jslet.Checker.test("ContextRuleLookup.dataset",b).isString();a._dataset=jQuery.trim(b)},filter:function(a){var b=this;if(a===undefined){return b._filter}jslet.Checker.test("ContextRuleLookup.filter",a).isString();b._filter=jQuery.trim(a)},criteria:function(b){var a=this;if(b===undefined){return a._criteria}jslet.Checker.test("ContextRuleLookup.criteria",b).isString();a._criteria=jQuery.trim(b)},displayFields:function(a){var b=this;if(a===undefined){return b._displayFields}jslet.Checker.test("ContextRuleLookup.displayFields",a).isString();b._displayFields=jQuery.trim(a)},onlyLeafLevel:function(b){var a=this;if(b===undefined){return a._onlyLeafLevel}a._onlyLeafLevel=b?true:false}};jslet.data.createContextRule=function(g){if(!g){return null}var f=new jslet.data.ContextRule();if(g.status!==undefined){f.status(g.status)}if(g.condition!==undefined){f.condition(g.condition)}if(g.rules!==undefined){jslet.Checker.test("ContextRule.rules",h).isArray();var h=[];f.rules(h);for(var e=0,a=g.rules.length;e<a;e++){h.push(c(g.rules[e]))}}function c(k){var j=new jslet.data.ContextRuleItem(k.field);if(k.meta!==undefined){j.meta(d(k.meta))}if(k.value!==undefined){j.value(k.value)}if(k.lookup!==undefined){j.lookup(b(k.lookup))}return j}function d(j){var k=new jslet.data.ContextRuleMeta();if(j.label!==undefined){k.label(j.label)}if(j.tip!==undefined){k.tip(j.tip)}if(j.nullText!==undefined){k.nullText(j.nullText)}if(j.required!==undefined){k.required(j.required)}if(j.disabled!==undefined){k.disabled(j.disabled)}if(j.readOnly!==undefined){k.readOnly(j.readOnly)}if(j.visible!==undefined){k.visible(j.visible)}if(j.formula!==undefined){k.formula(j.formula)}if(j.scale!==undefined){k.scale(j.scale)}if(j.required!==undefined){k.required(j.required)}if(j.displayFormat!==undefined){k.displayFormat(j.displayFormat)}if(j.editMask!==undefined){k.editMask(j.editMask)}if(j.editControl!==undefined){k.editControl(j.editControl)}if(j.range!==undefined){k.range(j.range)}if(j.regularExpr!==undefined){k.regularExpr(j.regularExpr)}if(j.valueCountLimit!==undefined){k.valueCountLimit(j.valueCountLimit)}if(j.validChars!==undefined){k.validChars(j.validChars)}if(j.customValidator!==undefined){k.customValidator(j.customValidator)}return k}function b(j){var k=new jslet.data.ContextRuleLookup();if(j.dataset!==undefined){k.dataset(j.dataset)}if(j.filter!==undefined){k.filter(j.filter)}if(j.criteria!==undefined){k.criteria(j.criteria)}if(j.displayFields!==undefined){k.displayFields(j.displayFields)}if(j.onlyLeafLevel!==undefined){k.onlyLeafLevel(j.onlyLeafLevel)}return k}return f};jslet.data.ContextRuleEngine=function(a){this._dataset=a;this._matchedRules=[];this._ruleEnv={}};jslet.data.ContextRuleEngine.prototype={compile:function(){var b=this._dataset.contextRules();for(var c=0,a=b.length;c<a;c++){this._compileOneRule(b[c])}},evalStatus:function(){var c=this._dataset.contextRules(),d="other",b=this._dataset.changedStatus();if(b==jslet.data.DataSetStatus.INSERT){d="insert"}else{if(b==jslet.data.DataSetStatus.UPDATE){d="update"}}this._matchedRules=[];var g,f;for(var e=0,a=c.length;e<a;e++){g=c[e];f=g.status();if(f&&f.indexOf(d)>=0){this._evalRuleItems(g.rules(),d=="insert"||d=="update")}}this._syncMatchedRules()},evalRule:function(c){var b=this._dataset.contextRules();var e;this._matchedRules=[];this._ruleEnv={};for(var d=0,a=b.length;d<a;d++){e=b[d];if(!e.status()){this._evalOneRule(e,c)}}this._syncMatchedRules()},_compileOneRule:function(c){var e=c.condition;this._compileExpr(c,"condition",true);var d=c.rules();for(var b=0,a=d.length;b<a;b++){this._compileRuleItem(d[b])}},_compileRuleItem:function(g){this._compileExpr(g,"value");var c=g.meta();var e,f,d,a;if(c){e=c.properties;a=e.length;for(d=0;d<a;d++){f=e[d];this._compileExpr(c,f)}}var b=g.lookup();if(b){e=b.properties;a=e.length;for(d=0;d<a;d++){f=e[d];this._compileExpr(b,f)}}},_compileExpr:function(a,d,e){var b=a[d].call(a),c=d+"Expr";if(b!==null&&b!==undefined&&jslet.isString(b)){if(b.indexOf("expr:")===0){b=b.substring(5);e=true}if(e){a[c]=new jslet.Expression(this._dataset,b)}}},_evalOneRule:function(ruleObj,changingFldName){var matched=false;var exprObj=ruleObj.conditionExpr;var mainFields=null;if(exprObj){mainFields=exprObj.mainFields();if(changingFldName){if(mainFields&&mainFields.indexOf(changingFldName)<0){return}}matched=ruleObj.conditionExpr.eval()}else{matched=ruleObj.condition()}if(matched){var ruleEnv=null;if(mainFields){var fldName;for(var i=0,len=mainFields.length;i<len;i++){fldName=mainFields[i];if(this._ruleEnv[fldName]===undefined){this._ruleEnv[fldName]=this._dataset.getFieldValue(fldName)}}}this._evalRuleItems(ruleObj.rules(),changingFldName?true:false)}},_evalRuleItems:function(h,c){var a,g,d;for(var e=0,f=h.length;e<f;e++){g=h[e];a=g.field();d=this._findMatchedRule(a);if(!d){d=new jslet.data.ContextRuleItem(a)}var j=g.meta();if(j){d.meta(new jslet.data.ContextRuleMeta());this._copyProperties(j,d.meta())}var b=g.lookup();if(b){d.lookup(new jslet.data.ContextRuleLookup());this._copyProperties(b,d.lookup())}if(c&&g.value()!==undefined){d.value(this._evalExpr(g,"value"))}this._matchedRules.push(d)}},_copyProperties:function(d,g){var c=d.properties,e,f;for(var b=0,a=c.length;b<a;b++){e=c[b];f=this._evalExpr(d,e);if(f!==undefined){g[e].call(g,f)}}},_evalExpr:function(evalObj,propName){var exprObj=evalObj[propName+"Expr"];if(exprObj){return exprObj.eval()}else{return evalObj[propName].call(evalObj)}},_findMatchedRule:function(b){var d;for(var c=0,a=this._matchedRules.length;c<a;c++){d=this._matchedRules[c];if(b==d.field()){return d}}return null},_syncMatchedRules:function(){var d=this._matchedRules,e,b,f;for(var c=0,a=d.length;c<a;c++){e=d[c];b=e.field();f=this._dataset.getField(b);this._syncMatchedRuleMeta(f,e.meta());this._syncMatchedRuleLookup(f,e.lookup());this._syncMatchedRuleValue(f,e.value())}},_syncMatchedRuleMeta:function(g,b){if(!b){return}var d=b.properties,e,f;for(var c=0,a=d.length;c<a;c++){e=d[c];f=b[e].call(b);if(f!==undefined){g[e].call(g,f)}}},_syncMatchedRuleLookup:function(e,d){if(!d){return}var g=e.lookup();if(!g){return}var k=d.dataset();if(k){g.dataset(k)}var a=g.dataset();a.autoRefreshHostDataset(true);var b=d.filter();if(b!=undefined){for(var c in this._ruleEnv){b=b.replace("${"+c+"}",this._ruleEnv[c])}a.filter(b);a.filtered(true)}var j=d.criteria();if(j!==undefined){a.query(j)}var h=d.displayFields();if(h!==undefined){g.displayFields(h)}var f=d.onlyLeafLevel();if(f!==undefined){g.onlyLeafLevel(f)}},_syncMatchedRuleValue:function(b,a){if(a!==undefined){b.setValue(a)}}};